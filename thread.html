<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;padding:20px;background:#fff0f8;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1{margin-top:0;}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer;}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc;}
body.dark input,body.dark textarea{background:#222;color:#eaeaea;border:1px solid #555;}
.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 2px 6px rgba(255,150,210,.25);}
body.dark .comment{background:#1b1b1b;border-color:#555;}
.flex{display:flex;align-items:center;gap:10px;}
.icon{width:40px;height:40px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover;}
body.dark .icon{border-color:#ff8cd1;}
.tools{display:flex;justify-content:flex-end;gap:6px;margin-top:4px;}
.meta{font-size:.8rem;color:#aa7;}
.reactBtn{margin-left:6px;}
.banLabel{color:red;font-weight:bold;margin-left:4px;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitleH1">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<a href="index.html">æ²ç¤ºæ¿ã«æˆ»ã‚‹</a>

<div id="profileBox">
  <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
  <input id="nameInput" placeholder="åå‰">
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
  <button id="saveProfile">ä¿å­˜</button>
</div>

<hr>
<h3>ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã</h3>
<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<button id="postComment">æŠ•ç¨¿</button>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
const commentsDiv=document.getElementById("comments");

const renderComments=async()=>{
  const snap=await get(ref(db,`posts/${threadId}`));
  const data=snap.val()||{};
  commentsDiv.innerHTML="";
  const sorted=Object.entries(data).sort((a,b)=>a[1].time-b[1].time);
  sorted.forEach(([cid,c])=>{
    const div=document.createElement("div");
    div.className="comment";
    const isBanned=false; // BANåˆ¤å®šã¯å¾Œã§å®Ÿè£…å¯
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <b>${c.name||defaultName}${isBanned?" <span class='banLabel'>BAN</span>":""}</b> <span class="meta">#${cid.slice(-4)} | ${new Date(c.time).toLocaleString()}</span>
        </div>
      </div>
      <p>${c.text||""}</p>
      <div class="tools">
        <button class="reactBtn" data-type="carrot">ğŸ¥• ${c.carrot||0}</button>
        <button class="reactBtn" data-type="star">âœ¨ ${c.star||0}</button>
        <button class="reportBtn">é€šå ±</button>
      </div>
    `;
    commentsDiv.appendChild(div);

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    div.querySelectorAll(".reactBtn").forEach(btn=>{
      btn.onclick=async()=>{
        const type=btn.dataset.type;
        const snap2=await get(ref(db,`posts/${threadId}/${cid}/${type}`));
        const count=snap2.val()||0;
        await set(ref(db,`posts/${threadId}/${cid}/${type}`),count+1);
        renderComments();
      };
    });

    /* é€šå ±ãƒœã‚¿ãƒ³ */
    div.querySelector(".reportBtn").onclick=async()=>{
      if(!confirm("é€šå ±ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const key=(await push(ref(db,`reports`),{
        threadId, postId:cid,
        name:c.name, icon:c.icon, text:c.text, time:Date.now(),
        userId:c.userId
      })).key;
      alert("é€šå ±ã—ã¾ã—ãŸï¼");
    };
  });
};
onValue(ref(db,`posts/${threadId}`),()=>renderComments());

/* æŠ•ç¨¿ */
document.getElementById("postComment").onclick=async()=>{
  const text=document.getElementById("commentText").value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");
  await push(ref(db,`posts/${threadId}`),{
    text,
    name:nameInput.value||defaultName,
    icon:iconInput.value||defaultIcon,
    userId,
    time:Date.now(),
    carrot:0,
    star:0
  });
  document.getElementById("commentText").value="";
};
</script>
</body>
</html>
