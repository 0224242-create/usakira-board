<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif; background:#fff0f8; padding:20px; color:#222; transition:.25s;}
body.dark{background:#121212; color:#eee;}

h1,h2{margin-top:0;}
.thread-box{border:2px solid #ffc6e6; background:#fff7fc; border-radius:14px; padding:14px; margin:14px 0; box-shadow:0 2px 6px rgba(255,150,210,.25);}
.thread-box:hover{transform:translateY(-3px); box-shadow:0 6px 12px rgba(255,150,210,.32);}
.thread-box.locked{background:#ddd; border-color:#bbb;}
body.dark .thread-box{background:#1b1b1b; border-color:#555; box-shadow:0 2px 6px rgba(0,0,0,.3);}
body.dark .thread-box.locked{background:#333; border-color:#666;}

.flex{display:flex; align-items:center; gap:10px;}
.flex-right{display:flex; justify-content:flex-end; gap:6px;}
.icon{width:48px; height:48px; border-radius:50%; border:2px solid #ffb8e6; object-fit:cover;}
body.dark .icon{border-color:#ff8cd1;}

button{padding:6px 10px; border-radius:6px; cursor:pointer; margin:2px;}
button:hover{opacity:.85;}
body.dark button{background:#333; color:#eee; border:1px solid #666;}

input,textarea{padding:6px; margin:4px 0; width:100%; box-sizing:border-box; border-radius:6px; border:1px solid #ccc;}
body.dark input,body.dark textarea{background:#222; color:#eee; border:1px solid #555;}

.comment{border-top:1px solid #ccc; padding:6px; margin-top:6px; border-radius:6px;}
.comment .meta{font-size:.8rem; color:#aa7;}
.comment.deleted{color:#888; font-style:italic;}
.reaction-active{font-weight:bold; color:#e91e63;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed; right:12px; top:12px;">ğŸŒ™</button>
<h1>ğŸ° ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<div id="threadContainer"></div>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</h2>
<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã"></textarea>
<button id="postComment">æŠ•ç¨¿ã™ã‚‹</button>

<hr>
<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const userIcon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ã‚¹ãƒ¬ãƒƒãƒ‰å–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");
const threadContainer=document.getElementById("threadContainer");

const threadRef=ref(db,`threads/${threadId}`);
const commentsRef=ref(db,`posts/${threadId}`);
const bansRef=ref(db,"ban");

/* BANç¢ºèª */
let isBanned=false;
onValue(ref(db,`ban/${userId}`),snap=>{ isBanned=!!snap.val(); renderCommentForm(); });

/* ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º */
onValue(threadRef,snap=>{
  const t=snap.val();
  if(!t) { threadContainer.innerHTML="<p>ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“</p>"; return; }
  const div=document.createElement("div");
  div.className="thread-box"+(t.pass?" locked":"");
  div.innerHTML=`
    <h3>${t.title||"ï¼ˆç„¡é¡Œï¼‰"}</h3>
    <p>${t.body||""}</p>
    <div style="font-size:.9rem;color:#888;">by ${t.ownerName||"åã‚‚ãªãå…"} ${t.pass?"ğŸ”’":""}</div>
  `;
  threadContainer.innerHTML="";
  threadContainer.appendChild(div);
});

/* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ åˆ¶å¾¡ */
const commentText=document.getElementById("commentText");
const postBtn=document.getElementById("postComment");
function renderCommentForm(){
  commentText.disabled=isBanned;
  postBtn.disabled=isBanned;
  postBtn.textContent=isBanned?"BANã•ã‚Œã¦ã‚‹ãƒšã‚³":"æŠ•ç¨¿ã™ã‚‹";
}

/* æŠ•ç¨¿ã‚³ãƒ¡ãƒ³ãƒˆ */
postBtn.onclick=async()=>{
  const txt=commentText.value.trim();
  if(!txt) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");
  const key=(await push(commentsRef,{
    uid:userId,
    name:userName,
    icon:userIcon,
    text:txt,
    time:Date.now(),
    reactions:{}
  })).key;
  commentText.value="";
};

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
const commentsDiv=document.getElementById("comments");
onValue(commentsRef,snap=>{
  commentsDiv.innerHTML="";
  const comments=snap.val()||{};
  Object.entries(comments).sort((a,b)=>a[1].time-b[1].time).forEach(([id,c],index)=>{
    const div=document.createElement("div");
    div.className="comment";
    if(c.deleted) div.classList.add("deleted");
    const time=new Date(c.time).toLocaleString();
    const reactions=c.reactions||{};
    const carrot=c.reactions.carrot||0;
    const star=c.reactions.star||0;

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
        <div style="flex:1;">
          <b>#${index+1} ${c.name}${c.banned?"{BAN}":""}</b>
          <span class="meta">${time} | ID:${c.uid}</span>
          <p>${c.deleted?"ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³":c.text}</p>
          <div>ğŸ¥• ${carrot} | âœ¨ï¸ ${star}</div>
        </div>
      </div>
    `;

    const btnDiv=document.createElement("div");
    btnDiv.className="flex-right";

    if(!c.deleted){
      const carrotBtn=document.createElement("button");
      carrotBtn.textContent="ğŸ¥•";
      carrotBtn.onclick=()=>toggleReaction(id,"carrot");
      const starBtn=document.createElement("button");
      starBtn.textContent="âœ¨ï¸";
      starBtn.onclick=()=>toggleReaction(id,"star");
      const reportBtn=document.createElement("button");
      reportBtn.textContent="é€šå ±";
      reportBtn.onclick=()=>reportComment(id,c);
      btnDiv.append(carrotBtn,starBtn,reportBtn);

      if(c.uid===userId || isAdmin){
        const delBtn=document.createElement("button");
        delBtn.textContent="å‰Šé™¤";
        delBtn.onclick=()=>deleteComment(id);
        btnDiv.append(delBtn);
      }

      if(isAdmin){
        const banBtn=document.createElement("button");
        banBtn.textContent="BAN";
        banBtn.onclick=()=>banUser(c.uid,c.name,c.icon);
        btnDiv.append(banBtn);
      }
    }

    div.appendChild(btnDiv);
    commentsDiv.appendChild(div);
  });
});

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ */
async function toggleReaction(commentId,type){
  const rRef=ref(db,`posts/${threadId}/${commentId}/reactions/${type}/${userId}`);
  const snap=await get(rRef);
  if(snap.exists()) await remove(rRef);
  else await set(rRef,true);
}

/* å‰Šé™¤ */
async function deleteComment(commentId){
  if(!confirm("å‰Šé™¤ã™ã‚‹ãƒšã‚³ï¼Ÿ")) return;
  await set(ref(db,`posts/${threadId}/${commentId}/deleted`),true);
}

/* é€šå ± */
async function reportComment(commentId,comment){
  const key=await push(ref(db,"reports"),{
    threadId, postId:commentId, userId:comment.uid, name:comment.name, icon:comment.icon, text:comment.text, time:Date.now()
  }).key;
  alert("é€šå ±ã—ãŸãƒšã‚³");
}

/* BAN */
async function banUser(uid,name,icon){
  if(!confirm("BANã™ã‚‹ãƒšã‚³ï¼Ÿ")) return;
  await set(ref(db,`ban/${uid}`),{name,icon,time:Date.now()});
}
</script>
</body>
</html>
