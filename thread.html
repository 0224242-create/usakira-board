<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; padding:20px; background:#fff0f8; color:#222; transition:0.25s; }
    .dark { background:#121212; color:#eaeaea; }

    .post { border:1px solid #ffd4ea; padding:10px; margin:8px 0; border-radius:8px; background:#fff; position:relative; }
    body.dark .post { background:#1e1e1e; border-color:#555; }

    .icon { width:36px; height:36px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    .meta { font-size:13px; color:#666; margin-top:6px; }
    body.dark .meta { color:#bbbbbb; }

    button { padding:6px 10px; margin:4px; cursor:pointer; border-radius:4px; }
    body.dark button { background:#333; color:#eaeaea; border:1px solid #666; }

    #replyText { width:100%; height:80px; padding:8px; box-sizing:border-box; margin-bottom:6px;
      background:#fff; color:#222; border:1px solid #ccc; }
    body.dark #replyText { background:#222; color:#eaeaea; border:1px solid #555; }

    a { color:#d22; text-decoration:underline; }

    /* â† æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’å¸¸ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿ */
    #backBtn {
      color:#222;
      background:#ffe0f0;
      border:1px solid #ffb7d6;
    }
    body.dark #backBtn {
      background:#333;
      color:#eaeaea;
      border:1px solid #555;
    }
  </style>
</head>
<body>
  <button id="darkToggle" style="position:fixed; right:12px; top:12px;">ğŸŒ™</button>
  <h1 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>

  <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå®Œå…¨å‹•ä½œï¼‰ -->
  <button id="backBtn" style="
    padding:6px 12px;
    margin-bottom:12px;
    border-radius:6px;
    cursor:pointer;
  ">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<script>
  document.getElementById("backBtn").addEventListener("click", () => {
    location.href = "index.html";
  });
</script>

  <div id="threadInfo" class="meta"></div>
  <hr>

  <div id="replyBox">
    <textarea id="replyText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
    <button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>
  </div>
  <hr>

  <div id="posts"></div>
  <div id="postsPaging"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
    authDomain: "keijiban-7c651.firebaseapp.com",
    databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
    projectId: "keijiban-7c651",
    storageBucket: "keijiban-7c651.firebasestorage.app",
    messagingSenderId: "342192640264",
    appId: "1:342192640264:web:a004a725b470741aaf1cbd",
    measurementId: "G-7E1BZ3BGBR"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
  const darkToggle = document.getElementById("darkToggle");
  const darkSaved = localStorage.getItem("usakira_dark") === "true";
  if (darkSaved) document.body.classList.add("dark");
  darkToggle.textContent = darkSaved ? "â˜€ï¸" : "ğŸŒ™";
  darkToggle.addEventListener("click", () => {
    const now = !(localStorage.getItem("usakira_dark") === "true");
    localStorage.setItem("usakira_dark", now);
    document.body.classList.toggle("dark");
    darkToggle.textContent = now ? "â˜€ï¸" : "ğŸŒ™";
  });

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ */
  const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
  if (!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId", userId);

  const defaultName = "åã‚‚ãªãå…";
  const defaultIcon = "usagi.png.jpeg";
  const profileName = localStorage.getItem("usakira_name") || defaultName;
  const profileIcon = localStorage.getItem("usakira_icon") || defaultIcon;

  /* ã‚¹ãƒ¬IDå–å¾— */
  const params = new URLSearchParams(location.search);
  const threadId = params.get("id") || localStorage.getItem("lastThread") || "";
  if (!threadId) { alert("ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); location.href="index.html"; throw new Error("No thread id"); }

  /* ã‚¹ãƒ¬æƒ…å ±åæ˜  */
  const threadRef = ref(db, `threads/${threadId}`);
  onValue(threadRef, snap => {
    const t = snap.val();
    if (!t) { document.getElementById("threadTitle").innerText="ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return; }
    document.getElementById("threadTitle").innerText = t.title || "ï¼ˆç„¡é¡Œï¼‰";
    document.getElementById("threadInfo").innerHTML = `
      <img class="icon" src="${t.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
      by ${t.ownerName||defaultName}
      ${t.pass?'<span class="meta"> ãƒ» éµä»˜ãã‚¹ãƒ¬</span>':''}
      <div class="meta">${t.body||""}</div>
    `;
    if (t.pass) {
      const p = prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã§ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if (p !== t.pass) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„"); location.href="index.html"; }
    }
  });

  /* BANä¸€è¦§ */
  let bans = {};
  onValue(ref(db,"bans"), s=>bans=s.val()||{});

  /* æŠ•ç¨¿å–å¾— */
  const PER=20;
  let postsArr=[];
  onValue(ref(db,`posts/${threadId}`), snap=>{
    const data = snap.val()||{};
    postsArr=Object.entries(data).sort((a,b)=>(a[1].time||0)-(b[1].time||0));
    renderPosts(1);
  });

  function linkify(text){ return (text||"").replace(/(https?:\/\/[^\s]+)/g,m=>`<a href="${m}" target="_blank">${m}</a>`); }

  /* æŠ•ç¨¿æç”» */
  function renderPosts(page=1){
    const start=(page-1)*PER;
    const pick=postsArr.slice(start,start+PER);
    const container=document.getElementById("posts");
    container.innerHTML="";

    pick.forEach(([id,p],idx)=>{
      if(bans[p.uid]) return;
      const postNumber=start+idx+1;
      const html=document.createElement("div");
      html.className="post";

      html.innerHTML=`
        <div>
          <span class="replyNum">#${postNumber}</span>
          <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
          <strong>${p.name||defaultName}</strong>
          <span class="meta">(ID: ${(p.uid || "xxxx").slice(0,4)})</span>
          <div class="meta">${new Date(p.time||0).toLocaleString()}</div>
        </div>
        <div style="margin-top:8px">${linkify(p.text)}</div>
      `;

      const controls=document.createElement("div");
      controls.style.marginTop="8px";

      /* è¿”ä¿¡ */
      const replyBtn=document.createElement("button");
      replyBtn.textContent="è¿”ä¿¡";
      replyBtn.onclick=()=>{ 
        document.getElementById("replyText").value=`#${postNumber} `; 
        document.getElementById("replyText").focus(); 
      };
      controls.appendChild(replyBtn);

      /* å‰Šé™¤ */
      const delBtn=document.createElement("button");
      delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=async()=>{
        const me = localStorage.getItem("usakira_userId");
        const tSnap = await get(ref(db,`threads/${threadId}`));
        const t = tSnap.val()||{};
        if(me===p.uid || me===t.ownerId){
          if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
          await remove(ref(db,`posts/${threadId}/${id}`));
          return;
        }
        const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
        if(pw==="master"){
          await remove(ref(db,`posts/${threadId}/${id}`));
          alert("å‰Šé™¤ã—ã¾ã—ãŸ");
          return;
        }
        alert("å‰Šé™¤æ¨©é™ãªã—");
      };
      controls.appendChild(delBtn);

      /* BAN */
      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>{
        const tSnap = await get(ref(db,`threads/${threadId}`));
        const t = tSnap.val()||{};
        const me = localStorage.getItem("usakira_userId");

        if(me===t.ownerId){
          if(!confirm(`${p.name} ã‚’BANã—ã¾ã™ã‹ï¼Ÿ`)) return;
          await set(ref(db,`bans/${p.uid}`),true);
          alert("BANã—ã¾ã—ãŸ");
          return;
        }
        const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
        if(pw==="master"){
          await set(ref(db,`bans/${p.uid}`),true);
          alert("BANã—ã¾ã—ãŸ");
          return;
        }
        alert("BANæ¨©é™ãªã—");
      };
      controls.appendChild(banBtn);

      /* é€šå ± */
      const reportBtn=document.createElement("button");
      reportBtn.textContent="é€šå ±";
      reportBtn.onclick=async()=>{
        const me = localStorage.getItem("usakira_userId");
        const reportRef = ref(db,`reports/${threadId}/${id}/${me}`);
        await set(reportRef,{ time:Date.now() });
        alert("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ");
      };
      controls.appendChild(reportBtn);

      html.appendChild(controls);
      container.appendChild(html);
    });

    /* ãƒšãƒ¼ã‚¸ãƒ³ã‚° */
    const pages=Math.max(1,Math.ceil(postsArr.length/PER));
    const pg=document.getElementById("postsPaging");
    pg.innerHTML="";
    for(let i=1;i<=pages;i++){
      const b=document.createElement("button");
      b.textContent=i;
      b.onclick=()=>renderPosts(i);
      pg.appendChild(b);
    }
  }

  /* æŠ•ç¨¿å‡¦ç† */
  document.getElementById("postBtn").addEventListener("click", async()=>{
    let text=document.getElementById("replyText").value.trim();
    if(!text) return alert("æœ¬æ–‡ã‚’æ›¸ã„ã¦ã­ãƒšã‚³");
    if(!text.endsWith("ãƒšã‚³")) text+=" ãƒšã‚³";

    const me = localStorage.getItem("usakira_userId");
    const isBanned = await get(ref(db,`bans/${me}`)).then(s=>s.val());
    if(isBanned) return alert("æ›¸ãè¾¼ã¿ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ãƒšã‚³");

    await push(ref(db,`posts/${threadId}`),{
      name:profileName,
      icon:profileIcon,
      text,
      uid:me,
      time:Date.now()
    });

    document.getElementById("replyText").value="";
  });
  </script>
</body>
</html>
