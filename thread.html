<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:15px;
}
.post{
  background:#fff;
  border:2px solid #ffc6e6;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}
.admin-post{
  background:#fff3e0;
}
.name{font-weight:bold;}
.owner{color:red;}
.admin{color:#d48a00;}
.ban{color:#888;font-size:.8rem;margin-left:4px;}
.text{margin:6px 0;}
.reaction{
  font-size:.9rem;
  cursor:pointer;
  user-select:none;
}
.reaction.red{color:red;}
.reaction.rainbow{
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,purple);
  -webkit-background-clip:text;
  color:transparent;
}
.tools{
  font-size:.8rem;
  color:#888;
}
.uid{
  font-size:.7rem;
  color:#999;
}
</style>
</head>

<body>

<h2>ğŸ° ã‚¹ãƒ¬ãƒƒãƒ‰</h2>

<div>
  <textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ" style="width:100%;"></textarea>
  <button id="send">æŠ•ç¨¿</button>
</div>

<hr>
<div id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, push, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const params=new URLSearchParams(location.search);
const threadId=params.get("id");

let uid=localStorage.getItem("uid");
if(!uid){
  uid=crypto.randomUUID();
  localStorage.setItem("uid",uid);
}

const name=localStorage.getItem("name")||"åã‚‚ãªãå…";
const isAdmin = localStorage.getItem("usakira_admin")==="true";

const list=document.getElementById("list");

/* æŠ•ç¨¿ */
document.getElementById("send").onclick=async()=>{
  const text=document.getElementById("text").value.trim();
  if(!text) return;

  // BANãƒã‚§ãƒƒã‚¯
  const banSnap = await get(ref(db,"bans/"+uid));
  if(banSnap.exists()){
    alert("ã‚ãªãŸã¯BANä¸­ã§ã™");
    return;
  }

  await push(ref(db,"posts/"+threadId),{
    uid,
    name,
    text,
    time:Date.now(),
    reactions:0,
    admin:isAdmin
  });

  text.value="";
};

/* è¡¨ç¤º */
onValue(ref(db,"posts/"+threadId),snap=>{
  list.innerHTML="";
  const posts=snap.val()||{};
  const arr=Object.entries(posts).sort((a,b)=>a[1].time-b[1].time);

  let ownerId=null;
  if(arr.length>0) ownerId=arr[0][1].uid;

  arr.forEach(([pid,p])=>{
    const div=document.createElement("div");
    div.className="post";
    if(p.admin) div.classList.add("admin-post");

    const nameSpan=document.createElement("span");
    nameSpan.className="name";
    nameSpan.textContent=p.name;

    if(p.uid===ownerId) nameSpan.classList.add("owner");
    if(p.admin){
      nameSpan.classList.add("admin");
      nameSpan.textContent+=" ğŸ‘‘";
    }

    const banSpan=document.createElement("span");
    get(ref(db,"bans/"+p.uid)).then(b=>{
      if(b.exists()) banSpan.textContent="ï¼ˆBANä¸­ï¼‰";
    });

    const uidDiv=document.createElement("div");
    uidDiv.className="uid";
    uidDiv.textContent="ID: "+p.uid;

    const textDiv=document.createElement("div");
    textDiv.className="text";
    textDiv.textContent=p.text;

    div.append(nameSpan,banSpan,uidDiv,textDiv);

    const reaction=document.createElement("div");
    reaction.className="reaction";
    reaction.textContent="ğŸ¥• "+(p.reactions||0);

    if(p.reactions>=10) reaction.classList.add("rainbow");
    else if(p.reactions>=5) reaction.classList.add("red");

    reaction.onclick=()=>{
      set(ref(db,"posts/"+threadId+"/"+pid+"/reactions"),(p.reactions||0)+1);
    };

    const tools=document.createElement("div");
    tools.className="tools";

    const report=document.createElement("span");
    report.textContent="é€šå ±";
    report.onclick=()=>push(ref(db,"reports"),{
      threadId,
      postId:pid,
      uid:p.uid,
      name:p.name,
      text:p.text,
      time:Date.now()
    });

    tools.append(" ",report);

    if(isAdmin){
      const del=document.createElement("span");
      del.textContent=" å‰Šé™¤";
      del.onclick=()=>remove(ref(db,"posts/"+threadId+"/"+pid));
      tools.append(del);
    }

    div.append(reaction,tools);
    list.appendChild(div);
  });
});
</script>
</body>
</html>
