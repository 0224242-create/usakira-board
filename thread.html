<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  color:#222;
  padding:20px;
  transition:.3s;
}
body.dark{background:#121212;color:#eee}

button{
  padding:6px 10px;
  margin:2px;
  border-radius:6px;
  cursor:pointer;
}
body.dark button{
  background:#333;
  color:#eee;
  border:1px solid #666;
}

.post{
  background:#fff;
  border:1px solid #ffd4ea;
  border-radius:8px;
  padding:10px;
  margin:10px 0;
}
body.dark .post{
  background:#1e1e1e;
  border-color:#555;
}

.post.owner{
  border-left:6px solid #ff69b4;
}
.post.admin{
  background:linear-gradient(135deg,rgba(255,215,100,.25),rgba(120,90,20,.15));
  border-color:#cfa300;
}

.icon{
  width:36px;
  height:36px;
  border-radius:50%;
  vertical-align:middle;
}

.adminName{color:#f5b400;font-weight:bold}
body.dark .adminName{color:#ffd36a}

.meta{font-size:12px;color:#666}
body.dark .meta{color:#bbb}

.postImg{
  max-width:220px;
  border-radius:6px;
  margin-top:6px;
  display:block;
}
a{color:#d22}

#darkBtn,#adminBtn{
  position:fixed;
  right:12px;
}
#adminBtn{top:12px}
#darkBtn{top:52px}
</style>
</head>

<body>

<button id="adminBtn">ğŸ‘‘ ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
<button id="darkBtn">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

<h1 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>
<button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
<hr>

<textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea><br>
<input type="file" id="file" accept="image/*"><br>
<button id="send">æŠ•ç¨¿</button>

<hr>
<div id="posts"></div>
<div id="paging"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, get, set } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";

const firebaseConfig={
 apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
 authDomain:"keijiban-7c651.firebaseapp.com",
 databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
 projectId:"keijiban-7c651",
 storageBucket:"keijiban-7c651.firebasestorage.app"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const st=getStorage(app);

/* ===== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ===== */
const darkBtn=document.getElementById("darkBtn");
function applyDark(){
 if(localStorage.dark==="true"){
  document.body.classList.add("dark");
  darkBtn.textContent="â˜€ï¸ ãƒ©ã‚¤ãƒˆ";
 }else{
  document.body.classList.remove("dark");
  darkBtn.textContent="ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
 }
}
darkBtn.onclick=()=>{
 localStorage.dark=localStorage.dark==="true"?"false":"true";
 applyDark();
};
applyDark();

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ ===== */
let uid=localStorage.uid||("u_"+Math.random().toString(36).slice(2));
localStorage.uid=uid;
const isAdmin=()=>localStorage.admin==="true";

/* ===== ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ ===== */
document.getElementById("adminBtn").onclick=()=>{
 const pw=prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
 if(pw==="master"){
  localStorage.admin="true";
  alert("ç®¡ç†è€…ã«ãªã‚Šã¾ã—ãŸ");
 }else alert("å¤±æ•—");
};

/* ===== ã‚¹ãƒ¬ ===== */
const tid=new URLSearchParams(location.search).get("id");
const tRef=ref(db,"threads/"+tid);
let ownerId="";
onValue(tRef,s=>{
 const t=s.val();
 if(!t)return;
 ownerId=t.ownerId;
 document.getElementById("threadTitle").innerText=t.title;
});

/* ===== æŠ•ç¨¿è¡¨ç¤º ===== */
const PER=20;
let list=[];
onValue(ref(db,"posts/"+tid),s=>{
 const d=s.val()||{};
 list=Object.entries(d).sort((a,b)=>a[1].time-b[1].time);
 draw(1);
});

function linkify(t){
 return (t||"").replace(/https?:\/\/\S+/g,m=>`<a href="${m}" target="_blank">${m}</a>`);
}

function draw(p){
 const start=(p-1)*PER;
 const box=document.getElementById("posts");
 box.innerHTML="";
 list.slice(start,start+PER).forEach(([id,v],i)=>{
  const n=start+i+1;
  const div=document.createElement("div");
  div.className="post";
  if(v.uid===ownerId)div.classList.add("owner");
  if(isAdmin())div.classList.add("admin");

  div.innerHTML=`
   #${n}
   ${isAdmin()?"ğŸ‘‘":""}${v.uid===ownerId?"â˜…":""}
   <strong class="${isAdmin()?"adminName":""}">${v.name||"åã‚‚ãªãå…"}</strong>
   <div>${linkify(v.text)}</div>
   ${v.img?`<img src="${v.img}" class="postImg">`:""}
   <div class="meta">${new Date(v.time).toLocaleString()}</div>
  `;

  const c=document.createElement("div");

  const rep=document.createElement("button");
  rep.textContent="è¿”ä¿¡";
  rep.onclick=()=>text.value="#"+n+" ";
  c.appendChild(rep);

  if(v.uid===uid||isAdmin()){
   const del=document.createElement("button");
   del.textContent="å‰Šé™¤";
   del.onclick=()=>remove(ref(db,"posts/"+tid+"/"+id));
   c.appendChild(del);
  }

  if(isAdmin()){
   const ban=document.createElement("button");
   ban.textContent="è¿½æ”¾";
   ban.onclick=()=>set(ref(db,"bans/"+v.uid),true);
   c.appendChild(ban);
  }

  div.appendChild(c);
  box.appendChild(div);
 });

 const pg=document.getElementById("paging");
 pg.innerHTML="";
 for(let i=1;i<=Math.ceil(list.length/PER);i++){
  const b=document.createElement("button");
  b.textContent=i;
  b.onclick=()=>draw(i);
  pg.appendChild(b);
 }
}

/* ===== æŠ•ç¨¿ ===== */
send.onclick=async()=>{
 let t=text.value.trim();
 const f=file.files[0];
 if(!t&&!f)return alert("å…¥åŠ›ã—ã¦ã­");

 let img=null;
 if(f){
  const r=sRef(st,"img/"+Date.now()+f.name);
  await uploadBytes(r,f);
  img=await getDownloadURL(r);
 }

 await push(ref(db,"posts/"+tid),{
  uid,
  name:localStorage.name||"åã‚‚ãªãå…",
  text:t.endsWith("ãƒšã‚³")?t:t+" ãƒšã‚³",
  img,
  time:Date.now()
 });

 text.value="";
 file.value="";
};
</script>
</body>
</html>
