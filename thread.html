<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; transition: background 0.3s, color 0.3s; }
    .post { padding: 10px; border-bottom: 1px solid #ccc; margin: 8px 0; }
    .reactions { margin-top: 6px; display: flex; gap: 10px; }
    .reaction-btn { cursor: pointer; font-size: 20px; }
    .icon { width: 40px; height: 40px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
    .dark { background: #111; color: #f5f5f5; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase.js"></script>
</head>
<body>

<button onclick="toggleMode()">ðŸŒ™ ãƒ€ãƒ¼ã‚¯ / ãƒ©ã‚¤ãƒˆ</button>
<h1 id="title">ðŸ“Œ ã‚¹ãƒ¬ãƒƒãƒ‰</h1>

<textarea id="postText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea><br>
<button onclick="sendPost()">æŠ•ç¨¿</button>

<h2>ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
<div id="postList"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.firebasestorage.app",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd",
  measurementId: "G-7E1BZ3BGBR"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ã‚¹ãƒ¬IDå–å¾—ï¼ˆURLå„ªå…ˆâ†’localStorageï¼‰ */
const params = new URLSearchParams(location.search);
let currentThread = params.get("id") || localStorage.getItem("lastThread") || "";
if (!currentThread) {
  alert("ã‚¹ãƒ¬IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
  throw new Error("NO THREAD ID");
}

/* ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º */
db.ref("threads/" + currentThread + "/title").on("value", snap => {
  const t = snap.val();
  title.innerText = "ðŸ“Œ " + t;
  document.title = t;
});

/* æŠ•ç¨¿ */
function sendPost() {
  let text = postText.value.trim();
  if (!text) return;
  if (!text.endsWith("ãƒšã‚³")) text += " ãƒšã‚³";

  const userId = localStorage.getItem("userId");
  db.ref("profiles/" + userId).get().then(snap => {
    const p = snap.val() || { name: "åç„¡ã—", icon: "usagi.png.jpeg", comment: "" };
    db.ref("posts/" + currentThread).push({
      text,
      timestamp: Date.now(),
      name: p.name,
      icon: p.icon,
      uid: userId,
      carrot: 0,
      star: 0
    });
  });
  postText.value = "";
}

/* URLãƒªãƒ³ã‚¯åŒ– */
function linkify(t) {
  return t.replace(/(https?:\/\/[^\s]+)/g, m => `<a href="${m}" target="_blank">${m}</a>`);
}

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
db.ref("posts/" + currentThread).on("value", snap => {
  const data = snap.val();
  postList.innerHTML = "";
  if (!data) return;

  const arr = Object.entries(data).sort((a, b) => a[1].timestamp - b[1].timestamp);
  arr.forEach(([id, p]) => {
    const d = document.createElement("div");
    d.className = "post";
    d.innerHTML = `
      <img class="icon" src="${p.icon}">
      <b>${p.name}</b><br>${linkify(p.text)}
    `;

    const r = document.createElement("div");
    r.className = "reactions";
    r.innerHTML = `
      <span class="reaction-btn" data-type="carrot">ðŸ¥• ${p.carrot ?? 0}</span>
      <span class="reaction-btn" data-type="star">âœ¨ ${p.star ?? 0}</span>
    `;
    r.querySelectorAll(".reaction-btn").forEach(btn => {
      btn.onclick = () => {
        const type = btn.dataset.type;
        db.ref("posts/" + currentThread + "/" + id).update({ [type]: (p[type] ?? 0) + 1 });
      };
    });

    d.appendChild(r);
    postList.appendChild(d);
  });
});

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
function toggleMode() {
  document.body.classList.toggle("dark");
}
</script>
</body>
</html>
