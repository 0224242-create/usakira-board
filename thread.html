<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;padding:20px;background:#fff0f8;color:#222}
body.dark{background:#121212;color:#eee}

.post{border:1px solid #ffd4ea;background:#fff;padding:10px;margin:8px 0;border-radius:8px}
body.dark .post{background:#1e1e1e;border-color:#555}

.post.ownerPost{border-left:6px solid #ff69b4}
.post.adminPost{background:linear-gradient(135deg,rgba(255,215,120,.25),rgba(255,240,200,.15));border-color:#f5b400}

.icon{width:36px;height:36px;border-radius:50%;vertical-align:middle;margin-right:6px}
.meta{font-size:13px;color:#666}
body.dark .meta{color:#bbb}

.ownerMark{color:#ff69b4;font-weight:bold}
.adminMark{color:#f5b400;font-weight:bold}
.adminName{color:#f5b400;font-weight:bold}

button{padding:4px 8px;margin:4px;border-radius:4px;cursor:pointer}
body.dark button{background:#333;color:#eee;border:1px solid #666}

.postImg{max-width:200px;margin-top:6px;border-radius:6px}
</style>
</head>

<body>

<button id="adminBtn" style="position:fixed;right:12px;top:12px">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>

<h1 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>
<button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
<div id="threadInfo" class="meta"></div>
<hr>

<textarea id="replyText" style="width:100%;height:80px"></textarea><br>
<input type="file" id="replyFile" accept="image/*"><br>
<button id="postBtn">æŠ•ç¨¿</button>
<hr>

<div id="posts"></div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {getDatabase,ref,onValue,push,set,remove,get} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
import {getStorage,ref as sRef,uploadBytes,getDownloadURL} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";

const ADMIN_PASS="master";

const app=initializeApp({
 apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
 authDomain:"keijiban-7c651.firebaseapp.com",
 databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
 projectId:"keijiban-7c651",
 storageBucket:"keijiban-7c651.firebasestorage.app",
 appId:"1:342192640264:web:a004a725b470741aaf1cbd"
});

const db=getDatabase(app);
const storage=getStorage(app);

/* ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ */
const adminBtn=document.getElementById("adminBtn");
function updateAdminBtn(){
  adminBtn.textContent=
    localStorage.getItem("isAdmin")==="true"?"ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ":"ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³";
}
updateAdminBtn();

adminBtn.onclick=()=>{
  if(localStorage.getItem("isAdmin")==="true"){
    localStorage.removeItem("isAdmin");
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    updateAdminBtn();
    return;
  }
  const pw=prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw===ADMIN_PASS){
    localStorage.setItem("isAdmin","true");
    alert("ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
    updateAdminBtn();
  }else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„");
};

/* æ—¥æ›¿ã‚ã‚ŠID */
function dailyId(uid,time){
  const k=uid+new Date(time).toDateString();
  let h=0;for(let c of k){h=(h<<5)-h+c.charCodeAt(0);h|=0;}
  return Math.abs(h).toString(36).slice(0,8);
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const uid=localStorage.getItem("uid")||("u_"+Math.random().toString(36).slice(2));
localStorage.setItem("uid",uid);
const name=localStorage.getItem("name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("icon")||"usagi.png.jpeg";

/* ã‚¹ãƒ¬ */
const tid=new URLSearchParams(location.search).get("id");
let ownerId="";
onValue(ref(db,`threads/${tid}`),s=>{
 const t=s.val(); if(!t)return;
 ownerId=t.ownerId||"";
 threadTitle.textContent=t.title||"ï¼ˆç„¡é¡Œï¼‰";
 threadInfo.textContent="by "+(t.ownerName||"åã‚‚ãªãå…");
});

/* æŠ•ç¨¿è¡¨ç¤º */
onValue(ref(db,`posts/${tid}`),s=>{
 const data=Object.entries(s.val()||{});
 posts.innerHTML="";

 data.forEach(([id,p],i)=>{
  const div=document.createElement("div");
  div.className="post";
  if(p.uid===ownerId)div.classList.add("ownerPost");
  if(localStorage.getItem("isAdmin")==="true")div.classList.add("adminPost");

  let mark="";
  if(p.uid===ownerId)mark+=' <span class="ownerMark">â˜…</span>';
  if(localStorage.getItem("isAdmin")==="true")mark+=' <span class="adminMark">ğŸ‘‘</span>';

  div.innerHTML=`
   <div>
    #${i+1}
    <img class="icon" src="${p.icon||icon}">
    <strong class="${localStorage.getItem("isAdmin")==="true"?"adminName":""}">
      ${p.name||"åã‚‚ãªãå…"}
    </strong>
    <span class="meta">(ID:${dailyId(p.uid,p.time)}${mark})</span>
   </div>
   <div>${p.text||""}</div>
   ${p.img?`<img src="${p.img}" class="postImg">`:""}
  `;

  const btns=document.createElement("div");

  /* è¿”ä¿¡ */
  const replyBtn=document.createElement("button");
  replyBtn.textContent="è¿”ä¿¡";
  replyBtn.onclick=()=>{replyText.value=`#${i+1} `;replyText.focus()};
  btns.appendChild(replyBtn);

  /* å‰Šé™¤ */
  if(p.uid===uid || p.uid===ownerId || localStorage.getItem("isAdmin")==="true"){
    const del=document.createElement("button");
    del.textContent="å‰Šé™¤";
    del.onclick=async()=>{
      if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))
        await remove(ref(db,`posts/${tid}/${id}`));
    };
    btns.appendChild(del);
  }

  /* BANï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ */
  if(localStorage.getItem("isAdmin")==="true"){
    const ban=document.createElement("button");
    ban.textContent="è¿½æ”¾";
    ban.onclick=async()=>{
      if(confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½æ”¾ã—ã¾ã™ã‹ï¼Ÿ")){
        await set(ref(db,`bans/${p.uid}`),{time:Date.now()});
        alert("è¿½æ”¾ã—ã¾ã—ãŸ");
      }
    };
    btns.appendChild(ban);
  }

  /* é€šå ± */
  const report=document.createElement("button");
  report.textContent="é€šå ±";
  report.onclick=async()=>{
    await set(ref(db,`reports/${tid}/${id}/${uid}`),{time:Date.now()});
    alert("é€šå ±ã—ã¾ã—ãŸ");
  };
  btns.appendChild(report);

  div.appendChild(btns);
  posts.appendChild(div);
 });
});

/* æŠ•ç¨¿ */
postBtn.onclick=async()=>{
 let text=replyText.value.trim();
 if(!text&&!replyFile.files[0])return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
 if(text&&!text.endsWith("ãƒšã‚³"))text+=" ãƒšã‚³";

 const banned=await get(ref(db,`bans/${uid}`)).then(s=>s.val());
 if(banned)return alert("è¿½æ”¾ã•ã‚Œã¦ã„ã¾ã™");

 let img=null;
 if(replyFile.files[0]){
  const r=sRef(storage,`img/${tid}/${Date.now()}_${replyFile.files[0].name}`);
  await uploadBytes(r,replyFile.files[0]);
  img=await getDownloadURL(r);
 }

 await push(ref(db,`posts/${tid}`),{uid,name,icon,text,img,time:Date.now()});
 replyText.value="";replyFile.value="";
};
</script>
</body>
</html>
