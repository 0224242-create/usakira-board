<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
}
body.dark{background:#121212;color:#eee}

.comment{
  background:#fff7fc;
  border:2px solid #ffc6e6;
  border-radius:14px;
  padding:12px;
  margin:12px 0;
}
body.dark .comment{
  background:#1b1b1b;
  border-color:#555;
}

.admin{color:#ff4fa8;font-size:.85rem}
.reactions span{
  cursor:pointer;
  margin-right:6px;
}
.flash{
  animation:flash 0.6s infinite alternate;
}
@keyframes flash{
  from{box-shadow:0 0 5px #ff9}
  to{box-shadow:0 0 18px #ff0}
}

.tools{
  display:flex;
  justify-content:flex-end;
  gap:6px;
  margin-top:6px;
}
</style>
</head>

<body>

<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<h2 id="title"></h2>

<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³"></textarea>
<button id="sendBtn">é€ä¿¡</button>

<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* å…±é€š */
const url=new URL(location.href);
const threadId=url.searchParams.get("id");
const userId=localStorage.getItem("usakira_userId");
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon");
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* BANç¢ºèª */
let banned=false;
get(ref(db,"ban/"+userId)).then(s=>{
  if(s.exists()){
    banned=true;
    commentText.disabled=true;
    sendBtn.disabled=true;
    commentText.placeholder="ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™";
  }
});

/* ã‚¿ã‚¤ãƒˆãƒ« */
onValue(ref(db,"threads/"+threadId),s=>{
  if(s.exists()) title.textContent=s.val().title;
});

/* æŠ•ç¨¿ */
sendBtn.onclick=async()=>{
  if(banned) return;
  const txt=commentText.value.trim();
  if(!txt) return;
  await push(ref(db,"posts/"+threadId),{
    text:txt+" ãƒšã‚³",
    time:Date.now(),
    userId,
    name,
    icon,
    admin:isAdmin,
    reactions:{}
  });
  commentText.value="";
};

/* è¡¨ç¤º */
onValue(ref(db,"posts/"+threadId),snap=>{
  comments.innerHTML="";
  let num=1;
  snap.forEach(s=>{
    const p=s.val();
    const id=s.key;

    const div=document.createElement("div");
    div.className="comment";

    let rCount=Object.values(p.reactions||{}).reduce((a,b)=>a+b,0);
    if(rCount>=5) div.classList.add("flash");

    if(p.deleted){
      div.innerHTML="ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³";
      comments.appendChild(div);
      return;
    }

    div.innerHTML=`
      <div style="display:flex;gap:8px">
        <img src="${p.icon||''}" width="40" height="40"
         style="border-radius:50%" onerror="this.style.display='none'">
        <div>
          <b onclick="reply(${num})" style="cursor:pointer">
            #${num} ${p.name}
            ${p.admin?"<span class='admin'>ğŸ‘‘</span>":""}
            ${p.banned?"<span style='color:red'>{BAN}</span>":""}
          </b><br>
          <span style="font-size:.8rem">${new Date(p.time).toLocaleString()} / ${p.userId}</span>
        </div>
      </div>

      <p>${p.text}</p>

      <div class="reactions">
        <span onclick="react('${id}','sparkle')">âœ¨ ${p.reactions?.sparkle||0}</span>
        <span onclick="react('${id}','carrot')">ğŸ¥• ${p.reactions?.carrot||0}</span>
      </div>

      <div class="tools">
        ${isAdmin?`
          <button onclick="banUser('${p.userId}','${id}')">BAN</button>
          <button onclick="kick('${id}')">è¿½æ”¾</button>
        `:""}
        <button onclick="report('${id}')">é€šå ±</button>
        <button onclick="del('${id}','${p.userId}')">å‰Šé™¤</button>
      </div>
    `;

    comments.appendChild(div);
    num++;
  });
});

/* é–¢æ•°ç¾¤ */
window.reply=n=>{
  commentText.value+=`>>${n} `;
  commentText.focus();
};

window.react=(id,t)=>{
  update(ref(db,"posts/"+threadId+"/"+id+"/reactions/"+t),{
    ".sv":"increment"
  });
};

window.del=async(id,uid)=>{
  if(uid===userId||isAdmin){
    await update(ref(db,"posts/"+threadId+"/"+id),{deleted:true});
  }
};

window.kick=id=>{
  set(ref(db,"posts/"+threadId+"/"+id),null);
};

window.banUser=async(uid,id)=>{
  await set(ref(db,"ban/"+uid),true);
  await update(ref(db,"posts/"+threadId+"/"+id),{banned:true});
};

window.report=id=>{
  push(ref(db,"reports"),{threadId,id,time:Date.now()});
};
</script>

</body>
</html>
