<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰ | ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", sans-serif; background:#fffafc; color:#222; padding:16px; transition:0.25s; }
    .dark { background:#111; color:#eaeaea; }
    .post { background:#fff; border:1px solid #ffdce6; border-radius:8px; padding:10px; margin:8px 0; }
    .icon { width:40px; height:40px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    .small { font-size:13px; color:#666; }
    button { padding:8px 10px; margin:6px 4px 0 0; cursor:pointer; }
    .danger { color:#c33; cursor:pointer; font-size:13px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <button id="darkToggle" style="position:fixed; right:12px; top:12px; font-size:20px;">ğŸŒ™</button>
  <h1 id="threadTitle">ğŸ“Œ ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
  <div id="threadInfo" class="small"></div>
  <hr>

  <div>
    <textarea id="replyText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã"></textarea><br>
    <button id="sendBtn">æŠ•ç¨¿</button>
    <button id="backBtn">ä¸€è¦§ã«æˆ»ã‚‹</button>
  </div>

  <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
  <div id="posts"></div>
  <div id="pages"></div>

<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.firebasestorage.app",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd",
  measurementId: "G-7E1BZ3BGBR"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */
const ADMIN_PW = "master";

/* ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ID */
let userId = localStorage.getItem("usakira_userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId", userId);
}
const profileName = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
const profileIcon = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
if (localStorage.getItem("usakira_dark") === "true") document.body.classList.add("dark"), darkToggle.textContent = "â˜€ï¸";
darkToggle.addEventListener("click", ()=>{
  const on = document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark", on ? "true":"false");
  darkToggle.textContent = on ? "â˜€ï¸":"ğŸŒ™";
});

/* ã‚¹ãƒ¬IDã®å–å¾—ï¼ˆURLå„ªå…ˆã€ãªã‘ã‚Œã° lastThreadï¼‰ */
const params = new URLSearchParams(location.search);
const threadId = params.get("id") || localStorage.getItem("lastThread");
if (!threadId) {
  alert("ã‚¹ãƒ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒˆãƒƒãƒ—ã«æˆ»ã‚Šã¾ã™ã€‚");
  location.href = "index.html";
}

/* ã‚¹ãƒ¬æƒ…å ±å–å¾—ã€‚éµã‚¹ãƒ¬ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª */
db.ref("threads/" + threadId).once("value").then(snap=>{
  const t = snap.val();
  if (!t) { alert("ã‚¹ãƒ¬ãŒå­˜åœ¨ã—ã¾ã›ã‚“"); location.href = "index.html"; return; }
  // éµã‚¹ãƒ¬å‡¦ç†ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼ç®¡ç†è€…ã¯é€šã™ï¼‰
  if (t.pass) {
    const ownerIsMe = (t.owner === userId);
    if (!ownerIsMe) {
      const pw = prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã§ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if (pw !== t.pass) { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); location.href = "index.html"; return; }
    }
  }
  // è¡¨ç¤º
  document.getElementById("threadTitle").textContent = "ğŸ“Œ " + (t.title || "ç„¡é¡Œ");
  document.getElementById("threadInfo").innerHTML = `
    <img src="${t.ownerIcon || 'usagi.png.jpeg'}" class="icon" onerror="this.src='usagi.png.jpeg'">
    ä½œæˆè€…: ${escapeHtml(t.ownerName || "åã‚‚ãªãå…")} <span class="small">(${new Date(t.createdAt||0).toLocaleString()})</span>
  `;
});

/* æŠ•ç¨¿ï¼ˆè‡ªå‹•ãƒšã‚³ï¼‰ */
document.getElementById("sendBtn").addEventListener("click", ()=>{
  let text = document.getElementById("replyText").value.trim();
  if (!text) return alert("æ›¸ãè¾¼ã‚“ã§ã­ãƒšã‚³");
  if (!text.endsWith("ãƒšã‚³")) text += " ãƒšã‚³";
  const p = {
    uid: userId,
    name: localStorage.getItem("usakira_name") || "åã‚‚ãªãå…",
    icon: localStorage.getItem("usakira_icon") || "usagi.png.jpeg",
    text,
    time: Date.now(),
    carrot: 0,
    star: 0
  };
  db.ref("posts/" + threadId).push(p);
  document.getElementById("replyText").value = "";
});

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
document.getElementById("backBtn").addEventListener("click", ()=> {
  window.close(); // åˆ¥ã‚¿ãƒ–ã§é–‹ã„ã¦ã‚‹æƒ³å®šã€‚ãƒ€ãƒ¡ãªã‚‰ index ã«æˆ»ã‚‹ã€‚
  try { opener.focus(); } catch(e){}
});

/* BANãƒªã‚¹ãƒˆã‚’å¸¸ã«å–å¾— */
let bans = {};
db.ref("bans").on("value", s => bans = s.val() || {});

/* ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã§æŠ•ç¨¿å–å¾—ã¨è¡¨ç¤º */
const PER = 20;
let postsArr = [];
let currentPage = 1;

db.ref("posts/" + threadId).on("value", snap => {
  const data = snap.val() || {};
  postsArr = Object.entries(data).map(([k,v]) => ({ id:k, ...v }));
  postsArr.sort((a,b)=> a.time - b.time); // æ™‚ç³»åˆ—ï¼ˆå¤ã„é †ï¼‰
  renderPosts();
});

function renderPosts(){
  const container = document.getElementById("posts");
  container.innerHTML = "";
  // filter banned
  const visible = postsArr.filter(p => !(bans && bans[p.uid]));
  const start = (currentPage-1)*PER;
  const pageItems = visible.slice(start, start+PER);
  pageItems.forEach(p => {
    const div = document.createElement("div");
    div.className = "post";
    const safeText = linkifyEscape(p.text);
    div.innerHTML = `
      <div style="display:flex;align-items:center;">
        <img src="${p.icon || 'usagi.png.jpeg'}" class="icon" onerror="this.src='usagi.png.jpeg'">
        <div style="flex:1;">
          <div><b>${escapeHtml(p.name)}</b> <span class="small">${new Date(p.time).toLocaleString()}</span></div>
          <div style="margin-top:6px;">${safeText}</div>
        </div>
        <div style="text-align:right">
          <div style="margin-bottom:8px;">
            <button onclick="react('${p.id}','carrot')">ğŸ¥• ${p.carrot||0}</button>
            <button onclick="react('${p.id}','star')">âœ¨ ${p.star||0}</button>
          </div>
          <div>
            <span class="danger" onclick="tryDeletePost('${p.id}','${p.uid}')">å‰Šé™¤</span><br>
            <button onclick="banUser('${p.uid}')">BAN</button>
          </div>
        </div>
      </div>
    `;
    container.appendChild(div);
  });

  // ãƒšãƒ¼ã‚¸è¡¨ç¤º
  const pagesDiv = document.getElementById("pages");
  pagesDiv.innerHTML = "";
  const total = Math.max(1, Math.ceil(visible.length / PER));
  for (let i=1;i<=total;i++){
    const b = document.createElement("button");
    b.textContent = i;
    if (i===currentPage) b.disabled = true;
    b.addEventListener("click", ()=>{ currentPage = i; renderPosts(); });
    pagesDiv.appendChild(b);
  }
}

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
function react(postId, type){
  const ref = db.ref("posts/" + threadId + "/" + postId + "/" + type);
  ref.transaction(v => (v || 0) + 1);
}

/* å‰Šé™¤ï¼šæŠ•ç¨¿è€… or ã‚¹ãƒ¬ä¸» or ç®¡ç†è€… */
async function tryDeletePost(postId, postUid) {
  // get thread owner
  const threadSnap = await db.ref("threads/" + threadId).once("value");
  const thread = threadSnap.val() || {};
  const isOwnerOfPost = (postUid === userId);
  const isThreadOwner = (thread.owner === userId);
  if (isOwnerOfPost || isThreadOwner) {
    if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    await db.ref("posts/" + threadId + "/" + postId).remove();
    return;
  }
  // ç®¡ç†è€…æ¨©é™
  const pw = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§å‰Šé™¤");
  if (pw === ADMIN_PW) {
    await db.ref("posts/" + threadId + "/" + postId).remove();
    alert("ç®¡ç†è€…ã«ã‚ˆã‚‹å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ");
    return;
  }
  alert("å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
}

/* BANï¼ˆç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰*/
async function banUser(uid) {
  const pw = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§BAN");
  if (pw !== ADMIN_PW) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†");
  await db.ref("bans/" + uid).set(true);
  alert("BANã—ã¾ã—ãŸ");
}

/* ãƒ˜ãƒ«ãƒ‘ãƒ¼: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— + URLãƒªãƒ³ã‚¯åŒ– */
function escapeHtml(s){
  if (!s) return "";
  return s.toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function linkifyEscape(text){
  // escape then convert URLs
  const escaped = escapeHtml(text);
  return escaped.replace(/(https?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank">${url}</a>`);
}

</script>
</body>
</html>
