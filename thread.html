/* 投稿取得 */
const PER = 20;
let postsArr = [];

// 投稿一覧読み込み
onValue(ref(db, `posts/${threadId}`), snap => {
  const data = snap.val() || {};
  postsArr = Object.entries(data).sort((a,b)=>(a[1].time||0)-(b[1].time||0));
  renderPosts(1);
});

// URLリンク化
function linkify(text){
  return (text||"").replace(/(https?:\/\/[^\s]+)/g,m=>`<a href="${m}" target="_blank">${m}</a>`);
}

function renderPosts(page=1){
  const start = (page-1)*PER;
  const pick = postsArr.slice(start,start+PER);
  const container = document.getElementById("posts");
  container.innerHTML = "";

  pick.forEach(([id,p],idx)=>{
    if (bans[p.uid]) return;

    const num = start+idx+1;
    const wrap = document.createElement("div");
    wrap.className = "post";

    wrap.innerHTML = `
      <div>
        <span class="replyNum">#${num}</span>
        <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <strong>${p.name||defaultName}</strong>
        <div class="meta">${new Date(p.time||0).toLocaleString()}</div>
      </div>
      <div style="margin-top:8px">${linkify(p.text)}</div>
    `;

    /* 返信 */
    const replyBtn = document.createElement("button");
    replyBtn.textContent = "返信";
    replyBtn.className = "replyBtn";
    replyBtn.onclick = () => {
      document.getElementById("replyText").value = `#${num} `;
      document.getElementById("replyText").focus();
    };
    wrap.appendChild(replyBtn);

    /* 通報ボタン（追加） */
    const reportBtn = document.createElement("button");
    reportBtn.textContent = "通報";
    reportBtn.style.marginLeft = "6px";
    reportBtn.onclick = async()=>{
      const me = localStorage.getItem("usakira_userId");
      if (!confirm("この投稿を通報しますか？")) return;

      await push(ref(db, `reports/${threadId}`), {
        postId: id,
        targetUid: p.uid,
        reporterUid: me,
        text: p.text,
        time: Date.now()
      });

      alert("通報を受け付けました");
    };
    wrap.appendChild(reportBtn);

    /* 削除・BAN（既存） */
    const controls = document.createElement("div");
    controls.style.marginTop = "8px";

    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.onclick = async()=>{
      const me = localStorage.getItem("usakira_userId");
      const tSnap = await get(ref(db, `threads/${threadId}`));
      const t = tSnap.val() || {};

      if (me===p.uid || me===t.ownerId){
        if(!confirm("削除しますか？")) return;
        await remove(ref(db, `posts/${threadId}/${id}`));
        return;
      }

      const pw = prompt("管理パスワード");
      if(pw==="master"){
        await remove(ref(db, `posts/${threadId}/${id}`));
        alert("削除しました");
        return;
      }
      alert("削除権限なし");
    };
    controls.appendChild(delBtn);

    const banBtn = document.createElement("button");
    banBtn.textContent = "BAN";
    banBtn.onclick = async()=>{
      const me = localStorage.getItem("usakira_userId");
      const tSnap = await get(ref(db, `threads/${threadId}`));
      const t = tSnap.val() || {};

      if (me===t.ownerId){
        if (!confirm(`${p.name} をBANしますか？`)) return;
        await set(ref(db, `bans/${p.uid}`), true);
        alert("BANしました");
        return;
      }

      const pw = prompt("管理パスワード");
      if(pw==="master"){
        await set(ref(db, `bans/${p.uid}`), true);
        alert("BANしました");
        return;
      }
      alert("BAN権限なし");
    };
    controls.appendChild(banBtn);

    wrap.appendChild(controls);
    container.appendChild(wrap);
  });

  /* ページング */
  const pages = Math.max(1, Math.ceil(postsArr.length/PER));
  const pg = document.getElementById("postsPaging");
  pg.innerHTML = "";

  for(let i=1;i<=pages;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>renderPosts(i);
    pg.appendChild(b);
  }
}
