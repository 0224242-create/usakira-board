<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  color:#222;
  padding:20px;
  transition:.25s;
}
body.dark{background:#121212;color:#eee}

h1,h2{margin-top:0}

.thread, .post{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
}
body.dark .thread, body.dark .post{
  background:#1b1b1b;
  border-color:#555;
}

.flex{display:flex;align-items:center}
.column{display:flex;flex-direction:column}

.icon{
  width:48px;height:48px;border-radius:50%;
  border:2px solid #ffb8e6;
  object-fit:cover;margin-right:10px;
}
body.dark .icon{border-color:#ff8cd1}

button{
  padding:6px 10px;border-radius:6px;cursor:pointer;margin:2px;
}

.tools{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}
.reactions{display:flex;gap:4px;margin-top:4px}

.highlight{background:#fff1f5 !important;transition:.3s;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitle"></h1>
<p><button id="backBtn">æ²ç¤ºæ¿ã«æˆ»ã‚‹</button></p>
<div id="posts"></div>

<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã"></textarea>
<button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ç®¡ç†äººãƒ•ãƒ©ã‚° */
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
document.getElementById("backBtn").onclick=()=>{location.href="index.html";};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const userIcon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

/* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ */
document.getElementById("postBtn").onclick=async()=>{
  const text=document.getElementById("commentText").value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");

  // BANãƒã‚§ãƒƒã‚¯
  const banSnap=await get(ref(db,"bans/"+userId));
  if(banSnap.exists()) return alert("ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™ãƒšã‚³");

  const key=push(ref(db,"posts/"+threadId),{
    uid:userId,name:userName,icon:userIcon,text,time:Date.now(),reactions:{},deleted:false
  }).key;
  document.getElementById("commentText").value="";
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ« */
const threadTitleEl=document.getElementById("threadTitle");
onValue(ref(db,"threads/"+threadId),snap=>{
  const t=snap.val();
  if(t) threadTitleEl.textContent=t.title||"(ç„¡é¡Œ)";
});

/* BANãƒªã‚¹ãƒˆå–å¾— */
let banUsers={};
onValue(ref(db,"bans"),snap=>{banUsers=snap.val()||{}; renderPosts();});

/* æŠ•ç¨¿ä¸€è¦§ */
const postsEl=document.getElementById("posts");
function renderPosts(){
  onValue(ref(db,"posts/"+threadId),snap=>{
    postsEl.innerHTML="";
    const posts=snap.val()||{};
    let index=1;
    Object.entries(posts).sort((a,b)=>a[1].time-b[1].time).forEach(([pid,p])=>{
      const div=document.createElement("div");
      div.className="post column";
      if(p.deleted) div.style.opacity=0.5;

      const isBanned=banUsers[p.uid]!=null;
      const nameDisplay=p.name + (isBanned?" {BAN}":"");

      div.innerHTML=`
        <div class="flex">
          <img class="icon" src="${p.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
          <div style="flex:1">
            <b>#${index} ${nameDisplay}</b><br>
            <small>${new Date(p.time).toLocaleString()}</small>
          </div>
        </div>
        <p>${p.deleted?"ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³":p.text}</p>
      `;

      const tools=document.createElement("div");
      tools.className="tools";

      /* å‰Šé™¤ */
      const delBtn=document.createElement("button");
      delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=async()=>{
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        await set(ref(db,"posts/"+threadId+"/"+pid+"/deleted"),true);
      };
      if(isAdmin) tools.appendChild(delBtn);

      /* BANãƒœã‚¿ãƒ³ */
      if(isAdmin && !isBanned){
        const banBtn=document.createElement("button");
        banBtn.textContent="BAN";
        banBtn.onclick=async()=>{
          if(!confirm("BANã—ã¾ã™ã‹ï¼Ÿ")) return;
          await set(ref(db,"bans/"+p.uid),{name:p.name,icon:p.icon,time:Date.now()});
        };
        tools.appendChild(banBtn);
      }

      /* é€šå ± */
      const reportBtn=document.createElement("button");
      reportBtn.textContent="é€šå ±";
      reportBtn.onclick=async()=>{
        const repRef=ref(db,"reports/"+Date.now());
        await set(repRef,{threadId:threadId,postId:pid,userId:p.uid,name:p.name,icon:p.icon,text:p.text,time:Date.now()});
        alert("é€šå ±ã—ãŸãƒšã‚³");
      };
      tools.appendChild(reportBtn);

      div.appendChild(tools);

      /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
      const reactDiv=document.createElement("div");
      reactDiv.className="reactions";
      ["âœ¨ï¸","ğŸ¥•"].forEach(em=>{
        const btn=document.createElement("button");
        btn.textContent=em+" "+(p.reactions && p.reactions[em]?Object.keys(p.reactions[em]).length:0);
        btn.onclick=async()=>{
          const reactions=p.reactions||{};
          reactions[em]=reactions[em]||{};
          if(reactions[em][userId]) delete reactions[em][userId];
          else reactions[em][userId]=true;
          await set(ref(db,"posts/"+threadId+"/"+pid+"/reactions"),reactions);
        };
        reactDiv.appendChild(btn);
      });
      div.appendChild(reactDiv);

      /* ã‚¸ãƒ£ãƒ³ãƒ—ãƒªãƒ³ã‚¯ */
      const jump=document.createElement("button");
      jump.textContent=">>#"+index;
      jump.onclick=()=>{div.scrollIntoView({behavior:"smooth"});}
      div.appendChild(jump);

      postsEl.appendChild(div);
      index++;
    });
  });
}
renderPosts();
</script>
</body>
</html>
