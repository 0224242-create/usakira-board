<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
button{padding:6px 10px;border-radius:6px;cursor:pointer;margin:2px;}
button:hover{opacity:.85;}
textarea{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
body.dark textarea{background:#222;color:#eee;border:1px solid #555;}
.card{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0;box-shadow:0 2px 6px rgba(255,150,210,.25);transition:.2s;}
body.dark .card{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,.35);}
.card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(255,150,210,.32);}
.flex{display:flex;align-items:center;gap:10px;}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}
.icon{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;}
body.dark .icon{border-color:#ff8cd1;}
.meta{font-size:.85rem;color:#aa7;}
.deleted{color:#888;font-style:italic;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>
<h1 id="threadTitleH">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<div id="threadBodyDiv"></div>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
<button id="postComment">æŠ•ç¨¿</button>
<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
const userIcon = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";
const isAdmin = localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— */
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

/* ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º */
const titleH = document.getElementById("threadTitleH");
const bodyDiv = document.getElementById("threadBodyDiv");
onValue(ref(db,`threads/${threadId}`),snap=>{
  const t = snap.val();
  if(t){
    titleH.textContent = t.title || "ï¼ˆç„¡é¡Œï¼‰";
    bodyDiv.textContent = t.body||"";
  } else {
    titleH.textContent="ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“";
  }
});

/* BANãƒã‚§ãƒƒã‚¯ */
let isBanned = false;
onValue(ref(db,`bans/${userId}`),snap=>{isBanned=!!snap.val();});

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
const commentsDiv = document.getElementById("comments");
onValue(ref(db,`posts/${threadId}`),snap=>{
  commentsDiv.innerHTML="";
  const data = snap.val()||{};
  Object.entries(data).sort((a,b)=>b[1].time - a[1].time).forEach(([cid,c])=>{
    const card = document.createElement("div");
    card.className="card";

    if(c.deleted){
      card.innerHTML=`<p class="deleted">ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³</p>`;
    }else{
      const starCount = c.react?.starUsers ? Object.keys(c.react.starUsers).length : 0;
      const carrotCount = c.react?.carrotUsers ? Object.keys(c.react.carrotUsers).length : 0;
      const bannedLabel = c.banned ? " ğŸš«" : "";
      card.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||'usagi.png.jpeg'}">
        <div>
          <b>${c.name||"åã‚‚ãªãå…"}${isAdmin?" ğŸ‘‘":""}${bannedLabel}</b>
          <div class="meta">ID:${c.uid}  ${new Date(c.time).toLocaleString()}</div>
        </div>
      </div>
      <p>${c.text||""} ãƒšã‚³</p>
      <div class="flex-end">
        <button class="like">âœ¨ï¸ ${starCount}</button>
        <button class="carrot">ğŸ¥• ${carrotCount}</button>
        ${isAdmin?'<button class="del">å‰Šé™¤</button><button class="ban">BAN</button>':""}
        <button class="report">é€šå ±</button>
      </div>`;
    }

    commentsDiv.appendChild(card);

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    if(!c.deleted){
      const starBtn = card.querySelector(".like");
      const carrotBtn = card.querySelector(".carrot");
      starBtn.onclick=async()=>{
        const exists = c.react?.starUsers?.[userId];
        await set(ref(db,`posts/${threadId}/${cid}/react/starUsers/${userId}`),exists?null:true);
      };
      carrotBtn.onclick=async()=>{
        const exists = c.react?.carrotUsers?.[userId];
        await set(ref(db,`posts/${threadId}/${cid}/react/carrotUsers/${userId}`),exists?null:true);
      };
    }

    /* å‰Šé™¤ */
    const delBtn = card.querySelector(".del");
    if(delBtn) delBtn.onclick=async()=>{ await set(ref(db,`posts/${threadId}/${cid}/deleted`),true); };

    /* BAN */
    const banBtn = card.querySelector(".ban");
    if(banBtn) banBtn.onclick=async()=>{ await set(ref(db,`bans/${c.uid}`),{name:c.name,icon:c.icon,time:Date.now()}); };

    /* é€šå ± */
    const repBtn = card.querySelector(".report");
    if(repBtn) repBtn.onclick=async()=>{
      await set(ref(db,`reports/${threadId}_${cid}`),{uid:c.uid,name:c.name,icon:c.icon,text:c.text,time:Date.now(),threadId,postId:cid});
      alert("é€šå ±ã—ãŸãƒšã‚³");
    };
  });
});

/* æŠ•ç¨¿ */
document.getElementById("postComment").onclick=async()=>{
  if(isBanned) return alert("BANã•ã‚Œã¦ã„ã‚‹ã®ã§æŠ•ç¨¿ã§ããªã„ãƒšã‚³");
  const text=document.getElementById("commentInput").value.trim();
  if(!text) return;
  await push(ref(db,`posts/${threadId}`),{
    text,
    uid:userId,
    name:userName,
    icon:userIcon,
    time:Date.now(),
    react:{},
    reactUsers:{}
  });
  document.getElementById("commentInput").value="";
};
</script>
</body>
</html>
