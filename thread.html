<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>„Çπ„É¨„ÉÉ„Éâ - „ÅÜ„Åï‚òÖ„Ç≠„É©Êé≤Á§∫Êùø</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin:0; padding:0; background:#fffafc; color:#222; }
    header { padding:14px; background:#ffecf7; border-bottom:2px solid #ffc7e5; }
    header a { text-decoration:none; color:#d24f9a; font-weight:bold; }

    .container { padding:16px; }

    .post-box { margin-bottom:18px; }
    textarea { width:100%; height:80px; padding:8px; border-radius:10px; border:1px solid #ddd; }

    button { padding:10px 16px; border:none; background:#ff9ad0; color:white; border-radius:14px; font-size:15px; cursor:pointer; }
    button:hover { opacity:0.85; }

    .post { padding:12px; margin:12px 0; background:white; border-radius:14px; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
    .meta { color:#888; font-size:13px; }
    .react { margin-top:8px; }
    .react span { font-size:22px; margin-right:10px; cursor:pointer; }

    .deleteBtn { background:#e87171; padding:6px 10px; border-radius:10px; color:white; font-size:13px; float:right; }

    a { color:#3d7bd9; word-break: break-all; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
      authDomain: "keijiban-7c651.firebaseapp.com",
      databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com/",
      projectId: "keijiban-7c651",
      storageBucket: "keijiban-7c651.appspot.com",
      messagingSenderId: "921483852598",
      appId: "1:921483852598:web:3b8eae4c671ced06010f49"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();

    const threadId = location.search.replace("?id=", "");

    function escapeHtml(s){
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function linkify(text){
      return text.replace(/(https?:\\/\\/[A-Za-z0-9_./?=&%-]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    function load(){
      db.ref("threads/"+threadId+"/posts").on("value", snap => {
        const area = document.getElementById("posts");
        area.innerHTML = "";
        snap.forEach(child => {
          const v = child.val();
          const key = child.key;

          const div = document.createElement("div");
          div.className = "post";

          let content = escapeHtml(v.text);
          content = linkify(content);
          content += " „Éö„Ç≥";

          div.innerHTML = `
            <div class="meta">${v.name || "Âêç„ÇÇ„Å™„ÅçÂÖé"} ÔΩú ${v.time}
              <span class="deleteBtn" onclick="delPost('${key}')">ÂâäÈô§</span>
            </div>
            <div>${content}</div>
            <div class="react">
              <span onclick="react('${key}','carrot')">ü•ï ${v.reaction?.carrot || 0}</span>
              <span onclick="react('${key}','kirakira')">‚ú® ${v.reaction?.kirakira || 0}</span>
            </div>
          `;

          area.appendChild(div);
        });
      });
    }

    function post(){
      const text = document.getElementById("text").value;
      const name = document.getElementById("name").value || "Âêç„ÇÇ„Å™„ÅçÂÖé";
      if(!text.trim()) return;

      const now = new Date();
      const t = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;

      db.ref(`threads/${threadId}/posts`).push({
        text: text,
        name: name,
        time: t,
        reaction: { carrot:0, kirakira:0 }
      });

      document.getElementById("text").value = "";
    }

    function delPost(key){
      db.ref(`threads/${threadId}/posts/${key}`).remove();
    }

    function react(key,type){
      const ref = db.ref(`threads/${threadId}/posts/${key}/reaction/${type}`);
      ref.transaction(v => (v||0)+1);
    }

    window.onload = load;
  </script>
</head>
<body>
  <header>
    <a href="index.html">‚Üê Êé≤Á§∫Êùø„Å´Êàª„Çã</a>
  </header>

  <div class="container">
    <h2>„Çπ„É¨„ÉÉ„Éâ</h2>

    <div class="post-box">
      <input id="name" placeholder="ÂêçÂâç (Á©∫„Å™„Çâ Âêç„ÇÇ„Å™„ÅçÂÖé)" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px;" />
      <textarea id="text" placeholder="„Ç≥„É°„É≥„Éà„ÇíÊõ∏„ÅÑ„Å¶„Å≠"></textarea>
      <button onclick="post()">ÊäïÁ®ø</button>
    </div>

    <div id="posts"></div>
  </div>
</body>
</html>
