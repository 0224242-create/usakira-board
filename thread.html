<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fffafc;
  color:#222;
  padding:14px;
  transition:.25s;
}
body.dark{background:#121212;color:#eee}

/* ===== æŠ•ç¨¿ ===== */
.post{
  background:#fff;
  border-radius:10px;
  padding:10px;
  margin:10px 0;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}
body.dark .post{background:#1e1e1e}

/* ã‚¹ãƒ¬ä¸» */
.ownerPost{
  border-left:6px solid #ff69b4;
}

/* ç®¡ç†äºº */
.adminName{
  color:#f5b400;
  font-weight:bold;
}

/* ãƒœã‚¿ãƒ³ */
button{
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
}
body.dark button{
  background:#333;color:#eee;border:1px solid #666;
}

/* è¿”ä¿¡ */
.reply{
  font-size:.9rem;
  color:#ff4fa8;
}

/* ã‚¢ã‚¤ã‚³ãƒ³ */
.icon{
  width:36px;height:36px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
}

/* ãƒ€ãƒ¼ã‚¯æ™‚ */
body.dark .icon{
  border-color:#ff8cd1;
}
</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:10px;top:10px">ğŸŒ™</button>

<h2 id="threadTitle"></h2>

<div id="posts"></div>

<hr>

<textarea id="body" placeholder="æ›¸ãè¾¼ã¿å†…å®¹"></textarea>
<input id="img" placeholder="ç”»åƒURLï¼ˆä»»æ„ï¼‰">
<button id="send">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove } from
  "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain:"keijiban-7c651.firebaseapp.com",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId:"keijiban-7c651"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const dark=localStorage.getItem("usakira_dark")==="true";
if(dark) document.body.classList.add("dark");
darkToggle.textContent=dark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const n=!document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",n);
  darkToggle.textContent=n?"â˜€ï¸":"ğŸŒ™";
};

/* ID */
const userId=localStorage.getItem("usakira_userId");
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

/* ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³ */
let isAdmin=localStorage.getItem("usakira_isAdmin")==="true";
if(!isAdmin && confirm("ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ")){
  const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw==="master"){
    isAdmin=true;
    localStorage.setItem("usakira_isAdmin","true");
    alert("ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
  }
}

/* ã‚¹ãƒ¬ID */
const id=new URLSearchParams(location.search).get("id");
const postRef=ref(db,"posts/"+id);

/* è¡¨ç¤º */
onValue(postRef,s=>{
  const box=document.getElementById("posts");
  box.innerHTML="";
  let i=1;
  s.forEach(c=>{
    const p=c.val();
    const div=document.createElement("div");
    div.className="post";
    if(p.uid===p.owner) div.classList.add("ownerPost");

    div.innerHTML=`
      <div>
        <img class="icon" src="${p.icon||icon}">
        <strong class="${p.admin?'adminName':''}">
          ${p.admin?'ğŸ‘‘':''}${p.owner?'â˜…':''}${p.name}
        </strong>
        <span>No.${i}</span>
      </div>
      <div>${p.text}</div>
      ${p.img?`<img src="${p.img}" style="max-width:100%">`:''}
      <div>
        <button onclick="reply(${i})">è¿”ä¿¡</button>
        ${(p.uid===userId||isAdmin)?`<button onclick="del('${c.key}')">å‰Šé™¤</button>`:''}
      </div>
    `;
    box.appendChild(div);
    i++;
  });
});

/* æŠ•ç¨¿ */
send.onclick=()=>{
  if(!body.value) return;
  push(postRef,{
    text:body.value,
    img:img.value||null,
    uid:userId,
    name,
    icon,
    admin:isAdmin,
    owner:false,
    time:Date.now()
  });
  body.value="";
  img.value="";
};

/* è¿”ä¿¡ */
window.reply=n=>{
  body.value+=">>"+n+"\n";
};

/* å‰Šé™¤ */
window.del=k=>{
  if(confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿ")){
    remove(ref(db,"posts/"+id+"/"+k));
  }
};
</script>

</body>
</html>
