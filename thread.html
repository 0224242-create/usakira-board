<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1{margin-top:0;}
.flex{display:flex;align-items:center;}
.flex-column{display:flex;flex-direction:column;}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}
.icon{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;margin-right:10px;}
.thread-card{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(255,150,210,.25);}
body.dark .thread-card{background:#1b1b1b;border-color:#555;}
textarea{width:100%;height:60px;padding:6px;margin:4px 0;border-radius:6px;}
button{padding:4px 8px;border-radius:6px;cursor:pointer;margin-left:4px;}
.ban{color:red;}
.locked{background:#ccc !important;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>
<h1 id="threadTitleH">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>

<div>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<button id="saveProfile">ä¿å­˜</button>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>
</div>
<hr>

<div>
<label>ä¸¦ã³æ›¿ãˆ: </label>
<select id="sortSelect">
  <option value="time">æ–°ã—ã„é †</option>
  <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †</option>
</select>
</div>

<div id="threadContent"></div>
<hr>

<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<button id="postBtn">æŠ•ç¨¿</button>
<button onclick="location.href='index.html'">æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const now=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick=()=>{
  const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw==="master") location.href="report-admin.html";
  else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");
const threadTitleH=document.getElementById("threadTitleH");
const threadContent=document.getElementById("threadContent");
const sortSelect=document.getElementById("sortSelect");

/* BANæƒ…å ± */
let banList={};
onValue(ref(db,"bans"),snap=>{banList=snap.val()||{}; renderComments();});

/* ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ± */
let threadData={};
onValue(ref(db,"threads/"+threadId),snap=>{
  const t=snap.val();
  if(!t) {threadTitleH.textContent="ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“"; return;}
  threadData=t;
  threadTitleH.textContent=t.title||"ï¼ˆç„¡é¡Œï¼‰";
  renderComments();
});

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
function renderComments(){
  get(ref(db,"posts/"+threadId)).then(snap=>{
    const posts=snap.val()||{};
    let sorted=Object.entries(posts);

    if(sortSelect.value==="reaction"){
      sorted.sort((a,b)=>{
        const rA=a[1].reaction||{};
        const rB=b[1].reaction||{};
        const sumA=(rA.carrot||0)+(rA.star||0);
        const sumB=(rB.carrot||0)+(rB.star||0);
        return sumB-sumA;
      });
    }else{
      sorted.sort((a,b)=>b[1].time-a[1].time);
    }

    threadContent.innerHTML="";
    sorted.forEach(([pid,p],i)=>{
      const div=document.createElement("div");
      div.className="thread-card";
      if(threadData.pass) div.classList.add("locked");
      const isBan=banList[p.uid];
      div.innerHTML=`
        <div class="flex">
          <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
          <div>
            <b>${i+1}. ${p.name||defaultName}${isBan?" {BAN}":""}</b>
            <div style="font-size:.8rem;color:#888">${new Date(p.time).toLocaleString()}</div>
          </div>
        </div>
        <p>${p.text||""}</p>
        <div class="flex-end">
          <button class="react" data-type="carrot">ğŸ¥• ${p.reaction?.carrot||0}</button>
          <button class="react" data-type="star">âœ¨ ${p.reaction?.star||0}</button>
          <button class="unreact" data-type="carrot">å–æ¶ˆ</button>
          <button class="unreact" data-type="star">å–æ¶ˆ</button>
          <button class="reportBtn">é€šå ±</button>
        </div>
      `;
      threadContent.appendChild(div);

      // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      div.querySelectorAll(".react").forEach(b=>{
        b.onclick=async()=>{
          const type=b.dataset.type;
          const r=p.reaction||{};
          r[type]=(r[type]||0)+1;
          await update(ref(db,"posts/"+threadId+"/"+pid),{reaction:r});
          renderComments();
        };
      });
      div.querySelectorAll(".unreact").forEach(b=>{
        b.onclick=async()=>{
          const type=b.dataset.type;
          const r=p.reaction||{};
          if(r[type]>0) r[type]-=1;
          await update(ref(db,"posts/"+threadId+"/"+pid),{reaction:r});
          renderComments();
        };
      });

      // é€šå ±
      div.querySelector(".reportBtn").onclick=async()=>{
        const reason=prompt("é€šå ±ç†ç”±");
        if(!reason) return;
        await set(ref(db,"reports/"+pid),{
          threadId,
          postId:pid,
          text:p.text,
          name:p.name,
          icon:p.icon,
          userId:p.uid,
          time:Date.now(),
          reason
        });
        alert("é€šå ±ã—ã¾ã—ãŸãƒšã‚³");
      };
    });
  });
}

sortSelect.onchange=renderComments;

/* æŠ•ç¨¿ãƒœã‚¿ãƒ³ */
document.getElementById("postBtn").onclick=async()=>{
  if(banList[userId]) return alert("BANã•ã‚Œã¦ã„ã¾ã™");
  const text=document.getElementById("commentText").value.trim();
  if(!text) return;
  await push(ref(db,"posts/"+threadId),{
    uid:userId,
    name:nameInput.value||defaultName,
    icon:iconInput.value||defaultIcon,
    text,
    time:Date.now(),
    reaction:{carrot:0,star:0}
  });
  document.getElementById("commentText").value="";
  renderComments();
};
</script>
</body>
</html>
