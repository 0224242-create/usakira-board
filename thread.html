<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family:"Hiragino Kaku Gothic ProN",sans-serif;
      background:#fff0f8;
      padding:20px;
      color:#222;
      transition:.25s;
    }
    body.dark{background:#121212;color:#eaeaea}

    .post{
      border:2px solid #ffc6e6;
      background:#fff7fc;
      border-radius:14px;
      padding:12px;
      margin:10px 0;
    }
    body.dark .post{
      background:#1b1b1b;
      border-color:#555;
    }

    textarea,input{
      width:100%;
      padding:6px;
      margin:4px 0;
      border-radius:6px;
      border:1px solid #ccc;
      box-sizing:border-box;
    }
    body.dark textarea,body.dark input{
      background:#222;
      color:#eee;
      border-color:#555;
    }

    button{
      padding:6px 10px;
      margin:4px;
      border-radius:6px;
      cursor:pointer;
    }
    body.dark button{
      background:#333;
      color:#eee;
      border:1px solid #666;
    }

    a{color:#ff4fa8;text-decoration:none}
    a:hover{text-decoration:underline}

    .admin{color:#ff9800;font-weight:bold}
    .meta{font-size:.8rem;color:#aa7}
  </style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<h2 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<hr>

<div id="posts"></div>

<hr>

<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³"></textarea>
<button id="sendBtn">é€ä¿¡</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain:"keijiban-7c651.firebaseapp.com",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId:"keijiban-7c651",
  storageBucket:"keijiban-7c651.appspot.com",
  messagingSenderId:"342192640264",
  appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
  document.body.classList.add("dark");
  darkToggle.textContent="â˜€ï¸";
}
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const on=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",on);
  darkToggle.textContent=on?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const name=localStorage.getItem("usakira_name")||defaultName;
const icon=localStorage.getItem("usakira_icon")||defaultIcon;

let userId=localStorage.getItem("usakira_userId");
if(!userId){
  userId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId",userId);
}
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ã‚¹ãƒ¬IDå–å¾— */
const params=new URLSearchParams(location.search);
const threadId=params.get("id");
if(!threadId){ alert("ã‚¹ãƒ¬ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãƒšã‚³"); }

/* ã‚¹ãƒ¬æƒ…å ± */
const threadRef=ref(db,"threads/"+threadId);
get(threadRef).then(snap=>{
  const t=snap.val();
  if(!t) return alert("ã‚¹ãƒ¬ãŒæ¶ˆãˆã¦ã‚‹ãƒšã‚³");

  if(t.pass){
    const pw=prompt("éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw!==t.pass){ alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³"); location.href="index.html"; }
  }

  document.getElementById("threadTitle").innerHTML=
    t.title+(isAdmin?' <span class="admin">ğŸ‘‘</span>':"");
});

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
onValue(ref(db,"posts/"+threadId),snap=>{
  const box=document.getElementById("posts");
  box.innerHTML="";
  const data=snap.val()||{};
  Object.entries(data).forEach(([id,p])=>{
    const div=document.createElement("div");
    div.className="post";
    div.innerHTML=`
      <b>${p.name}${p.admin?' <span class="admin">ğŸ‘‘</span>':""}</b>
      <div class="meta">
        ID:${p.userId}<br>
        ${new Date(p.time).toLocaleString()}
      </div>
      <p>${p.text}</p>
      <div class="del"></div>
    `;
    if(userId===p.userId||isAdmin){
      const d=document.createElement("button");
      d.textContent="å‰Šé™¤";
      d.onclick=()=>set(ref(db,"posts/"+threadId+"/"+id),null);
      div.querySelector(".del").appendChild(d);
    }
    box.appendChild(div);
  });
});

/* ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ */
sendBtn.onclick=()=>{
  const txt=commentText.value.trim();
  if(!txt) return;
  push(ref(db,"posts/"+threadId),{
    text:txt+" ãƒšã‚³",
    name,
    icon,
    userId,
    admin:isAdmin,
    time:Date.now()
  });
  commentText.value="";
};
</script>

</body>
</html>
