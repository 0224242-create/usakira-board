<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:0.25s;
}
body.dark{background:#121212;color:#eee;}

h1,h2{margin-top:0;}

.thread-card{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
}
body.dark .thread-card{background:#1b1b1b;border-color:#555;}

.flex{display:flex;align-items:center;}
.flex-column{display:flex;flex-direction:column;}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}

.icon{
  width:48px;height:48px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
  margin-right:10px;
}

button{padding:4px 8px;border-radius:6px;cursor:pointer;margin-left:4px;}
textarea,input{width:100%;padding:6px;margin:4px 0;border-radius:6px;}

.reaction{cursor:pointer;margin-right:6px;}
.reaction.active{font-weight:bold;color:#f90;}
.comment-meta{font-size:0.8rem;color:#aa7;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<h1 id="threadTitleH1">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<button onclick="location.href='index.html'">æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<hr>

<div id="commentList"></div>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</h2>
<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<input type="text" id="commentPass" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰"/>
<button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const now=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName=localStorage.getItem("usakira_name")||defaultName;
const userIcon=localStorage.getItem("usakira_icon")||defaultIcon;
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* URLã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");

/* ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º */
onValue(ref(db,`threads/${threadId}`),snap=>{
  const thread=snap.val();
  if(thread) document.getElementById("threadTitleH1").textContent=thread.title||"ï¼ˆç„¡é¡Œï¼‰";
});

/* BANæƒ…å ± */
let banList={};
onValue(ref(db,"bans"),snap=>{
  banList=snap.val()||{};
});

/* ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º */
const commentList=document.getElementById("commentList");
function renderComments(data){
  commentList.innerHTML="";
  const sorted=Object.entries(data).sort((a,b)=>a[1].time-b[1].time);
  sorted.forEach(([id,cmt],index)=>{
    const div=document.createElement("div");
    div.className="thread-card";
    div.id="comment-"+index;
    const banned=banList[cmt.ownerId];
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${cmt.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <b>${cmt.ownerName||defaultName}${banned?" {BAN}":""} (#${index+1})</b>
          <div class="comment-meta">${new Date(cmt.time).toLocaleString()}</div>
        </div>
      </div>
      <p>${cmt.text||""} ãƒšã‚³</p>
      <div class="flex" style="margin-top:4px;">
        <span class="reaction" data-type="carrot">ğŸ¥• ${cmt.reaction?.carrot||0}</span>
        <span class="reaction" data-type="star">âœ¨ï¸ ${cmt.reaction?.star||0}</span>
      </div>
    `;
    const tools=document.createElement("div");
    tools.className="flex-end";

    if(isAdmin){
      const del=document.createElement("button");
      del.textContent="å‰Šé™¤";
      del.onclick=async()=>{
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        await remove(ref(db,`posts/${threadId}/${id}`));
      };
      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>{
        await set(ref(db,`bans/${cmt.ownerId}`),{
          name:cmt.ownerName, icon:cmt.ownerIcon, time:Date.now()
        });
        alert("BANã—ãŸãƒšã‚³");
      };
      tools.append(del,banBtn);
    }

    // é€šå ±ãƒœã‚¿ãƒ³
    const reportBtn=document.createElement("button");
    reportBtn.textContent="é€šå ±";
    reportBtn.onclick=async()=>{
      await set(ref(db,`reports/${threadId}/${id}/${userId}`),{
        uid:userId, name:userName, icon:userIcon, text:cmt.text, time:Date.now()
      });
      alert("é€šå ±ã—ãŸãƒšã‚³");
    };
    tools.append(reportBtn);

    div.appendChild(tools);

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯
    div.querySelectorAll(".reaction").forEach(span=>{
      span.onclick=async()=>{
        if(!cmt.reaction) cmt.reaction={carrot:0,star:0,users:{}};
        cmt.reaction.users=cmt.reaction.users||{};
        const type=span.dataset.type;
        if(cmt.reaction.users[userId]===type){
          cmt.reaction[type]--;
          delete cmt.reaction.users[userId];
        } else {
          if(cmt.reaction.users[userId]){
            cmt.reaction[cmt.reaction.users[userId]]--;
          }
          cmt.reaction[type]++;
          cmt.reaction.users[userId]=type;
        }
        await set(ref(db,`posts/${threadId}/${id}/reaction`),cmt.reaction);
      };
    });

    commentList.appendChild(div);
  });
}

onValue(ref(db,`posts/${threadId}`),snap=>{
  renderComments(snap.val()||{});
});

/* æŠ•ç¨¿ãƒœã‚¿ãƒ³ */
document.getElementById("postBtn").onclick=async()=>{
  if(banList[userId]){
    alert("BANã•ã‚Œã¦ã„ã‚‹ãŸã‚æŠ•ç¨¿ã§ãã¾ã›ã‚“ãƒšã‚³");
    return;
  }
  const text=document.getElementById("commentInput").value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ã­");
  const pass=document.getElementById("commentPass").value.trim();
  await push(ref(db,`posts/${threadId}`),{
    text, ownerId:userId, ownerName:userName, ownerIcon:userIcon,
    time:Date.now(), pass:pass||null
  });
  document.getElementById("commentInput").value="";
};
</script>
</body>
</html>
