<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰ | ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:14px;
}
body.dark{background:#121212;color:#eee}

.post{
  background:#fff7fc;
  border:2px solid #ffc6e6;
  border-radius:12px;
  padding:10px;
  margin:10px 0;
}
body.dark .post{background:#1b1b1b;border-color:#555}

.icon{
  width:42px;height:42px;
  border-radius:50%;
  object-fit:cover;
  margin-right:8px;
}

.flex{display:flex;align-items:center}
.tools{margin-top:6px;display:flex;gap:6px}

button{padding:4px 8px;border-radius:6px;cursor:pointer}
textarea{width:100%;height:70px;border-radius:8px}
</style>
</head>

<body>

<a href="index.html">â† æˆ»ã‚‹</a>
<h2 id="title">ã‚¹ãƒ¬ãƒƒãƒ‰</h2>

<div id="posts"></div>

<hr>

<div id="form">
  <textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³"></textarea>
  <button id="send">æŠ•ç¨¿</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const app=initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

/* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */
const params=new URLSearchParams(location.search);
const threadId=params.get("id");

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
let uid=localStorage.getItem("usakira_userId");
if(!uid){
  uid="u_"+Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId",uid);
}
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

/* BANãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é‡è¦ï¼‰ */
const banSnap=await get(ref(db,`ban/${uid}`));
if(banSnap.exists()){
  document.body.innerHTML="<h2>ğŸš« BANã•ã‚Œã¦ã„ã¾ã™</h2>";
  throw new Error("banned");
}

/* æŠ•ç¨¿è¡¨ç¤º */
const postsDiv=document.getElementById("posts");
onValue(ref(db,`posts/${threadId}`),snap=>{
  postsDiv.innerHTML="";
  snap.forEach(s=>{
    const p=s.val();
    const div=document.createElement("div");
    div.className="post";

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${p.icon||icon}" onerror="this.src='usagi.png.jpeg'">
        <b>${p.name||"åã‚‚ãªãå…"}</b>
      </div>
      <div style="margin-top:6px">${p.text}</div>
    `;

    const tools=document.createElement("div");
    tools.className="tools";

    /* é€šå ± */
    const report=document.createElement("button");
    report.textContent="é€šå ±";
    report.onclick=()=>{
      location.href=`report.html?thread=${threadId}&post=${s.key}`;
    };
    tools.appendChild(report);

    /* è‡ªåˆ†ã®æŠ•ç¨¿å‰Šé™¤ */
    if(p.uid===uid){
      const del=document.createElement("button");
      del.textContent="å‰Šé™¤";
      del.onclick=async()=>{
        if(confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿ")){
          await remove(ref(db,`posts/${threadId}/${s.key}`));
        }
      };
      tools.appendChild(del);
    }

    div.appendChild(tools);
    postsDiv.appendChild(div);
  });
});

/* æŠ•ç¨¿ */
document.getElementById("send").onclick=async()=>{
  const text=document.getElementById("text").value.trim();
  if(!text)return;

  await push(ref(db,`posts/${threadId}`),{
    uid,
    name,
    icon,
    text,
    time:Date.now()
  });

  document.getElementById("text").value="";
};
</script>
</body>
</html>
