<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; padding:20px; background:#fffafc; color:#222; transition:0.25s; }
    .dark { background:#121212; color:#eaeaea; }
    .post { border:1px solid #ffd4ea; padding:10px; margin:8px 0; border-radius:8px; background:#fff; }
    .icon { width:36px; height:36px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    .meta { font-size:13px; color:#666; margin-top:6px; }
    button { padding:8px 12px; margin:6px 0; cursor:pointer; }
  </style>
</head>
<body>
  <button id="darkToggle" style="position:fixed; right:12px; top:12px;">ğŸŒ™</button>
  <h1 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>
  <div id="threadInfo" class="meta"></div>
  <hr>

  <div id="replyBox">
    <textarea id="replyText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea><br>
    <button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>
  </div>
  <hr>

  <div id="posts"></div>
  <div id="postsPaging"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, remove, update, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
      authDomain: "keijiban-7c651.firebaseapp.com",
      databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
      projectId: "keijiban-7c651",
      storageBucket: "keijiban-7c651.firebasestorage.app",
      messagingSenderId: "342192640264",
      appId: "1:342192640264:web:a004a725b470741aaf1cbd",
      measurementId: "G-7E1BZ3BGBR"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰é©ç”¨ */
    const darkToggle = document.getElementById("darkToggle");
    const darkSaved = localStorage.getItem("usakira_dark") === "true";
    if (darkSaved) document.body.classList.add("dark");
    darkToggle.textContent = darkSaved ? "â˜€ï¸" : "ğŸŒ™";
    darkToggle.addEventListener("click", () => {
      const now = !(localStorage.getItem("usakira_dark") === "true");
      localStorage.setItem("usakira_dark", now);
      document.body.classList.toggle("dark");
      darkToggle.textContent = now ? "â˜€ï¸" : "ğŸŒ™";
    });

    /* ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
    const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
    if (!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId", userId);
    const defaultName = "åã‚‚ãªãå…";
    const defaultIcon = "usagi.png.jpeg";
    const profileName = localStorage.getItem("usakira_name") || defaultName;
    const profileIcon = localStorage.getItem("usakira_icon") || defaultIcon;

    /* ã‚¹ãƒ¬ID (URLå„ªå…ˆã€ãªã‘ã‚Œã° lastThread) */
    const params = new URLSearchParams(location.search);
    const threadId = params.get("id") || localStorage.getItem("lastThread") || "";
    if (!threadId) {
      alert("ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚indexã‹ã‚‰é–‹ã„ã¦ã­ã€‚");
      location.href = "index.html";
      throw new Error("No thread id");
    }

    // ã‚¹ãƒ¬æƒ…å ±å–å¾—ï¼ˆéµãƒã‚§ãƒƒã‚¯ï¼‰
    const threadRef = ref(db, `threads/${threadId}`);
    onValue(threadRef, async (snap) => {
      const t = snap.val();
      if (!t) { document.getElementById("threadTitle").innerText = "ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; return; }
      document.getElementById("threadTitle").innerText = t.title || "ï¼ˆç„¡é¡Œï¼‰";
      document.getElementById("threadInfo").innerHTML = `
        <img class="icon" src="${t.ownerIcon || defaultIcon}" onerror="this.src='${defaultIcon}'">
        by ${t.ownerName || defaultName}
        ${t.pass ? '<span class="meta"> ãƒ» éµä»˜ãã‚¹ãƒ¬</span>' : ''}
        <div class="meta">${t.body || ""}</div>
      `;

      // éµãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚ã‚Šãªã‚‰å…¥åŠ›ï¼‰
      if (t.pass) {
        // allow if reopened by direct? require prompt each time for simplicity
        const p = prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã§ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (p !== t.pass) {
          alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ãŸã‚æˆ»ã‚Šã¾ã™");
          location.href = "index.html";
        }
      }
    });

    /* BAN map */
    let bans = {};
    onValue(ref(db, "bans"), s => bans = s.val() || {});

    /* æŠ•ç¨¿ä¸€è¦§ & ãƒšãƒ¼ã‚¸ãƒ³ã‚° */
    const PER = 20;
    let postsArr = []; // [ [id, data], ... ] sorted by time asc
    onValue(ref(db, `posts/${threadId}`), snap => {
      const data = snap.val() || {};
      postsArr = Object.entries(data).sort((a,b)=> (a[1].time||a[1].timestamp||0) - (b[1].time||b[1].timestamp||0));
      renderPosts(1);
    });

    function linkify(text) {
      return (text||"").replace(/(https?:\/\/[^\s]+)/g, m => `<a href="${m}" target="_blank">${m}</a>`);
    }

    function renderPosts(page=1) {
      const start = (page-1)*PER;
      const pick = postsArr.slice(start, start+PER);
      const container = document.getElementById("posts");
      container.innerHTML = "";
      pick.forEach(([id, p]) => {
        if (bans[p.uid]) return; // banned user's posts hidden
        const html = document.createElement("div");
        html.className = "post";
        html.innerHTML = `
          <div>
            <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
            <strong>${p.name || defaultName}</strong>
            <div class="meta">${new Date((p.time||p.timestamp)||0).toLocaleString()}</div>
          </div>
          <div style="margin-top:8px">${linkify(p.text)}</div>
        `;
        // controls: delete & ban
        const controls = document.createElement("div");
        controls.style.marginTop = "8px";

        // delete: allowed if post owner || thread owner || admin pw
        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.onclick = async () => {
          const me = localStorage.getItem("usakira_userId");
          // check thread owner
          const threadSnap = await get(ref(db, `threads/${threadId}`));
          const threadData = threadSnap.val() || {};
          if (me === p.uid || me === threadData.ownerId) {
            if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await remove(ref(db, `posts/${threadId}/${id}`));
            return;
          }
          const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if (pw === "master") {
            await remove(ref(db, `posts/${threadId}/${id}`));
            alert("ç®¡ç†è€…å‰Šé™¤ã—ã¾ã—ãŸ");
            return;
          }
          alert("å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        };
        controls.appendChild(delBtn);

        // ban button (admin or thread owner can ban)
        const banBtn = document.createElement("button");
        banBtn.textContent = "BAN";
        banBtn.onclick = async () => {
          const threadSnap = await get(ref(db, `threads/${threadId}`));
          const threadData = threadSnap.val() || {};
          const me = localStorage.getItem("usakira_userId");
          if (me === threadData.ownerId) {
            if (!confirm(`${p.name} ã‚’BANã—ã¾ã™ã‹ï¼Ÿ`)) return;
            await set(ref(db, `bans/${p.uid}`), true);
            alert("BANã—ã¾ã—ãŸ");
            return;
          }
          const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if (pw === "master") {
            await set(ref(db, `bans/${p.uid}`), true);
            alert("BANã—ã¾ã—ãŸ");
            return;
          }
          alert("BANæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        };
        controls.appendChild(banBtn);

        html.appendChild(controls);
        container.appendChild(html);
      });

      // paging UI
      const pages = Math.max(1, Math.ceil(postsArr.length / PER));
      const pg = document.getElementById("postsPaging");
      pg.innerHTML = "";
      for (let i=1;i<=pages;i++) {
        const b = document.createElement("button");
        b.textContent = i;
        b.onclick = ()=> renderPosts(i);
        pg.appendChild(b);
      }
    }

    /* æŠ•ç¨¿å‡¦ç†ï¼ˆèªå°¾ãƒšã‚³ã‚’ä»˜ã‘ã‚‹ï¼‰ */
    document.getElementById("postBtn").addEventListener("click", async () => {
      let text = (document.getElementById("replyText").value || "").trim();
      if (!text) return alert("æœ¬æ–‡ã‚’æ›¸ã„ã¦ã­ãƒšã‚³");
      if (!text.endsWith("ãƒšã‚³")) text += " ãƒšã‚³";
      // check ban on me
      const me = localStorage.getItem("usakira_userId");
      const isB = (await get(ref(db, `bans/${me}`))).val();
      if (isB) return alert("æ›¸ãè¾¼ã¿ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ãƒšã‚³");

      const name = localStorage.getItem("usakira_name") || defaultName;
      const icon = localStorage.getItem("usakira_icon") || defaultIcon;
      await push(ref(db, `posts/${threadId}`), {
        name, icon, text, uid: me, time: Date.now()
      });
      document.getElementById("replyText").value = "";
    });

  </script>
</body>
</html>
