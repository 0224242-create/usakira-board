<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>üê∞ „ÅÜ„Åï‚òÖ„Ç≠„É©Êé≤Á§∫Êùø „Çπ„É¨„ÉÉ„Éâ</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s
}
body.dark{background:#121212;color:#eee}

button{
  padding:4px 8px;
  margin:2px;
  border-radius:6px;
  cursor:pointer
}
button:hover{opacity:.85}

textarea,input{
  width:100%;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box
}
body.dark textarea,
body.dark input{
  background:#222;
  color:#eee;
  border:1px solid #555
}

.thread,.comment{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:10px;
  margin:10px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25)
}
body.dark .thread,
body.dark .comment{
  background:#1b1b1b;
  border-color:#555;
  box-shadow:0 2px 6px rgba(0,0,0,.3)
}

.comment:target{
  outline:3px solid #ff7ac8;
  background:#fff0fa;
}
body.dark .comment:target{
  background:#2a1f27;
}

.flex{display:flex;align-items:center;gap:10px}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}

.icon{
  width:40px;
  height:40px;
  border-radius:50%;
  border:2px solid #ffb8e6;
  object-fit:cover
}
body.dark .icon{border-color:#ff8cd1}

.comment p{margin:4px 0}
.meta{font-size:.8rem;color:#aa7}

a.jump-link{
  color:#d22;
  text-decoration:underline;
  cursor:pointer
}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">üåô</button>
<h1 id="threadTitleHeader"></h1>

<div id="postBox">
  <textarea id="commentInput" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..."></textarea>
  <button id="postBtn">ÊäïÁ®ø„Åô„Çã</button>
</div>

<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* „É¶„Éº„Ç∂„Éº */
const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

const userName = localStorage.getItem("usakira_name") || "Âêç„ÇÇ„Å™„ÅçÂÖé";
const userIcon = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"‚òÄÔ∏è":"üåô";
darkToggle.onclick=()=>{
  const now=!document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"‚òÄÔ∏è":"üåô";
};

/* „Çπ„É¨ID */
const urlParams=new URLSearchParams(location.search);
const threadId=urlParams.get("id");
if(!threadId){
  alert("„Çπ„É¨„ÉÉ„ÉâID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
  location.href="index.html";
}

/* BAN„ÉÅ„Çß„ÉÉ„ÇØ */
async function checkBan(){
  const s=await get(ref(db,"bans/"+userId));
  return s.exists();
}

/* ÊäïÁ®ø */
const postBtn=document.getElementById("postBtn");
const commentInput=document.getElementById("commentInput");

postBtn.onclick=async()=>{
  if(await checkBan()) return alert("BAN„Åï„Çå„Å¶„ÅÑ„Çã„Éö„Ç≥");
  if(threadData?.locked) return alert("„Åì„ÅÆ„Çπ„É¨„ÅØ„É≠„ÉÉ„ÇØ‰∏≠„Éö„Ç≥");
  const text=commentInput.value.trim();
  if(!text) return;

  await push(ref(db,"posts/"+threadId),{
    uid:userId,
    name:userName,
    icon:userIcon,
    text:text,
    time:Date.now(),
    reactions:{carrot:0,star:0,total:0}
  });
  commentInput.value="";
};

/* „Çπ„É¨ÊÉÖÂ†± */
const threadTitleHeader=document.getElementById("threadTitleHeader");
let threadData=null;

/* ÁÆ°ÁêÜËÄÖUID */
let adminUIDs=[];
let isAdmin=false;

onValue(ref(db,"adminUIDs"),snap=>{
  adminUIDs=snap.val()||[];
  isAdmin=adminUIDs.includes(userId);
});

onValue(ref(db,"threads/"+threadId),snap=>{
  const t=snap.val();
  threadData=t;
  if(!t){
    threadTitleHeader.textContent="„Çπ„É¨„ÉÉ„Éâ„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì";
    return;
  }

  let label=t.ownerName;
  if(t.ownerId===userId) label+="‚òÖ";
  if(isAdmin) label="üëë"+label;

  threadTitleHeader.innerHTML =
    label+": "+(t.title||"ÔºàÁÑ°È°åÔºâ")+(t.locked?" üîí":"");

  if(t.locked && !isAdmin){
    document.getElementById("postBox").style.display="none";
  }

  if(isAdmin){
    const btn=document.createElement("button");
    btn.textContent=t.locked?"üîìËß£Èô§":"üîí„É≠„ÉÉ„ÇØ";
    btn.onclick=async()=>{
      await set(ref(db,"threads/"+threadId+"/locked"),!t.locked);
    };
    threadTitleHeader.appendChild(btn);
  }
});

/* util */
function esc(s){
  return s.replace(/[&<>"']/g,m=>(
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
  ));
}
function linkAnchors(text){
  return text.replace(/>>#(\d+)/g,
    (_,n)=>`<a class="jump-link" href="#comment${n}">&gt;&gt;#${n}</a>`
  );
}

/* „Ç≥„É°„É≥„ÉàË°®Á§∫ */
const commentsDiv=document.getElementById("comments");

onValue(ref(db,"posts/"+threadId),snap=>{
  commentsDiv.innerHTML="";
  const posts=snap.val()||{};
  const arr=Object.entries(posts).map(([id,c])=>({id,...c}))
    .sort((a,b)=>a.time-b.time);

  arr.forEach((c,i)=>{
    if(c.deleted) return;
    if(c.hidden && !isAdmin) return;

    const div=document.createElement("div");
    div.className="comment";
    div.id="comment"+(i+1);

    let label=c.name;
    if(c.uid===threadData.ownerId) label+="‚òÖ";
    if(adminUIDs.includes(c.uid)) label="üëë"+label;

    const total=c.reactions?.total||0;
    let style="";
    if(total>=10){
      style=`
      background:linear-gradient(to right,#ff5fa2,#ffb347,#fff176,#8aff8a,#6ec6ff,#b388ff);
      -webkit-background-clip:text;
      color:transparent;`;
    }else if(total>=5){
      style="color:red;";
    }

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||'usagi.png.jpeg'}">
        <div style="flex:1">
          <b>${i+1} ${label}</b>
          <p style="${style}">${linkAnchors(esc(c.text))} „Éö„Ç≥</p>
          <p class="meta">${new Date(c.time).toLocaleString()} ID:${c.uid}</p>
        </div>
      </div>
    `;

    const tools=document.createElement("div");
    tools.className="flex-end";

    const reply=document.createElement("button");
    reply.textContent="Ëøî‰ø°";
    reply.onclick=()=>{
      commentInput.value=">>#"+(i+1)+" ";
      commentInput.focus();
    };
    tools.appendChild(reply);

    const report=document.createElement("button");
    report.textContent="ÈÄöÂ†±";
    report.onclick=async()=>{
      const rref=ref(db,"reports");
      const rsnap=await get(rref);
      const reps=rsnap.val()||{};
      let cnt=0;
      for(const k in reps) if(reps[k].postId===c.id) cnt++;

      await push(rref,{
        threadId,postId:c.id,
        uid:c.uid,name:c.name,
        icon:c.icon,text:c.text,
        time:Date.now()
      });

      if(cnt+1>=5){
        await set(ref(db,"posts/"+threadId+"/"+c.id+"/hidden"),true);
      }
      alert(`ÈÄöÂ†±„Åó„Åæ„Åó„Åü„Éö„Ç≥Ôºà${cnt+1}ÂõûÁõÆÔºâ`);
    };
    tools.appendChild(report);

    if(isAdmin){
      const del=document.createElement("button");
      del.textContent="ÂâäÈô§";
      del.onclick=async()=>await set(ref(db,"posts/"+threadId+"/"+c.id+"/deleted"),true);

      const ban=document.createElement("button");
      ban.textContent="BAN";
      ban.onclick=async()=>await set(ref(db,"bans/"+c.uid),
        {name:c.name,icon:c.icon,time:Date.now()});

      tools.append(del,ban);
    }

    const carrot=document.createElement("button");
    carrot.textContent="ü•ï "+(c.reactions?.carrot||0);
    carrot.onclick=async()=>{
      c.reactions=c.reactions||{carrot:0,star:0,total:0};
      const key="react_"+c.id+"_carrot";
      if(localStorage.getItem(key)){
        c.reactions.carrot--;c.reactions.total--;
        localStorage.removeItem(key);
      }else{
        c.reactions.carrot++;c.reactions.total++;
        localStorage.setItem(key,"1");
      }
      c.reactions.carrot=Math.max(0,c.reactions.carrot);
      c.reactions.total=Math.max(0,c.reactions.total);
      await set(ref(db,"posts/"+threadId+"/"+c.id+"/reactions"),c.reactions);
    };

    const star=document.createElement("button");
    star.textContent="‚ú® "+(c.reactions?.star||0);
    star.onclick=async()=>{
      c.reactions=c.reactions||{carrot:0,star:0,total:0};
      const key="react_"+c.id+"_star";
      if(localStorage.getItem(key)){
        c.reactions.star--;c.reactions.total--;
        localStorage.removeItem(key);
      }else{
        c.reactions.star++;c.reactions.total++;
        localStorage.setItem(key,"1");
      }
      c.reactions.star=Math.max(0,c.reactions.star);
      c.reactions.total=Math.max(0,c.reactions.total);
      await set(ref(db,"posts/"+threadId+"/"+c.id+"/reactions"),c.reactions);
    };

    tools.append(carrot,star);
    div.appendChild(tools);
    commentsDiv.appendChild(div);
  });
});
</script>
</body>
</html>
