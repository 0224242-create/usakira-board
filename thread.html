<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰</title>
  <style>
    body { font-family: "ãƒ’ãƒ©ã‚®ãƒŽè§’ã‚´ ProN", sans-serif; padding: 20px; background:#fffafc; color:#222; transition:0.3s; }
    h1 { color:#ff7ac6; }
    textarea { width: 100%; height: 80px; padding: 6px; font-size: 16px; }
    .post {
      border: 1px solid #ffd4ea; background: #fff; padding: 12px;
      border-radius: 8px; margin: 12px 0;
    }
    .info { margin-bottom: 6px; font-weight: bold; font-size: 17px; }
    .icon { width: 45px; height: 45px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
    .comment { margin-top: 4px; font-size: 17px; }
    a { color:#0072ff; }

    .reactions { margin-top: 10px; display:flex; gap:16px; font-size: 22px; }
    .reaction-btn { cursor:pointer; }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    body.dark { background:#161616; color:#eaeaea; }
    body.dark .post { background:#242424; border-color:#555; }
    body.dark a { color:#70b6ff; }

    #darkBtn {
      position: fixed; top: 14px; right: 14px; cursor: pointer;
      background: none; font-size: 26px; border: none;
    }
  </style>
</head>
<body>

<button id="darkBtn">ðŸŒ™</button>
<h1 id="threadTitle">ðŸ“Œ ã‚¹ãƒ¬ãƒƒãƒ‰</h1>

<textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
<button id="postBtn" style="margin-top:10px;">æŠ•ç¨¿</button>

<h2 style="margin-top:30px;">ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
<div id="postList"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
    authDomain: "keijiban-7c651.firebaseapp.com",
    databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
    projectId: "keijiban-7c651",
    storageBucket: "keijiban-7c651.firebasestorage.app",
    messagingSenderId: "342192640264",
    appId: "1:342192640264:web:a004a725b470741aaf1cbd",
    measurementId: "G-7E1BZ3BGBR"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const params = new URLSearchParams(location.search);
  const threadId = params.get("id");

  /* ãƒ†ãƒ¼ãƒž */
  const darkBtn = document.getElementById("darkBtn");
  darkBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    darkBtn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
    localStorage.setItem("darkMode", document.body.classList.contains("dark"));
  });
  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark");
    darkBtn.textContent = "â˜€ï¸";
  }

  /* ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ« */
  onValue(ref(db, `threads/${threadId}/title`), (snapshot) => {
    const title = snapshot.val();
    document.getElementById("threadTitle").innerText = `ðŸ“Œ ${title}`;
    document.title = title;
  });

  /* æŠ•ç¨¿ */
  const userId = localStorage.getItem("userId");
  const profileRef = ref(db, `profiles/${userId}`);
  const defaultIcon = "usagi.png.jpeg";

  document.getElementById("postBtn").addEventListener("click", async () => {
    let text = document.getElementById("text").value.trim();
    if (!text) return;

    // è‡ªå‹•èªžå°¾ãƒšã‚³
    if (!text.endsWith("ãƒšã‚³")) text += " ãƒšã‚³";

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
    let snap = await get(profileRef);
    let p = snap.val() || { name: "åç„¡ã—", comment: "", icon: defaultIcon };

    const newPost = push(ref(db, `threads/${threadId}/posts`));
    set(newPost, {
      name: p.name,
      icon: p.icon,
      profileComment: p.comment,
      text: text,
      createdAt: Date.now(),
      reactions: { carrot: 0, star: 0 }
    });

    document.getElementById("text").value = "";
  });

  /* URL â†’ è‡ªå‹•ãƒªãƒ³ã‚¯ */
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
  }

  /* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
  onValue(ref(db, `threads/${threadId}/posts`), (snapshot) => {
    const data = snapshot.val();
    const list = document.getElementById("postList");
    list.innerHTML = "";
    if (!data) return;

    const posts = Object.entries(data).sort((a, b) => a[1].createdAt - b[1].createdAt);
    posts.forEach(([id, p]) => {
      const div = document.createElement("div");
      div.className = "post";

      div.innerHTML = `
        <div class="info">
          <img class="icon" src="${p.icon}" onerror="this.src='${defaultIcon}'">
          ${p.name}
        </div>
        <div class="comment">${linkify(p.text)}</div>
        ${p.profileComment ? `<div style="font-size:14px;color:#888;margin-top:6px;">ðŸ”¹ ${p.profileComment}</div>` : ""}
      `;

      const reactions = document.createElement("div");
      reactions.className = "reactions";
      reactions.innerHTML = `
        <span class="reaction-btn" data-type="carrot">ðŸ¥• ${p.reactions?.carrot ?? 0}</span>
        <span class="reaction-btn" data-type="star">âœ¨ ${p.reactions?.star ?? 0}</span>
      `;

      reactions.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const type = btn.dataset.type;
          const newCount = (p.reactions?.[type] ?? 0) + 1;
          update(ref(db, `threads/${threadId}/posts/${id}/reactions`), { [type]: newCount });
        });
      });

      div.appendChild(reactions);
      list.appendChild(div);
    });
  });
</script>
</body>
</html>
