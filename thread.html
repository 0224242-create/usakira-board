<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã‚¹ãƒ¬ãƒƒãƒ‰ - ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1,h2{margin-top:0;}
button{padding:6px 10px;border-radius:6px;cursor:pointer;margin:2px;}
button:hover{opacity:.85;}
input,textarea{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
body.dark input,body.dark textarea{background:#222;color:#eee;border:1px solid #555;}
a{text-decoration:underline;color:#d22;}
.card{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0;box-shadow:0 2px 6px rgba(255,150,210,.25);transition:.2s;}
.card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(255,150,210,.32);}
body.dark .card{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,.35);}
body.dark .card:hover{box-shadow:0 6px 12px rgba(0,0,0,.5);}
.flex{display:flex;align-items:center;gap:10px;}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}
.icon{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;}
body.dark .icon{border-color:#ff8cd1;}
.meta{font-size:.85rem;color:#aa7;}
.highlight{border-color:#ff5aa8;box-shadow:0 0 10px #ff5aa8;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>
<h1 id="threadTitleHeader">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<button id="backBtn">æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<div id="profileBox">
  <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
  <input id="nameInput" placeholder="åå‰">
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
  <button id="saveProfile">ä¿å­˜</button>
</div>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</h2>
<textarea id="commentBody" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã..."></textarea>
<button id="postComment">æŠ•ç¨¿</button>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* URLã‹ã‚‰ã‚¹ãƒ¬IDå–å¾— */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");

/* ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«å–å¾— */
const threadTitleHeader=document.getElementById("threadTitleHeader");
get(ref(db,"threads/"+threadId)).then(snap=>{
  const t=snap.val();
  if(t) threadTitleHeader.textContent=t.title||"ï¼ˆç„¡é¡Œï¼‰";
});

/* æ²ç¤ºæ¿ã«æˆ»ã‚‹ */
document.getElementById("backBtn").onclick=()=>{location.href="index.html";};

/* æŠ•ç¨¿ */
const postBtn=document.getElementById("postComment");
postBtn.onclick=async()=>{
  const text=document.getElementById("commentBody").value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");
  const banSnap=await get(ref(db,"bans/"+userId));
  if(banSnap.exists()) return alert("BANã•ã‚Œã¦ã„ã‚‹ã®ã§æŠ•ç¨¿ã§ãã¾ã›ã‚“");
  await push(ref(db,"posts/"+threadId),{
    uid:userId,
    name:nameInput.value||defaultName,
    icon:iconInput.value||defaultIcon,
    text,
    time:Date.now(),
    reactions:{carrot:0,sparkle:0},
    usersReact:{}
  });
  document.getElementById("commentBody").value="";
};

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
const commentsDiv=document.getElementById("comments");
onValue(ref(db,"posts/"+threadId),snap=>{
  commentsDiv.innerHTML="";
  const data=snap.val()||{};
  Object.entries(data).sort((a,b)=>a[1].time-b[1].time).forEach(([cid,c])=>{
    const div=document.createElement("div");
    div.id="comment-"+cid;
    div.className="card";
    if(c.reactions) div.style.borderWidth=Math.min(2+c.reactions.carrot+c.reactions.sparkle,10)+"px";

    /* BANè¡¨ç¤º */
    let banText="";
    get(ref(db,"bans/"+c.uid)).then(banSnap=>{if(banSnap.exists()) div.querySelector(".banText")?.remove(); else if(div.querySelector(".banText")) div.querySelector(".banText").remove();});
    
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <b>${c.name||defaultName}</b> <span class="meta">#${cid} ${new Date(c.time).toLocaleString()}</span>
          <div class="commentText">${c.text||""}</div>
          <div class="banText" style="color:red;font-weight:bold;"></div>
        </div>
      </div>
    `;

    /* ãƒœã‚¿ãƒ³ */
    const btnDiv=document.createElement("div");
    btnDiv.className="flex-end";

    /* å‰Šé™¤ */
    const delBtn=document.createElement("button");
    delBtn.textContent="å‰Šé™¤";
    delBtn.onclick=async()=>{
      const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
      if(pw==="master"||userId===c.uid){
        await set(ref(db,"posts/"+threadId+"/"+cid),null);
        alert("å‰Šé™¤ã—ãŸãƒšã‚³");
      }else alert("æ¨©é™ãŒãªã„ãƒšã‚³");
    };

    /* BAN */
    const banBtn=document.createElement("button");
    banBtn.textContent="BAN";
    banBtn.onclick=async()=>{
      if(confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’BANã—ã¾ã™ã‹ï¼Ÿ")){
        await set(ref(db,"bans/"+c.uid),{name:c.name,icon:c.icon,time:Date.now()});
        alert("BANã—ãŸãƒšã‚³");
      }
    };

    /* é€šå ± */
    const reportBtn=document.createElement("button");
    reportBtn.textContent="é€šå ±";
    reportBtn.onclick=async()=>{
      await push(ref(db,"reports"),{
        threadId,postId:cid,userId:c.uid,name:c.name,icon:c.icon,text:c.text,time:Date.now()
      });
      alert("é€šå ±ã—ãŸãƒšã‚³");
    };

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    const carrotBtn=document.createElement("button");
    carrotBtn.textContent="ğŸ¥•";
    carrotBtn.onclick=async()=>{
      const usersReact=c.usersReact||{};
      if(usersReact[userId]?.carrot) return alert("ã™ã§ã«æŠ¼ã—ãŸãƒšã‚³");
      usersReact[userId]={...usersReact[userId],carrot:true};
      c.reactions.carrot=(c.reactions.carrot||0)+1;
      await set(ref(db,"posts/"+threadId+"/"+cid),{...c,usersReact});
    };
    const sparkleBtn=document.createElement("button");
    sparkleBtn.textContent="âœ¨";
    sparkleBtn.onclick=async()=>{
      const usersReact=c.usersReact||{};
      if(usersReact[userId]?.sparkle) return alert("ã™ã§ã«æŠ¼ã—ãŸãƒšã‚³");
      usersReact[userId]={...usersReact[userId],sparkle:true};
      c.reactions.sparkle=(c.reactions.sparkle||0)+1;
      await set(ref(db,"posts/"+threadId+"/"+cid),{...c,usersReact});
    };
    const cancelReact=document.createElement("button");
    cancelReact.textContent="ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å–æ¶ˆ";
    cancelReact.onclick=async()=>{
      const usersReact=c.usersReact||{};
      if(!usersReact[userId]) return;
      if(usersReact[userId].carrot) c.reactions.carrot--;
      if(usersReact[userId].sparkle) c.reactions.sparkle--;
      delete usersReact[userId];
      await set(ref(db,"posts/"+threadId+"/"+cid),{...c,usersReact});
    };

    btnDiv.append(delBtn,banBtn,reportBtn,carrotBtn,sparkleBtn,cancelReact);
    div.appendChild(btnDiv);

    commentsDiv.appendChild(div);
  });
});
</script>

</body>
</html>
