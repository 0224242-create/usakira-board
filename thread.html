<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<style>
  body { font-family:sans-serif; background:#fafafa; padding:20px; transition:0.3s; }
  .dark { background:#1a1a1a; color:#fff; }
  textarea { width:100%; height:70px; }
  .reply { border-bottom:1px solid #ccc; padding:8px; margin:6px 0; }
  .delete { cursor:pointer; color:red; font-size:12px; }
</style>
</head>
<body>
<button id="toggleDark">ğŸŒ‘ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
<h2 id="title"></h2>
<div id="info"></div>
<hr>

<h3>è¿”ä¿¡</h3>
<textarea id="replyInput"></textarea><br>
<button onclick="sendReply()">æŠ•ç¨¿</button>
<hr>

<div id="replies"></div>
<div id="paging"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX",
  databaseURL: "XXXX",
  projectId: "XXXX",
  storageBucket: "XXXX",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
let dark = localStorage.dark === "true";
if(dark) document.body.classList.add("dark");
document.getElementById("toggleDark").onclick = () => {
  dark = !dark;
  localStorage.dark = dark;
  document.body.classList.toggle("dark");
};

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
let profile = {
  name: localStorage.name || "åã‚‚ãªãå…",
  icon: localStorage.icon || "usagi.png.jpeg"
};

// ã‚¹ãƒ¬IDå–å¾—
const url = new URLSearchParams(location.search);
const id = url.get("id");
if(!id) location.href = "index.html";

// ã‚¹ãƒ¬æƒ…å ±
onValue(ref(db,"threads/"+id), snap => {
  const v = snap.val();
  if(!v) return;
  title.innerText = v.title;
  info.innerHTML = `<img src="${v.icon}" width="32" height="32"> ${v.name}<br><br>${v.body}`;

  // éµã‚¹ãƒ¬
  if(v.pass){
    const p = prompt("ã“ã®ã‚¹ãƒ¬ã¯éµã¤ãã§ã™ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
    if(p !== v.pass) history.back();
  }
});

// BANèª­ã¿è¾¼ã¿
let banned = {};
onValue(ref(db,"ban"), snap => banned = snap.val() || {});

// æŠ•ç¨¿
function sendReply() {
  const text = replyInput.value.trim();
  if(!text) return;
  if(banned[profile.name]) return alert("ã‚ãªãŸã¯æ›¸ãè¾¼ã¿ç¦æ­¢ã§ã™");
  const r = ref(db,"replies/"+id);
  push(r,{
    name: profile.name,
    icon: profile.icon,
    text: text + " ãƒšã‚³",
    time: Date.now()
  });
  replyInput.value = "";
}

// ãƒšãƒ¼ã‚¸ãƒ³ã‚°
const PER = 20;
let page = 1;
onValue(ref(db,"replies/"+id), snap => {
  const data = snap.val() || {};
  let arr = Object.entries(data).sort((a,b)=>a[1].time-b[1].time);
  render(arr);
});
function render(arr){
  const start = (page-1)*PER;
  const pick = arr.slice(start,start+PER);
  replies.innerHTML = "";

  pick.forEach(([key,v])=>{
    if(banned[v.name]) return;
    let txt = v.text.replace(/https?:\/\/\S+/g, m=> `<a href="${m}" target="_blank">${m}</a>`);
    replies.insertAdjacentHTML("beforeend",
      `<div class="reply">
        <img src="${v.icon}" width="32" height="32">
        <b>${v.name}</b><br>${txt}<br>
        <span style="font-size:11px">${new Date(v.time).toLocaleString()}</span><br>
        <span class="delete" onclick="delReply('${key}','${v.name}')">å‰Šé™¤</span>
        <button onclick="banUser('${v.name}')">BAN</button>
      </div>`);
  });

  paging.innerHTML = "";
  const pages = Math.ceil(arr.length/PER);
  for(let i=1;i<=pages;i++){
    paging.insertAdjacentHTML("beforeend",
      `<button onclick="page=${i};render(arr)"> ${i} </button>`);
  }
  replies.scrollTop = replies.scrollHeight;
}

window.delReply = (key,name)=>{
  if(name !== profile.name && prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") !== "master") return;
  remove(ref(db,"replies/"+id+"/"+key));
};
window.banUser = name=>{
  if(prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") !== "master") return;
  update(ref(db,"ban"),{ [name]: true });
  alert(name + " ã‚’BANã—ã¾ã—ãŸ");
};

</script>
</body>
</html>
