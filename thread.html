<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s;
}
body.dark{background:#121212;color:#eaeaea}

.post{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:12px;
  margin:12px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
}
body.dark .post{background:#1b1b1b;border-color:#555}

.header{
  display:flex;
  align-items:center;
  gap:10px;
}
.icon{
  width:42px;height:42px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
}
.name{
  cursor:pointer;
  color:#ff4fa8;
  font-weight:bold;
}
.name:hover{text-decoration:underline}

.meta{font-size:.8rem;color:#888}
body.dark .meta{color:#aaa}

.actions{
  display:flex;
  justify-content:flex-end;
  gap:6px;
  margin-top:6px;
}

button{
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
}
body.dark button{background:#333;color:#eee;border:1px solid #666}

.reacts button{font-size:1.1rem}

.flash{
  animation:flash .6s infinite alternate;
}
@keyframes flash{
  from{box-shadow:0 0 5px #ff8cd1}
  to{box-shadow:0 0 16px #ff4fa8}
}
</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<h2 id="title"></h2>

<div id="posts"></div>

<hr>

<textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³" style="width:100%;height:80px"></textarea>
<button id="send">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
 authDomain:"keijiban-7c651.firebaseapp.com",
 databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
 projectId:"keijiban-7c651",
 storageBucket:"keijiban-7c651.firebasestorage.app",
 messagingSenderId:"342192640264",
 appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const params=new URLSearchParams(location.search);
const threadId=params.get("id");

const userId=localStorage.getItem("usakira_userId");
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

let isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ */
const d=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
 document.body.classList.add("dark"); d.textContent="â˜€ï¸";
}
d.onclick=()=>{
 const on=!document.body.classList.contains("dark");
 document.body.classList.toggle("dark");
 localStorage.setItem("usakira_dark",on);
 d.textContent=on?"â˜€ï¸":"ğŸŒ™";
};

/* ç®¡ç†äººãƒã‚§ãƒƒã‚¯ */
get(ref(db,"admins/"+userId)).then(s=>{
 if(s.exists()){
   isAdmin=true;
   localStorage.setItem("usakira_admin","true");
 }
});

/* BANãƒã‚§ãƒƒã‚¯ */
let banned=false;
onValue(ref(db,"bans/"+userId),s=>{
 banned=s.exists();
 document.getElementById("send").disabled=banned;
});

/* ã‚¹ãƒ¬æƒ…å ± */
onValue(ref(db,"threads/"+threadId),s=>{
 if(s.exists()) document.getElementById("title").textContent=s.val().title;
});

/* æŠ•ç¨¿ */
document.getElementById("send").onclick=async()=>{
 if(banned) return alert("BANä¸­ã¯æŠ•ç¨¿ã§ããªã„ãƒšã‚³");
 const text=document.getElementById("text").value.trim();
 if(!text) return;

 await push(ref(db,"posts/"+threadId),{
  text,
  name,
  icon,
  uid:userId,
  time:Date.now(),
  reacts:{}
 });
 document.getElementById("text").value="";
};

/* è¡¨ç¤º */
onValue(ref(db,"posts/"+threadId),snap=>{
 const box=document.getElementById("posts");
 box.innerHTML="";
 let idx=0;

 snap.forEach(pSnap=>{
  idx++;
  const p=pSnap.val();
  const pid=pSnap.key;

  const div=document.createElement("div");
  div.className="post";

  if(p.deleted){
   div.innerHTML="ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³";
   box.appendChild(div);
   return;
  }

  const reacts=p.reacts||{};
  const total=(reacts.sparkle||0)+(reacts.carrot||0);
  if(total>=5) div.classList.add("flash");

  div.innerHTML=`
   <div class="header">
    <img class="icon" src="${p.icon}" onerror="this.src='usagi.png.jpeg'">
    <div>
     <div class="name replyTarget" data-no="${idx}">
      #${idx} ${p.name}${banned?" {BAN}":""}
     </div>
     <div class="meta">
      ${new Date(p.time).toLocaleString()} / ID:${p.uid}
     </div>
    </div>
   </div>
   <p>${p.text} ãƒšã‚³</p>
   <div class="reacts">
    âœ¨ ${reacts.sparkle||0}
    ğŸ¥• ${reacts.carrot||0}
   </div>
  `;

  const acts=document.createElement("div");
  acts.className="actions";

  const r1=document.createElement("button");
  r1.textContent="âœ¨";
  r1.onclick=()=>set(ref(db,`posts/${threadId}/${pid}/reacts/sparkle`),(reacts.sparkle||0)+1);

  const r2=document.createElement("button");
  r2.textContent="ğŸ¥•";
  r2.onclick=()=>set(ref(db,`posts/${threadId}/${pid}/reacts/carrot`),(reacts.carrot||0)+1);

  acts.append(r1,r2);

  if(isAdmin){
   const del=document.createElement("button");
   del.textContent="å‰Šé™¤";
   del.onclick=()=>set(ref(db,`posts/${threadId}/${pid}/deleted`),true);

   const ban=document.createElement("button");
   ban.textContent="BAN";
   ban.onclick=()=>set(ref(db,"bans/"+p.uid),{name:p.name,icon:p.icon,time:Date.now()});

   acts.append(del,ban);
  }

  div.appendChild(acts);
  box.appendChild(div);
 });
});

/* >>è¿”ä¿¡ */
document.addEventListener("click",e=>{
 if(!e.target.classList.contains("replyTarget"))return;
 const no=e.target.dataset.no;
 const ta=document.getElementById("text");
 ta.value+=(ta.value?"\n":"")+`>>#${no} `;
 ta.focus();
});
</script>
</body>
</html>
