<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ã‚¹ãƒ¬ãƒƒãƒ‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea { width: 100%; height: 70px; }
    .post { padding: 10px; border-bottom: 1px solid #ccc; margin: 8px 0; }
    .reactions { margin-top: 6px; display: flex; gap: 10px; }
    .reaction-btn { cursor: pointer; font-size: 20px; }
  </style>
</head>
<body>
  <h1 id="threadTitle">ðŸ“Œ ã‚¹ãƒ¬ãƒƒãƒ‰</h1>

  <textarea id="name" placeholder="åå‰ï¼ˆç©ºç™½å¯ï¼‰"></textarea>
  <textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
  <button id="postBtn" style="margin-top: 10px;">æŠ•ç¨¿</button>

  <h2 style="margin-top:30px;">ðŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</h2>
  <div id="postList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
      authDomain: "keijiban-7c651.firebaseapp.com",
      databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
      projectId: "keijiban-7c651",
      storageBucket: "keijiban-7c651.firebasestorage.app",
      messagingSenderId: "342192640264",
      appId: "1:342192640264:web:a004a725b470741aaf1cbd",
      measurementId: "G-7E1BZ3BGBR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // URLã® ID ã‚’å–å¾—
    const params = new URLSearchParams(location.search);
    const threadId = params.get("id");

    // ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
    onValue(ref(db, `threads/${threadId}/title`), (snapshot) => {
      const title = snapshot.val();
      document.getElementById("threadTitle").innerText = `ðŸ“Œ ${title}`;
      document.title = title;
    });

    // æŠ•ç¨¿
    document.getElementById("postBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value || "åŒ¿å";
      const text = document.getElementById("text").value;
      if (!text) return;

      const newPost = push(ref(db, `threads/${threadId}/posts`));
      set(newPost, {
        name: name,
        text: text,
        createdAt: Date.now(),
        reactions: { carrot: 0, star: 0 }
      });

      document.getElementById("text").value = "";
    });

    // URL â†’ ãƒªãƒ³ã‚¯åŒ–
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
    onValue(ref(db, `threads/${threadId}/posts`), (snapshot) => {
      const data = snapshot.val();
      const list = document.getElementById("postList");
      list.innerHTML = "";
      if (!data) return;

      const posts = Object.entries(data).sort((a, b) => a[1].createdAt - b[1].createdAt);
      posts.forEach(([id, p]) => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<b>${p.name}</b><br>${linkify(p.text)}`;

        const reactions = document.createElement("div");
        reactions.className = "reactions";
        reactions.innerHTML = `
          <span class="reaction-btn" data-type="carrot">ðŸ¥• ${p.reactions?.carrot ?? 0}</span>
          <span class="reaction-btn" data-type="star">âœ¨ ${p.reactions?.star ?? 0}</span>
        `;

        reactions.querySelectorAll(".reaction-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const type = btn.dataset.type;
            const newCount = (p.reactions?.[type] ?? 0) + 1;
            update(ref(db, `threads/${threadId}/posts/${id}/reactions`), { [type]: newCount });
          });
        });

        div.appendChild(reactions);
        list.appendChild(div);
      });
    });
  </script>
</body>
</html>
