<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ - ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
 font-family:"Hiragino Kaku Gothic ProN",sans-serif;
 background:#fff0f8;
 padding:16px;
 color:#222;
}
body.dark{background:#121212;color:#eee}

.post{
 border:2px solid #ffc6e6;
 background:#fff7fc;
 border-radius:14px;
 padding:10px;
 margin-bottom:10px;
}
body.dark .post{background:#1b1b1b;border-color:#555}

.deleted{opacity:0.6;font-style:italic}

.name{font-weight:bold}
.ban{color:red;font-size:0.85em}

.actions{
 display:flex;
 justify-content:flex-end;
 gap:6px;
 margin-top:6px;
}

.react{cursor:pointer}
.highlight{animation:pop 0.4s}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

button{cursor:pointer}

#send:disabled{opacity:0.5}
</style>
</head>

<body>

<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>
<button id="darkBtn" style="float:right">ğŸŒ™</button>

<h2 id="title"></h2>

<div id="posts"></div>

<hr>

<textarea id="text" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³"></textarea><br>
<button id="send">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
 authDomain:"keijiban-7c651.firebaseapp.com",
 databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
 projectId:"keijiban-7c651"
});
const db=getDatabase(app);

/* UIDçµ±ä¸€ */
if(!localStorage.getItem("usakira_uid")){
 localStorage.setItem("usakira_uid",Math.random().toString(36).slice(2,10));
}
const uid=localStorage.getItem("usakira_uid");

/* ç®¡ç†äººåˆ¤å®š */
const isAdmin=location.search.includes("admin=1");

/* ãƒ€ãƒ¼ã‚¯ */
const dark=localStorage.getItem("dark")==="1";
if(dark)document.body.classList.add("dark");
darkBtn.onclick=()=>{
 document.body.classList.toggle("dark");
 localStorage.setItem("dark",document.body.classList.contains("dark")?"1":"0");
};

/* BANç›£è¦– */
let banMap={};
onValue(ref(db,"bans"),s=>{
 banMap=s.val()||{};
 send.disabled=!!banMap[uid];
});

/* ã‚¹ãƒ¬ID */
const id=new URLSearchParams(location.search).get("id");
const postRef=ref(db,"posts/"+id);
const reactRef=ref(db,"reactions/"+id);

onValue(ref(db,"threads/"+id),s=>{
 title.textContent=s.val()?.title||"";
});

/* è¡¨ç¤º */
onValue(postRef,snap=>{
 posts.innerHTML="";
 const data=snap.val()||{};
 let idx=0;

 for(const key in data){
  idx++;
  const p=data[key];
  const div=document.createElement("div");
  div.className="post";
  div.id="p"+idx;

  if(p.deleted){
   div.innerHTML=`<div class="deleted">ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³</div>`;
   posts.appendChild(div); continue;
  }

  const banned=!!banMap[p.uid];

  div.innerHTML=`
   <div class="name">
    #${idx} ${p.name||"åã‚‚ãªãå…"}
    ${banned?"<span class='ban'>{BAN}</span>":""}
   </div>
   <div>${linkJump(p.text)}</div>
   <div style="font-size:0.8em">
    ğŸ•’ ${new Date(p.time).toLocaleString()} / ğŸ†” ${p.uid}
   </div>
   <div>
    <span class="react" onclick="react('${key}','carrot')">ğŸ¥•</span>
    <span id="c_${key}">0</span>
    <span class="react" onclick="react('${key}','star')">âœ¨</span>
    <span id="s_${key}">0</span>
    <button onclick="unreact('${key}')">å–æ¶ˆ</button>
   </div>
  `;

  const act=document.createElement("div");
  act.className="actions";

  if(isAdmin){
   act.innerHTML=`
    <button onclick="del('${key}')">å‰Šé™¤</button>
    <button onclick="ban('${p.uid}','${p.name}')">BAN</button>
   `;
  }
  div.appendChild(act);
  posts.appendChild(div);
 }
});

/* æŠ•ç¨¿ */
send.onclick=()=>{
 if(send.disabled) return;
 push(postRef,{
  uid,
  name:"åã‚‚ãªãå…",
  text:text.value,
  time:Date.now()
 });
 text.value="";
};

/* å‰Šé™¤ */
window.del=k=>{
 set(ref(db,`posts/${id}/${k}/deleted`),true);
};

/* BAN */
window.ban=(u,n)=>{
 set(ref(db,"bans/"+u),{name:n,time:Date.now()});
};

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
window.react=(k,t)=>{
 set(ref(db,`reactions/${id}/${k}/${uid}/${t}`),true);
};
window.unreact=k=>{
 remove(ref(db,`reactions/${id}/${k}/${uid}`));
};

/* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º */
onValue(reactRef,s=>{
 const r=s.val()||{};
 for(const k in r){
  let c=0,sn=0;
  for(const u in r[k]){
   if(r[k][u].carrot)c++;
   if(r[k][u].star)sn++;
  }
  document.getElementById("c_"+k)?.textContent=c;
  document.getElementById("s_"+k)?.textContent=sn;
 }
});

/* >>#ã‚¸ãƒ£ãƒ³ãƒ— */
function linkJump(t){
 return t.replace(/>>#(\d+)/g,(m,n)=>`<a href="#p${n}">${m}</a>`);
}
</script>
</body>
</html>
