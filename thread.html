<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:0.25s}
body.dark{background:#121212;color:#eee}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer}
button:hover{opacity:0.85}
textarea,input{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
body.dark textarea,body.dark input{background:#222;color:#eee;border:1px solid #555}
.thread,.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 2px 6px rgba(255,150,210,0.25)}
body.dark .thread,body.dark .comment{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.thread.locked{background:#ccc;border-color:#999}
.flex{display:flex;align-items:center;gap:10px}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}
.icon{width:40px;height:40px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
body.dark .icon{border-color:#ff8cd1}
.comment p{margin:4px 0}
.meta{font-size:0.8rem;color:#aa7}
.reaction-btn{margin-left:4px}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitleHeader"></h1>

<div id="postBox">
<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
<button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>
</div>

<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
authDomain:"keijiban-7c651.firebaseapp.com",
databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
projectId:"keijiban-7c651",
storageBucket:"keijiban-7c651.firebasestorage.app",
messagingSenderId:"342192640264",
appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const nameInput=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const iconInput=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const now=!document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ID */
const urlParams=new URLSearchParams(window.location.search);
const threadId=urlParams.get("id");

/* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ */
const postBtn=document.getElementById("postBtn");
const commentInput=document.getElementById("commentInput");

async function checkBan(){
  const banSnap=await get(ref(db,"bans/"+userId));
  return banSnap.exists();
}

postBtn.onclick=async()=>{
  if(await checkBan()) return alert("BANã•ã‚Œã¦ã‚‹ãƒšã‚³");
  const text=commentInput.value.trim();
  if(!text) return;
  await push(ref(db,"posts/"+threadId),{
    uid:userId,name:nameInput,icon:iconInput,text,textTime:Date.now(),reactions:{carrot:0,star:0,total:0}
  });
  commentInput.value="";
};

/* ã‚¹ãƒ¬æƒ…å ±è¡¨ç¤º */
const threadTitleHeader=document.getElementById("threadTitleHeader");
onValue(ref(db,"threads/"+threadId),snap=>{
  const t=snap.val();
  if(!t) {threadTitleHeader.textContent="ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“";return;}
  threadTitleHeader.textContent=t.ownerName+(t.ownerId===userId?"â˜…":"")+(isAdmin&&t.ownerId===userId?"ğŸ‘‘":"")+": "+(t.title||"ï¼ˆç„¡é¡Œï¼‰");
});

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
const commentsDiv=document.getElementById("comments");
onValue(ref(db,"posts/"+threadId),snap=>{
  commentsDiv.innerHTML="";
  const posts=snap.val()||{};
  let i=1;
  for(const id in posts){
    const c=posts[id];
    const div=document.createElement("div");
    div.className="comment flex";
    let nameLabel=c.name;
    if(c.uid===c.ownerId) nameLabel+="â˜…";
    if(isAdmin&&c.uid===c.ownerId) nameLabel="ğŸ‘‘â˜…"+nameLabel;
    if(c.deleted) c.text="ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³";
    div.innerHTML=`
      <img class="icon" src="${c.icon||'usagi.png.jpeg'}">
      <div style="flex:1">
        <b>${i} ${nameLabel}</b>
        <p>${c.text} ãƒšã‚³</p>
        <p class="meta">${new Date(c.textTime).toLocaleString()} ID:${c.uid}</p>
      </div>
    `;
    const tools=document.createElement("div");
    tools.className="flex-end";

    /* ç®¡ç†äººã®ã¿ BAN/å‰Šé™¤ */
    if(isAdmin){
      const delBtn=document.createElement("button");
      delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=async()=>{
        await set(ref(db,"posts/"+threadId+"/"+id+"/deleted"),true);
      };
      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>{
        await set(ref(db,"bans/"+c.uid),{name:c.name,icon:c.icon,time:Date.now()});
        alert("BANã—ãŸãƒšã‚³");
      };
      tools.append(delBtn,banBtn);
    }

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    const carrotBtn=document.createElement("button");
    carrotBtn.textContent="ğŸ¥• "+c.reactions.carrot;
    carrotBtn.onclick=async()=>{
      const reacted=localStorage.getItem("react_"+id+"_carrot")==="true";
      if(reacted){
        c.reactions.carrot--; c.reactions.total--;
        localStorage.removeItem("react_"+id+"_carrot");
      } else {
        c.reactions.carrot++; c.reactions.total++;
        localStorage.setItem("react_"+id+"_carrot","true");
      }
      await set(ref(db,"posts/"+threadId+"/"+id+"/reactions"),c.reactions);
    };
    const starBtn=document.createElement("button");
    starBtn.textContent="âœ¨ "+c.reactions.star;
    starBtn.onclick=async()=>{
      const reacted=localStorage.getItem("react_"+id+"_star")==="true";
      if(reacted){
        c.reactions.star--; c.reactions.total--;
        localStorage.removeItem("react_"+id+"_star");
      } else {
        c.reactions.star++; c.reactions.total++;
        localStorage.setItem("react_"+id+"_star","true");
      }
      await set(ref(db,"posts/"+threadId+"/"+id+"/reactions"),c.reactions);
    };
    tools.append(carrotBtn,starBtn);
    div.appendChild(tools);
    commentsDiv.appendChild(div);
    i++;
  }
});
</script>
</body>
</html>
