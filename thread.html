<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ | ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
.comment{border:1px solid #ffc6e6;background:#fff7fc;border-radius:10px;padding:10px;margin:10px 0}
.flex{display:flex;align-items:center;gap:10px}
.icon{width:40px;height:40px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
.meta{font-size:0.8rem;color:#777}
</style>
</head>
<body>

<a href="index.html">â† æˆ»ã‚‹</a>

<h2 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­...</h2>
<div id="threadBody"></div>

<hr>

<h3>ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</h3>
<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­"></textarea>
<button id="sendBtn">é€ä¿¡</button>

<hr>

<h3>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
<div id="commentsBox">èª­ã¿è¾¼ã¿ä¸­...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== URLã‹ã‚‰IDå–å¾— ===== */
const params = new URLSearchParams(location.search);
const threadId = params.get("id");
if(!threadId){
  alert("ã‚¹ãƒ¬IDãŒãªã„ã‚ˆ");
  location.href="index.html";
}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ===== */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

const currentName=localStorage.getItem("usakira_name")||defaultName;
const currentIcon=localStorage.getItem("usakira_icon")||defaultIcon;

/* ===== ã‚¹ãƒ¬æƒ…å ±è¡¨ç¤º ===== */
onValue(ref(db,"threads/"+threadId), snap=>{
  const t=snap.val();
  if(!t){
    document.getElementById("threadTitle").innerText="ã‚¹ãƒ¬ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆ";
    return;
  }
  document.getElementById("threadTitle").innerText=t.title;
  document.getElementById("threadBody").innerText=t.body||"";
});

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡ï¼ˆè‡ªå‹•ãºã“åŒ–ï¼‰ ===== */
document.getElementById("sendBtn").onclick=async ()=>{
  const rawText=document.getElementById("commentInput").value.trim();
  if(!rawText) return;

  let text = rawText.endsWith("ãºã“") ? rawText : rawText + "ãºã“";

  await push(ref(db,"comments/"+threadId),{
    text:text,
    name:currentName,
    icon:currentIcon,
    time:Date.now()
  });

  document.getElementById("commentInput").value="";
};

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤ºï¼ˆéå»åˆ†ã‚‚å¼·åˆ¶ãºã“ï¼‰ ===== */
const commentsBox=document.getElementById("commentsBox");

onValue(ref(db,"comments/"+threadId), snap=>{
  commentsBox.innerHTML="";
  const data=snap.val();
  if(!data){
    commentsBox.innerHTML="<p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ã‚ˆ ğŸ°</p>";
    return;
  }

  const entries=Object.values(data)
    .sort((a,b)=>a.time-b.time);

  entries.forEach(c=>{
    let displayText = c.text.endsWith("ãºã“") ? c.text : c.text + "ãºã“";

    const div=document.createElement("div");
    div.className="comment";
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <strong>${c.name||defaultName}</strong>
      </div>
      <div>${displayText}</div>
      <div class="meta">${new Date(c.time).toLocaleString()}</div>
    `;
    commentsBox.appendChild(div);
  });
});
</script>

</body>
</html>
