<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s}
body.dark{background:#121212;color:#eee}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer}
textarea,input{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc}
body.dark textarea,body.dark input{background:#222;color:#eee;border-color:#555}
.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0}
body.dark .comment{background:#1b1b1b;border-color:#555}
.comment.admin{background:#fff3e0;border-color:#ffcc80}
body.dark .comment.admin{background:#2a2216}
.flex{display:flex;gap:10px}
.flex-end{display:flex;justify-content:flex-end;gap:6px}
.icon{width:40px;height:40px;border-radius:50%}
.comment a{color:#d22;text-decoration:underline}
.meta{font-size:.75rem;color:#aa7}
.uid{font-size:.7rem;color:#888}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitleHeader"></h1>

<div id="adminTools"></div>

<div id="lockBox" style="display:none">
  <input id="threadPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
  <button id="unlockBtn">ğŸ”“ å…¥å®¤</button>
</div>

<div id="postBox" style="display:none">
  <textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
  <button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>
</div>

<div id="comments" style="display:none"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
  getDatabase, ref, onValue, push, set, remove, runTransaction
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);
const userName = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
const userIcon = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";
const isAdmin = localStorage.getItem("usakira_admin")==="true";

const threadId = new URLSearchParams(location.search).get("id");

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
  document.body.classList.add("dark");
  darkToggle.textContent="â˜€ï¸";
}
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
};

/* BANãƒªã‚¹ãƒˆ */
let banList={};
onValue(ref(db,"bans"),snap=>banList=snap.val()||{});

/* URLãƒªãƒ³ã‚¯ */
const linkify=t=>t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>');

let threadData=null;

/* ã‚¹ãƒ¬æƒ…å ± */
onValue(ref(db,"threads/"+threadId),snap=>{
  threadData=snap.val();
  if(!threadData){document.body.innerHTML="ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";return;}

  threadTitleHeader.textContent =
    threadData.ownerName+"ï¼š"+(threadData.title||"ç„¡é¡Œ");

  if(isAdmin){
    const btn=document.createElement("button");
    btn.textContent="ğŸ—‘ ã‚¹ãƒ¬å‰Šé™¤";
    btn.onclick=async()=>{
      if(confirm("ã‚¹ãƒ¬ã¨å…¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        await remove(ref(db,"threads/"+threadId));
        await remove(ref(db,"posts/"+threadId));
        location.href="index.html";
      }
    };
    adminTools.appendChild(btn);
  }

  if(threadData.pass && !isAdmin){
    lockBox.style.display="block";
  }else unlock();
});

/* éµè§£é™¤ */
unlockBtn.onclick=()=>{
  if(threadPass.value===threadData.pass) unlock();
  else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
};

function unlock(){
  lockBox.style.display="none";
  postBox.style.display="block";
  comments.style.display="block";
  loadComments();
}

/* æŠ•ç¨¿ï¼ˆâ˜… commentCount +1 è¿½åŠ ï¼‰ */
postBtn.onclick=async()=>{
  if(banList[userId]) return alert("BANä¸­ã¯æŠ•ç¨¿ã§ãã¾ã›ã‚“");
  const t=commentInput.value.trim();
  if(!t) return;

  await push(ref(db,"posts/"+threadId),{
    uid:userId,name:userName,icon:userIcon,
    text:t,time:Date.now(),
    reactions:{carrot:0,star:0,total:0}
  });

  runTransaction(ref(db,"threads/"+threadId), data=>{
    if(!data) return data;
    data.commentCount = (data.commentCount || 0) + 1;
    return data;
  });

  commentInput.value="";
};

/* ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º */
function loadComments(){
onValue(ref(db,"posts/"+threadId),snap=>{
  comments.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([id,c],i)=>{
    if(c.deleted)return;

    let style="";
    if(c.reactions?.total>=10){
      style="background:linear-gradient(to right,red,orange,yellow,green,blue,indigo,violet);-webkit-background-clip:text;color:transparent";
    }else if(c.reactions?.total>=5){
      style="color:red";
    }

    const div=document.createElement("div");
    div.className="comment";
    if(isAdmin && c.uid===userId) div.classList.add("admin");

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon}">
        <div>
          <b>
            <span style="${c.uid===threadData.ownerId?'color:red':''}">
              ${i+1} ${c.name}
            </span>
            ${c.uid===threadData.ownerId?"â˜…":""}
            ${isAdmin && c.uid===userId?"ğŸ‘‘":""}
            ${banList[c.uid]?"ï¼ˆBANä¸­ï¼‰":""}
          </b>
          <div class="uid">ID: ${c.uid}</div>
          <p style="${style}">${linkify(c.text)} ãƒšã‚³</p>
          <div class="meta">${new Date(c.time).toLocaleString()}</div>
        </div>
      </div>
    `;

    const tools=document.createElement("div");
    tools.className="flex-end";

    ["carrot","star"].forEach(t=>{
      const b=document.createElement("button");
      b.textContent=(t==="carrot"?"ğŸ¥•":"âœ¨")+" "+(c.reactions?.[t]||0);
      b.onclick=async()=>{
        c.reactions[t]++;
        c.reactions.total++;

        await set(ref(db,"posts/"+threadId+"/"+id+"/reactions"),c.reactions);

        runTransaction(ref(db,"threads/"+threadId), data=>{
          if(!data) return data;
          data.reactionTotal = (data.reactionTotal || 0) + 1;
          return data;
        });
      };
      tools.appendChild(b);
    });

    const report=document.createElement("button");
    report.textContent="é€šå ±";
    report.onclick=()=>push(ref(db,"reports"),{
      threadId,postId:id,uid:c.uid,name:c.name,icon:c.icon,text:c.text,time:Date.now()
    });
    tools.appendChild(report);

    if(isAdmin){
      const del=document.createElement("button");
      del.textContent="å‰Šé™¤";
      del.onclick=()=>set(ref(db,"posts/"+threadId+"/"+id+"/deleted"),true);
      tools.appendChild(del);
    }

    div.appendChild(tools);
    comments.appendChild(div);
  });
});
}
</script>
</body>
</html>
