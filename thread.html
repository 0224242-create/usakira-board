<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ - ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee}
.threadBox{margin-bottom:20px;}
textarea,input{padding:6px;width:100%;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
body.dark textarea,body.dark input{background:#222;color:#eee;border:1px solid #555;}
button{padding:6px 10px;border-radius:6px;cursor:pointer;margin:2px;}
.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:12px;padding:10px;margin-bottom:8px;}
body.dark .comment{background:#1b1b1b;border-color:#555;}
.comment .flex{display:flex;align-items:center;justify-content:space-between}
.icon{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;margin-right:8px;}
body.dark .icon{border-color:#ff8cd1;}
.reactionBtn{margin-left:4px;}
.banLabel{color:red;font-weight:bold;margin-left:6px;}
.locked{background:#ccc;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>
<h1 id="threadTitleDisplay">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>
<div id="threadInfo" style="margin-bottom:20px;color:#888"></div>

<div id="comments"></div>

<div class="threadBox">
<h3>ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹</h3>
<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<button id="postComment">æŠ•ç¨¿</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, push, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const userIcon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

/* ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

/* ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º */
async function loadThread(){
  const tSnap = await get(ref(db,"threads/"+threadId));
  const t=tSnap.val();
  if(!t) return alert("ã‚¹ãƒ¬ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
  document.getElementById("threadTitleDisplay").textContent = t.title || "(ç„¡é¡Œ)";
  document.getElementById("threadInfo").textContent = `ä½œæˆè€…:${t.ownerName} ${t.pass?"ğŸ”’":""} | ${new Date(t.time).toLocaleString()}`;
}
loadThread();

/* ã‚³ãƒ¡ãƒ³ãƒˆæç”» */
const commentsEl=document.getElementById("comments");

async function loadComments(){
  commentsEl.innerHTML="";
  const postsSnap=await get(ref(db,"posts/"+threadId));
  const posts=postsSnap.val()||{};
  let idx=1;

  for(const pid in posts){
    const p=posts[pid];
    const div=document.createElement("div");
    div.className="comment";
    if(p.banned) div.classList.add("locked");

    const reactions=p.reactions||{};
    let reactTotal=0;
    for(const em in reactions) reactTotal+=Object.keys(reactions[em]).length;

    div.innerHTML=`
      <div class="flex">
        <div class="flex">
          <img class="icon" src="${p.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
          <b>#${idx} ${p.name||"åã‚‚ãªãå…"} ${p.banned?"{BAN}":""}</b>
        </div>
        <div style="font-size:0.8rem;color:#888">${new Date(p.time).toLocaleString()} | ID:${pid}</div>
      </div>
      <div style="margin-top:6px;">${p.text||""} ãƒšã‚³</div>
      <div>
        <button class="reactionBtn" data-em="ğŸ¥•">ğŸ¥• ${reactions['ğŸ¥•']?Object.keys(reactions['ğŸ¥•']).length:0}</button>
        <button class="reactionBtn" data-em="âœ¨">âœ¨ ${reactions['âœ¨']?Object.keys(reactions['âœ¨']).length:0}</button>
        <button class="reactionBtn" data-em="âŒ">å–æ¶ˆ</button>
        <button class="reportBtn">é€šå ±</button>
        ${userId===p.uid?' <button class="delBtn">å‰Šé™¤</button>':""}
      </div>
    `;
    commentsEl.appendChild(div);

    // åå¿œãƒœã‚¿ãƒ³å‡¦ç†
    div.querySelectorAll(".reactionBtn").forEach(btn=>{
      btn.onclick=async()=>{
        const em=btn.dataset.em;
        if(em==="âŒ"){
          await update(ref(db,"posts/"+threadId+"/"+pid+"/reactions"),{[userId]:null});
          loadComments(); return;
        }
        const snap=await get(ref(db,"posts/"+threadId+"/"+pid+"/reactions/"+em+"/"+userId));
        if(snap.exists()){
          alert("ã™ã§ã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¸ˆã¿");
          return;
        }
        await set(ref(db,"posts/"+threadId+"/"+pid+"/reactions/"+em+"/"+userId,true));
        loadComments();
      };
    });

    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const delBtn=div.querySelector(".delBtn");
    if(delBtn) delBtn.onclick=async()=>{
      if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await remove(ref(db,"posts/"+threadId+"/"+pid));
      loadComments();
    };

    // é€šå ±ãƒœã‚¿ãƒ³
    div.querySelector(".reportBtn").onclick=async()=>{
      const reason=prompt("é€šå ±ç†ç”±");
      if(!reason) return;
      const rKey = Date.now()+"_"+Math.random().toString(36).slice(2);
      await set(ref(db,"reports/"+rKey),{
        threadId,pid,userId,text:p.text,name:p.name,icon:p.icon,time:Date.now(),reason
      });
      alert("é€šå ±ã—ã¾ã—ãŸãƒšã‚³");
    };

    idx++;
  }
}

loadComments();

/* ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ */
document.getElementById("postComment").onclick=async()=>{
  const text=document.getElementById("commentText").value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");
  const bansSnap=await get(ref(db,"ban/"+userId));
  if(bansSnap.exists()) return alert("BANã•ã‚Œã¦ã„ã‚‹ãŸã‚æŠ•ç¨¿ã§ãã¾ã›ã‚“");
  await push(ref(db,"posts/"+threadId),{
    text,name:userName,icon:userIcon,time:Date.now(),uid:userId
  });
  document.getElementById("commentText").value="";
  loadComments();
};
</script>
</body>
</html>
