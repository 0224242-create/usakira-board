<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222}
body.dark{background:#121212;color:#eee}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer}
textarea,input{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc}
body.dark textarea,body.dark input{background:#222;color:#eee;border-color:#555}
.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0}
body.dark .comment{background:#1b1b1b;border-color:#555}
.flex{display:flex;gap:10px}
.flex-end{display:flex;justify-content:flex-end;gap:6px}
.icon{width:40px;height:40px;border-radius:50%}
.meta{font-size:.75rem;color:#aa7}
.uid{font-size:.7rem;color:#888}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitleHeader"></h1>

<div id="postBox" style="display:none">
  <textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
  <button id="postBtn">æŠ•ç¨¿ã™ã‚‹</button>
</div>

<div id="comments"></div>
<button id="loadMoreBtn" style="display:none">â¬‡ ã•ã‚‰ã«èª­ã‚€</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
  getDatabase, ref, onValue, push, set, get,
  query, orderByChild, limitToLast, endBefore
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);
const userName = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";

const threadId = new URLSearchParams(location.search).get("id");

const shownIds = new Set();
let oldestTime = Infinity;

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
  document.body.classList.add("dark");
  darkToggle.textContent="â˜€ï¸";
}
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
};

/* ã‚¹ãƒ¬æƒ…å ± */
onValue(ref(db,"threads/"+threadId),snap=>{
  const t=snap.val();
  if(!t){document.body.innerHTML="ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ";return;}
  threadTitleHeader.textContent=t.ownerName+"ï¼š"+(t.title||"ç„¡é¡Œ");
  postBox.style.display="block";
});

/* æŠ•ç¨¿ */
postBtn.onclick=async()=>{
  const t=commentInput.value.trim();
  if(!t)return;
  await push(ref(db,"posts/"+threadId),{
    uid:userId,
    name:userName,
    text:t,
    time:Date.now(),
    reactions:{carrot:0,star:0,total:0}
  });
  commentInput.value="";
};

/* æœ€æ–°50ä»¶ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  */
onValue(
  query(ref(db,"posts/"+threadId),orderByChild("time"),limitToLast(50)),
  snap=>{
    Object.entries(snap.val()||{}).forEach(([id,c])=>{
      if(shownIds.has(id))return;
      addComment(id,c,true);
    });
  }
);

/* ã•ã‚‰ã«èª­ã‚€ */
loadMoreBtn.onclick=async()=>{
  const q=query(
    ref(db,"posts/"+threadId),
    orderByChild("time"),
    endBefore(oldestTime),
    limitToLast(50)
  );
  const snap=await get(q);
  if(!snap.exists()){loadMoreBtn.style.display="none";return;}
  Object.entries(snap.val()).forEach(([id,c])=>{
    if(shownIds.has(id))return;
    addComment(id,c,false);
  });
};

/* æç”» */
function addComment(id,c,append){
  shownIds.add(id);
  oldestTime=Math.min(oldestTime,c.time);

  const div=document.createElement("div");
  div.className="comment";
  div.innerHTML=`
    <b>${c.name}</b>
    <div class="uid">ID:${c.uid}</div>
    <p>${c.text} ãƒšã‚³</p>
    <div class="meta">${new Date(c.time).toLocaleString()}</div>
  `;

  if(append) comments.appendChild(div);
  else comments.prepend(div);

  loadMoreBtn.style.display="block";
}
</script>
</body>
</html>
