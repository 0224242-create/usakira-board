<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s;
}
body.dark{background:#121212;color:#eaeaea}

.post{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:12px;
  margin:12px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
}
body.dark .post{background:#1b1b1b;border-color:#555}

.header{display:flex;gap:10px;align-items:center}
.icon{
  width:42px;height:42px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
}
.name{
  cursor:pointer;
  color:#ff4fa8;
  font-weight:bold;
}
.name:hover{text-decoration:underline}

.meta{font-size:.8rem;color:#888}
body.dark .meta{color:#aaa}

.actions{
  display:flex;
  justify-content:flex-end;
  gap:6px;
  margin-top:6px;
}

button{
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
}
body.dark button{background:#333;color:#eee;border:1px solid #666}

.flash{
  animation:flash .6s infinite alternate;
}
@keyframes flash{
  from{box-shadow:0 0 6px #ff8cd1}
  to{box-shadow:0 0 16px #ff4fa8}
}

.jump{
  animation:jump .8s;
}
@keyframes jump{
  from{background:#fff0a6}
  to{background:inherit}
}

.replyLink{
  color:#4aa;
  cursor:pointer;
}
.replyLink:hover{text-decoration:underline}
</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>
<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>

<h2 id="title"></h2>
<div id="posts"></div>

<hr>

<textarea id="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ããƒšã‚³" style="width:100%;height:80px"></textarea>
<button id="send">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
 authDomain:"keijiban-7c651.firebaseapp.com",
 databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
 projectId:"keijiban-7c651",
 storageBucket:"keijiban-7c651.firebasestorage.app",
 messagingSenderId:"342192640264",
 appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const tid=new URLSearchParams(location.search).get("id");
const uid=localStorage.getItem("usakira_userId");
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";

/* ãƒ€ãƒ¼ã‚¯ */
const d=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
 document.body.classList.add("dark"); d.textContent="â˜€ï¸";
}
d.onclick=()=>{
 const on=!document.body.classList.contains("dark");
 document.body.classList.toggle("dark");
 localStorage.setItem("usakira_dark",on);
 d.textContent=on?"â˜€ï¸":"ğŸŒ™";
};

/* BAN */
let banned=false;
onValue(ref(db,"bans/"+uid),s=>{
 banned=s.exists();
 document.getElementById("send").disabled=banned;
});

/* ã‚¹ãƒ¬ */
onValue(ref(db,"threads/"+tid),s=>{
 if(s.exists()) document.getElementById("title").textContent=s.val().title;
});

/* æŠ•ç¨¿ */
send.onclick=async()=>{
 if(banned) return alert("BANä¸­ã¯æŠ•ç¨¿ã§ããªã„ãƒšã‚³");
 const t=text.value.trim();
 if(!t) return;
 await push(ref(db,"posts/"+tid),{
  text:t,
  name,icon,uid,time:Date.now(),
  reacts:{sparkle:{},carrot:{}}
 });
 text.value="";
};

/* è¡¨ç¤º */
onValue(ref(db,"posts/"+tid),snap=>{
 posts.innerHTML="";
 let idx=0;
 snap.forEach(ps=>{
  idx++;
  const p=ps.val(),pid=ps.key;
  const div=document.createElement("div");
  div.className="post";
  div.id="p"+idx;

  if(p.deleted){
   div.textContent="ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³";
   posts.appendChild(div);return;
  }

  const sp=p.reacts?.sparkle||{};
  const ca=p.reacts?.carrot||{};
  const total=Object.keys(sp).length+Object.keys(ca).length;
  if(total>=5) div.classList.add("flash");

  const body=p.text.replace(/>>#(\d+)/g,
    (_,n)=>`<span class="replyLink" data-jump="${n}">>>#${n}</span>`
  );

  div.innerHTML=`
  <div class="header">
   <img class="icon" src="${p.icon}" onerror="this.src='usagi.png.jpeg'">
   <div>
    <div class="name replyTarget" data-no="${idx}">
     #${idx} ${p.name}${banned?" {BAN}":""}
    </div>
    <div class="meta">${new Date(p.time).toLocaleString()} / ID:${p.uid}</div>
   </div>
  </div>
  <p>${body} ãƒšã‚³</p>
  <div>âœ¨ ${Object.keys(sp).length}ã€€ğŸ¥• ${Object.keys(ca).length}</div>
  `;

  const a=document.createElement("div");
  a.className="actions";

  const sBtn=document.createElement("button");
  sBtn.textContent=sp[uid]?"âœ¨å–æ¶ˆ":"âœ¨";
  sBtn.onclick=()=>sp[uid]
    ?remove(ref(db,`posts/${tid}/${pid}/reacts/sparkle/${uid}`))
    :set(ref(db,`posts/${tid}/${pid}/reacts/sparkle/${uid}`),true);

  const cBtn=document.createElement("button");
  cBtn.textContent=ca[uid]?"ğŸ¥•å–æ¶ˆ":"ğŸ¥•";
  cBtn.onclick=()=>ca[uid]
    ?remove(ref(db,`posts/${tid}/${pid}/reacts/carrot/${uid}`))
    :set(ref(db,`posts/${tid}/${pid}/reacts/carrot/${uid}`),true);

  a.append(sBtn,cBtn);
  div.appendChild(a);
  posts.appendChild(div);
 });
});

/* >>è‡ªå‹• */
document.addEventListener("click",e=>{
 if(e.target.classList.contains("replyTarget")){
  text.value+=(text.value?"\n":"")+`>>#${e.target.dataset.no} `;
  text.focus();
 }
 if(e.target.classList.contains("replyLink")){
  const t=document.getElementById("p"+e.target.dataset.jump);
  if(t){t.classList.add("jump");t.scrollIntoView({behavior:"smooth"});}
 }
});
</script>
</body>
</html>
