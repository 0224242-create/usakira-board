<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
}
.comment{
  border:1px solid #ffc6e6;
  border-radius:10px;
  padding:10px;
  margin:10px 0;
  background:#fff;
}
.reply{
  background:#f0f0ff;
}
button{
  margin:4px;
}
.anchor{
  color:#4a6cff;
  cursor:pointer;
}
</style>
</head>

<body>

<a href="index.html">â† æˆ»ã‚‹</a>

<h2 id="threadTitle"></h2>

<div id="comments"></div>

<hr>

<textarea id="commentText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<button id="sendComment">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, update, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */
const params=new URLSearchParams(location.search);
const threadId=params.get("id");
if(!threadId) location.href="index.html";

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const userId=localStorage.getItem("uid");
const userName=localStorage.getItem("name")||"åã‚‚ãªãå…";
const userIcon=localStorage.getItem("icon")||"usagi.png.jpeg";
const isAdmin=localStorage.getItem("admin")==="1";

/* ã‚¹ãƒ¬æƒ…å ±å–å¾— */
let threadData=null;
const threadRef=ref(db,"threads/"+threadId);

get(threadRef).then(snap=>{
  threadData=snap.val();
  if(!threadData) location.href="index.html";
  document.getElementById("threadTitle").textContent=threadData.title;
});

/* ã‚³ãƒ¡ãƒ³ãƒˆ */
const commentsRef=ref(db,"comments/"+threadId);
let commentArr=[];

onValue(commentsRef,snap=>{
  commentArr=Object.entries(snap.val()||{});
  renderComments();
});

function renderComments(){
  const box=document.getElementById("comments");
  box.innerHTML="";
  let number=1;

  for(const [id,c] of commentArr){
    if(c.removed) continue;

    const div=document.createElement("div");
    div.className="comment";
    div.id="c"+number;

    const isOwner=c.userId===threadData.ownerId;

    let mark="";
    if(isAdmin) mark+="ğŸ‘‘";
    if(isOwner) mark+="â˜…";

    div.innerHTML=`
      <b>${number}</b> ${c.name}${mark}<br>
      ${formatText(c.text)}ãƒšã‚³<br>
      <small>${new Date(c.time).toLocaleString()}</small><br>
      ğŸ‘ ${c.likes?Object.keys(c.likes).length:0}
    `;

    /* è¿”ä¿¡ãƒœã‚¿ãƒ³ */
    const replyBtn=document.createElement("button");
    replyBtn.textContent="è¿”ä¿¡";
    replyBtn.onclick=()=>{
      document.getElementById("commentText").value+=">>"+number+"\n";
      document.getElementById("commentText").focus();
    };
    div.appendChild(replyBtn);

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    const likeBtn=document.createElement("button");
    likeBtn.textContent="ğŸ‘";
    likeBtn.onclick=()=>{
      const likeRef=ref(db,"comments/"+threadId+"/"+id+"/likes/"+userId);
      if(c.likes && c.likes[userId]){
        remove(likeRef);
      }else{
        update(likeRef,true);
      }
    };
    div.appendChild(likeBtn);

    /* é€šå ± */
    const reportBtn=document.createElement("button");
    reportBtn.textContent="é€šå ±";
    reportBtn.onclick=async()=>{
      const reportRef=ref(db,"reports/"+threadId+"/"+id+"/"+userId);
      const snap=await get(reportRef);
      if(snap.exists()){
        alert("é€šå ±æ¸ˆã¿");
      }else{
        update(reportRef,true);
        alert("é€šå ±ã—ãŸ");
      }
    };
    div.appendChild(reportBtn);

    /* ç®¡ç†äººå‰Šé™¤ */
    if(isAdmin){
      const delBtn=document.createElement("button");
      delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=()=>{
        update(ref(db,"comments/"+threadId+"/"+id),{removed:true});
      };
      div.appendChild(delBtn);

      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=()=>{
        update(ref(db,"bans/"+c.userId),true);
        alert("BANã—ãŸ");
      };
      div.appendChild(banBtn);
    }

    box.appendChild(div);
    number++;
  }
}

/* ã‚¢ãƒ³ã‚«ãƒ¼å¤‰æ› */
function formatText(text){
  return text.replace(/>>(\d+)/g,(match,p1)=>{
    return `<span class="anchor" onclick="document.getElementById('c${p1}').scrollIntoView({behavior:'smooth'})">>>${p1}</span>`;
  }).replace(/\n/g,"<br>");
}

/* æŠ•ç¨¿ */
document.getElementById("sendComment").onclick=async()=>{
  const text=document.getElementById("commentText").value.trim();
  if(!text) return;

  const banSnap=await get(ref(db,"bans/"+userId));
  if(banSnap.exists()){
    alert("ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  await push(commentsRef,{
    text,
    name:userName,
    icon:userIcon,
    userId,
    time:Date.now(),
    removed:false
  });

  document.getElementById("commentText").value="";
};
</script>
</body>
</html>
