<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ã‚¹ãƒ¬ãƒƒãƒ‰ - ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  padding:20px;
  background:#fff0f8;
  color:#222;
  transition:.25s;
}
body.dark{background:#121212;color:#eaeaea}

.post{
  border:1px solid #ffd4ea;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  background:#fff;
}
body.dark .post{background:#1e1e1e;border-color:#555}

/* ã‚¹ãƒ¬ä¸» */
.post.ownerPost{
  border-left:6px solid #ff69b4;
  padding-left:8px;
}

/* ç®¡ç†äºº */
.post.adminPost{
  background:linear-gradient(135deg,rgba(255,215,120,.25),rgba(255,240,200,.15));
  border-color:#f5b400;
}
body.dark .post.adminPost{
  background:linear-gradient(135deg,rgba(180,140,40,.25),rgba(120,90,20,.15));
}

/* åå‰ */
.adminName{color:#f5b400;font-weight:bold}

.icon{width:36px;height:36px;border-radius:50%;vertical-align:middle;margin-right:6px}
.meta{font-size:13px;color:#666}
body.dark .meta{color:#bbb}

.ownerMark{color:#ff69b4;font-weight:bold}
.adminMark{color:#f5b400;font-weight:bold}

button{padding:6px 10px;margin:4px;border-radius:4px;cursor:pointer}
body.dark button{background:#333;color:#eee;border:1px solid #666}

.postImg{max-width:200px;margin-top:6px;border-radius:6px}
</style>
</head>

<body>
<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>

<h1 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h1>
<button onclick="location.href='index.html'">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>
<div id="threadInfo" class="meta"></div>
<hr>

<textarea id="replyText" style="width:100%;height:80px"></textarea><br>
<input type="file" id="replyFile" accept="image/*"><br>
<button id="postBtn">æŠ•ç¨¿</button>
<hr>

<div id="posts"></div>
<div id="paging"></div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {getDatabase,ref,onValue,push,set,remove,get} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
import {getStorage,ref as sRef,uploadBytes,getDownloadURL} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";

const app=initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain:"keijiban-7c651.firebaseapp.com",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId:"keijiban-7c651",
  storageBucket:"keijiban-7c651.firebasestorage.app",
  appId:"1:342192640264:web:a004a725b470741aaf1cbd"
});
const db=getDatabase(app);
const storage=getStorage(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const d=localStorage.getItem("usakira_dark")==="true";
if(d)document.body.classList.add("dark");
darkToggle.textContent=d?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* æ—¥æ›¿ã‚ã‚ŠID */
function dailyId(uid,time){
  const k=uid+new Date(time).toDateString();
  let h=0;for(let c of k){h=(h<<5)-h+c.charCodeAt(0);h|=0;}
  return Math.abs(h).toString(36).slice(0,8);
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const uid=localStorage.getItem("uid")||("u_"+Math.random().toString(36).slice(2));
localStorage.setItem("uid",uid);
const name=localStorage.getItem("name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("icon")||"usagi.png.jpeg";

/* ã‚¹ãƒ¬ */
const tid=new URLSearchParams(location.search).get("id");
let ownerId="";
onValue(ref(db,`threads/${tid}`),s=>{
  const t=s.val();
  if(!t)return;
  ownerId=t.ownerId||"";
  threadTitle.textContent=t.title||"ï¼ˆç„¡é¡Œï¼‰";
  threadInfo.innerHTML=`<img class="icon" src="${t.ownerIcon||icon}"> by ${t.ownerName||name}`;
});

/* æŠ•ç¨¿è¡¨ç¤º */
onValue(ref(db,`posts/${tid}`),s=>{
  posts.innerHTML="";
  const arr=Object.entries(s.val()||{});
  arr.forEach(([id,p],i)=>{
    const div=document.createElement("div");
    div.className="post";
    if(p.uid===ownerId)div.classList.add("ownerPost");
    if(localStorage.getItem("usakira_isAdmin")==="true")div.classList.add("adminPost");

    const mark=p.uid===ownerId?' <span class="ownerMark">â˜…</span>':'';
    const admin=localStorage.getItem("usakira_isAdmin")==="true"
      ?' <span class="adminMark">ğŸ‘‘</span>':'';

    div.innerHTML=`
      <div>
        <img class="icon" src="${p.icon||icon}">
        <strong class="${admin?'adminName':''}">${p.name||name}</strong>
        <span class="meta">(ID:${dailyId(p.uid,p.time)}${mark}${admin})</span>
      </div>
      <div>${p.text||""}</div>
      ${p.img?`<img src="${p.img}" class="postImg">`:""}
    `;
    posts.appendChild(div);
  });
});

/* æŠ•ç¨¿ */
postBtn.onclick=async()=>{
  let text=replyText.value.trim();
  if(text&&!text.endsWith("ãƒšã‚³"))text+=" ãƒšã‚³";
  const file=replyFile.files[0];
  let img=null;
  if(file){
    const r=sRef(storage,`img/${tid}/${Date.now()}_${file.name}`);
    await uploadBytes(r,file);
    img=await getDownloadURL(r);
  }
  await push(ref(db,`posts/${tid}`),{uid,name,icon,text,img,time:Date.now()});
  replyText.value="";replyFile.value="";
};
</script>
</body>
</html>
