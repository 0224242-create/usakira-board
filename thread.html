<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
.post{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:12px;margin:12px 0;position:relative}
.meta{font-size:0.8rem;color:#777}
.icon{width:36px;height:36px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
.flex{display:flex;align-items:center;gap:8px}
.deleteBtn{
  position:absolute;
  right:10px;
  top:10px;
  font-size:0.75rem;
  background:#ff8ab5;
  border:none;
  color:white;
}
a{color:#d22;word-break:break-all;}
</style>
</head>
<body>

<button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>

<h2 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
<div id="threadBody"></div>

<hr>

<h3>æŠ•ç¨¿ã™ã‚‹</h3>
<textarea id="postText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã"></textarea>
<button id="postBtn">æŠ•ç¨¿</button>

<hr>

<h3>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
<div id="postsBox">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== ã‚¹ãƒ¬ID ===== */
const params = new URLSearchParams(location.search);
const threadId = params.get("id");
if(!threadId){
  document.body.innerHTML="ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒã‚ã‚Šã¾ã›ã‚“";
  throw new Error("threadId null");
}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ===== */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

let userId=localStorage.getItem("usakira_userId");
if(!userId){
  userId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId",userId);
}

const userName=localStorage.getItem("usakira_name")||defaultName;
const userIcon=localStorage.getItem("usakira_icon")||defaultIcon;

/* ===== URLãƒªãƒ³ã‚¯å¤‰æ› ===== */
function linkify(text){
  const urlRegex=/https?:\/\/[^\s]+/g;
  return text.replace(urlRegex, url =>
    `<a href="${url}" target="_blank">${url}</a>`
  );
}

/* ===== ã‚¹ãƒ¬è¡¨ç¤º ===== */
onValue(ref(db,"threads/"+threadId), snap=>{
  const data=snap.val();
  if(!data){
    document.getElementById("threadTitle").innerText="ã‚¹ãƒ¬ãŒå­˜åœ¨ã—ã¾ã›ã‚“";
    return;
  }
  document.getElementById("threadTitle").innerText=data.title;
  document.getElementById("threadBody").innerText=data.body||"";
});

/* ===== æŠ•ç¨¿ï¼ˆè‡ªå‹•ãºã“ï¼‰ ===== */
document.getElementById("postBtn").onclick=async()=>{
  const raw=document.getElementById("postText").value.trim();
  if(!raw) return alert("å†…å®¹ã‚’æ›¸ã„ã¦ã­");

  const text = raw.endsWith("ãºã“") ? raw : raw+"ãºã“";

  await push(ref(db,"posts/"+threadId),{
    text:text,
    name:userName,
    icon:userIcon,
    uid:userId,
    time:Date.now()
  });

  document.getElementById("postText").value="";
};

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º ===== */
const postsBox=document.getElementById("postsBox");

onValue(ref(db,"posts/"+threadId), snap=>{
  try{
    postsBox.innerHTML="";
    const data=snap.val();
    if(!data){
      postsBox.innerHTML="<p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ã‚ˆ ğŸ°</p>";
      return;
    }

    Object.entries(data)
      .sort((a,b)=>(a[1].time||0)-(b[1].time||0))
      .forEach(([id,p])=>{

        const safeText = (p.text||"").endsWith("ãºã“")
          ? p.text
          : (p.text||"")+"ãºã“";

        const div=document.createElement("div");
        div.className="post";

        div.innerHTML=`
          <div class="flex">
            <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
            <div>
              <div><strong>${p.name||defaultName}</strong></div>
              <div class="meta">${p.time ? new Date(p.time).toLocaleString() : ""}</div>
            </div>
          </div>
          <p>${linkify(safeText)}</p>
        `;

        if(p.uid===userId){
          const delBtn=document.createElement("button");
          delBtn.textContent="å‰Šé™¤";
          delBtn.className="deleteBtn";
          delBtn.onclick=()=>{
            if(confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿ")){
              remove(ref(db,"posts/"+threadId+"/"+id));
            }
          };
          div.appendChild(delBtn);
        }

        postsBox.appendChild(div);
      });

  }catch(e){
    console.error(e);
    postsBox.innerHTML="<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ âš </p>";
  }
});
</script>
</body>
</html>
