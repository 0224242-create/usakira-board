<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
.post{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:12px;margin:12px 0}
.meta{font-size:0.8rem;color:#777}
.icon{width:36px;height:36px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
.flex{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>

<button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>

<h2 id="threadTitle">èª­ã¿è¾¼ã¿ä¸­â€¦</h2>
<div id="threadBody"></div>

<hr>

<h3>æŠ•ç¨¿ã™ã‚‹</h3>
<textarea id="postText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã"></textarea>
<button id="postBtn">æŠ•ç¨¿</button>

<hr>

<h3>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
<div id="postsBox">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script type="module">

function safe(fn){
  try{ fn(); }
  catch(e){ console.error(e); }
}

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== ã‚¹ãƒ¬IDå–å¾— ===== */
const params = new URLSearchParams(location.search);
const threadId = params.get("id");

if(!threadId){
  document.body.innerHTML="ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒã‚ã‚Šã¾ã›ã‚“";
}

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ===== */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

const userName=localStorage.getItem("usakira_name")||defaultName;
const userIcon=localStorage.getItem("usakira_icon")||defaultIcon;

/* ===== ã‚¹ãƒ¬æƒ…å ±è¡¨ç¤º ===== */
safe(()=>{
  onValue(ref(db,"threads/"+threadId), snap=>{
    const data=snap.val();
    if(!data){
      document.getElementById("threadTitle").innerText="ã‚¹ãƒ¬ãŒå­˜åœ¨ã—ã¾ã›ã‚“";
      return;
    }

    document.getElementById("threadTitle").innerText=data.title;
    document.getElementById("threadBody").innerText=data.body||"";
  });
});

/* ===== æŠ•ç¨¿å‡¦ç† ===== */
document.getElementById("postBtn").onclick=()=>{
  safe(async ()=>{
    const text=document.getElementById("postText").value.trim();
    if(!text) return alert("å†…å®¹ã‚’æ›¸ã„ã¦ã­");

    await push(ref(db,"posts/"+threadId),{
      text:text,
      name:userName,
      icon:userIcon,
      time:Date.now()
    });

    document.getElementById("postText").value="";
  });
};

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ ===== */
const postsBox=document.getElementById("postsBox");

safe(()=>{
  onValue(ref(db,"posts/"+threadId), snap=>{
    postsBox.innerHTML="";

    const data=snap.val();
    if(!data){
      postsBox.innerHTML="<p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ã‚ˆ ğŸ°</p>";
      return;
    }

    const entries=Object.entries(data)
      .sort((a,b)=>a[1].time-b[1].time);

    entries.forEach(([id,p])=>{
      const div=document.createElement("div");
      div.className="post";

      div.innerHTML=`
        <div class="flex">
          <img class="icon" src="${p.icon||defaultIcon}" onerror="this.src='${defaultIcon}'">
          <div>
            <div><strong>${p.name}</strong></div>
            <div class="meta">${new Date(p.time).toLocaleString()}</div>
          </div>
        </div>
        <p>${p.text}</p>
      `;

      postsBox.appendChild(div);
    });
  }, err=>{
    postsBox.innerHTML="âš  èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ«ç¢ºèªï¼‰";
    console.error(err);
  });
});

</script>
</body>
</html>
