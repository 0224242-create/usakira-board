<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;padding:20px;background:#fff0f8;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1,h2{margin-top:0;}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer;}
input,textarea{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
body.dark input,body.dark textarea{background:#222;color:#eee;border:1px solid #555;}
.thread,.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 2px 6px rgba(255,150,210,.25);}
body.dark .thread,body.dark .comment{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,.3);}
.thread h3 a{color:#ff4fa8;text-decoration:none;}
body.dark .thread h3 a{color:#ff8cd1;}
.flex{display:flex;align-items:center;gap:10px;}
.column{display:flex;flex-direction:column;}
.icon{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;}
body.dark .icon{border-color:#ff8cd1;}
.tools{display:flex;justify-content:flex-end;gap:4px;margin-top:4px;}
.reactions button{margin-right:4px;}
.comment.highlight{border-color:#ff6;font-weight:bold;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1 id="threadTitleHeader">ã‚¹ãƒ¬ãƒƒãƒ‰</h1>

<div id="threadBodyDiv"></div>

<hr>
<h2>ã‚³ãƒ¡ãƒ³ãƒˆ</h2>

<div id="comments"></div>

<h3>ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<textarea id="commentInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡"></textarea>
<button id="postComment">æŠ•ç¨¿</button>

<hr>
<button id="backBtn">æ²ç¤ºæ¿ã«æˆ»ã‚‹</button>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ç®¡ç†äººãƒ•ãƒ©ã‚° */
const isAdmin = localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId = localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬ãƒƒãƒ‰IDå–å¾— */
const params = new URLSearchParams(location.search);
const threadId = params.get("id");

/* DOM */
const threadTitleHeader = document.getElementById("threadTitleHeader");
const threadBodyDiv = document.getElementById("threadBodyDiv");
const commentsDiv = document.getElementById("comments");
const nameInput = document.getElementById("nameInput");
const iconInput = document.getElementById("iconInput");
const commentInput = document.getElementById("commentInput");
const postCommentBtn = document.getElementById("postComment");
const backBtn = document.getElementById("backBtn");
const adminBtn = document.getElementById("adminBtn");

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
nameInput.value = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
iconInput.value = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";

/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
backBtn.onclick = ()=>location.href="index.html";

/* ç®¡ç†ãƒšãƒ¼ã‚¸ãƒœã‚¿ãƒ³ */
adminBtn.onclick=()=>{
  if(!isAdmin){ alert("ç®¡ç†è€…ã˜ã‚ƒãªã„ãƒšã‚³"); return; }
  location.href="import.html";
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±å–å¾— */
async function loadThread(){
  const tSnap = await get(ref(db,`threads/${threadId}`));
  const tData = tSnap.val();
  if(!tData){ threadTitleHeader.textContent="ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“"; return; }
  threadTitleHeader.textContent = tData.title || "ï¼ˆç„¡é¡Œï¼‰";
  threadBodyDiv.textContent = tData.body || "";
}

/* ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ï¼†è¡¨ç¤º */
async function loadComments(){
  commentsDiv.innerHTML="";
  const postsSnap = await get(ref(db,`posts/${threadId}`));
  const posts = postsSnap.val()||{};
  const bansSnap = await get(ref(db,"bans"));
  const bans = bansSnap.val()||{};

  const commentsArr = Object.entries(posts).sort((a,b)=> (a[1].time||0)-(b[1].time||0));
  let idx=1;
  for(const [cid, c] of commentsArr){
    const isBanned = bans[c.uid] ? true:false;
    const div = document.createElement("div");
    div.className="comment column";
    if(c.reactions && (Object.keys(c.reactions).length>=3)) div.classList.add("highlight");

    const userDisplay = c.name + (isBanned?" {BAN}":"");

    const reactions = c.reactions||{};
    const carrot = reactions["ğŸ¥•"]||0;
    const star = reactions["âœ¨ï¸"]||0;

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${c.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
        <div style="flex:1">
          <b>#${idx} ${userDisplay}</b> <span style="font-size:.8rem;color:#888">(${new Date(c.time).toLocaleString()})</span>
          <p>${c.text||""} ãƒšã‚³</p>
          <div class="reactions" style="font-size:.9rem">
            ğŸ¥• ${carrot} âœ¨ï¸ ${star}
          </div>
        </div>
      </div>
    `;

    /* å³ç«¯ãƒœã‚¿ãƒ³ */
    const tools = document.createElement("div");
    tools.className="tools";

    /* é€šå ±ãƒœã‚¿ãƒ³ */
    const reportBtn = document.createElement("button");
    reportBtn.textContent="é€šå ±";
    reportBtn.onclick=async()=>{
      const rid = "r_"+Math.random().toString(36).slice(2);
      await set(ref(db,`reports/${rid}`),{
        threadId:threadId,
        postId:cid,
        userId:c.uid,
        name:c.name,
        icon:c.icon,
        text:c.text,
        time:Date.now()
      });
      alert("é€šå ±ã—ã¾ã—ãŸ");
    };
    tools.appendChild(reportBtn);

    /* ç®¡ç†è€…ç”¨å‰Šé™¤/BAN */
    if(isAdmin){
      const delBtn=document.createElement("button");
      delBtn.textContent="å‰Šé™¤";
      delBtn.onclick=async()=>{
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
          await remove(ref(db,`posts/${threadId}/${cid}`));
          alert("å‰Šé™¤ã—ã¾ã—ãŸ");
          loadComments();
        }
      };
      tools.appendChild(delBtn);

      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>{
        if(confirm("BANã—ã¾ã™ã‹ï¼Ÿ")){
          await set(ref(db,`bans/${c.uid}`),{
            name:c.name,
            icon:c.icon,
            time:Date.now()
          });
          alert("BANã—ã¾ã—ãŸ");
          loadComments();
        }
      };
      tools.appendChild(banBtn);

      const kickBtn=document.createElement("button");
      kickBtn.textContent="è¿½æ”¾";
      kickBtn.onclick=async()=>{
        if(confirm("è¿½æ”¾ã—ã¾ã™ã‹ï¼Ÿ")){
          await remove(ref(db,`posts/${threadId}/${cid}`));
          alert("è¿½æ”¾ã—ã¾ã—ãŸ");
          loadComments();
        }
      };
      tools.appendChild(kickBtn);
    }

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    const carrotBtn=document.createElement("button");
    carrotBtn.textContent="ğŸ¥•";
    carrotBtn.onclick=async()=>{
      const path = ref(db,`posts/${threadId}/${cid}/reactions/ğŸ¥•/${userId}`);
      const snap = await get(path);
      if(snap.exists()) await remove(path);
      else await set(path,true);
      loadComments();
    };
    tools.appendChild(carrotBtn);

    const starBtn=document.createElement("button");
    starBtn.textContent="âœ¨ï¸";
    starBtn.onclick=async()=>{
      const path = ref(db,`posts/${threadId}/${cid}/reactions/âœ¨ï¸/${userId}`);
      const snap = await get(path);
      if(snap.exists()) await remove(path);
      else await set(path,true);
      loadComments();
    };
    tools.appendChild(starBtn);

    /* ã‚³ãƒ¡ãƒ³ãƒˆç•ªå·ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ */
    const jumpBtn=document.createElement("button");
    jumpBtn.textContent=">>#";
    jumpBtn.onclick=()=>{window.scrollTo({top:div.offsetTop-20,behavior:"smooth"});};
    tools.appendChild(jumpBtn);

    div.appendChild(tools);
    commentsDiv.appendChild(div);
    idx++;
  }
}

/* æŠ•ç¨¿ */
postCommentBtn.onclick=async()=>{
  const name = nameInput.value.trim()||"åã‚‚ãªãå…";
  const icon = iconInput.value.trim()||"usagi.png.jpeg";
  const text = commentInput.value.trim();
  if(!text) return alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã­");

  const bansSnap = await get(ref(db,"bans"));
  const bans = bansSnap.val()||{};
  if(bans[userId]) return alert("BANã•ã‚Œã¦ã„ã‚‹ã®ã§æŠ•ç¨¿ã§ãã¾ã›ã‚“");

  const ckey = (await push(ref(db,`posts/${threadId}`),{
    uid:userId,
    name:name,
    icon:icon,
    text:text,
    time:Date.now()
  })).key;

  localStorage.setItem("usakira_name",name);
  localStorage.setItem("usakira_icon",icon);
  commentInput.value="";
  loadComments();
};

/* åˆå›ãƒ­ãƒ¼ãƒ‰ */
loadThread();
loadComments();
</script>

</body>
</html>
