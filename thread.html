<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>üê∞ „ÅÜ„Åï‚òÖ„Ç≠„É©Êé≤Á§∫Êùø „Çπ„É¨„ÉÉ„Éâ</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s}
body.dark{background:#121212;color:#eee}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer}
button:hover{opacity:0.85}
textarea,input{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
body.dark textarea,body.dark input{background:#222;color:#eee;border:1px solid #555}
.thread,.comment{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 2px 6px rgba(255,150,210,0.25)}
body.dark .thread,body.dark .comment{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.thread.locked{background:#ccc;border-color:#999}
.flex{display:flex;align-items:center;gap:10px}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:6px}
.icon{width:40px;height:40px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
body.dark .icon{border-color:#ff8cd1}
.comment p{margin:4px 0}
.meta{font-size:0.8rem;color:#aa7}
a.jump-link{color:#d22;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">üåô</button>
<h1 id="threadTitleHeader"></h1>

<div id="postBox">
<textarea id="commentInput" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..."></textarea>
<button id="postBtn">ÊäïÁ®ø„Åô„Çã</button>
</div>

<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* „É¶„Éº„Ç∂„ÉºÊÉÖÂ†± */
const userId = localStorage.getItem("usakira_userId") || ("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);
const userName = localStorage.getItem("usakira_name") || "Âêç„ÇÇ„Å™„ÅçÂÖé";
const userIcon = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";
const isAdmin = localStorage.getItem("usakira_admin") === "true";

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
const darkToggle = document.getElementById("darkToggle");
const savedDark = localStorage.getItem("usakira_dark") === "true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent = savedDark?"‚òÄÔ∏è":"üåô";
darkToggle.onclick = ()=>{
  const now = !document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark", now);
  darkToggle.textContent=now?"‚òÄÔ∏è":"üåô";
};

/* „Çπ„É¨„ÉÉ„ÉâID */
const urlParams = new URLSearchParams(window.location.search);
const threadId = urlParams.get("id");

/* „Ç≥„É°„É≥„ÉàÊäïÁ®ø */
const postBtn = document.getElementById("postBtn");
const commentInput = document.getElementById("commentInput");

async function checkBan(){
  const banSnap = await get(ref(db,"bans/"+userId));
  return banSnap.exists();
}

postBtn.onclick = async ()=>{
  if(await checkBan()) return alert("BAN„Åï„Çå„Å¶„ÅÑ„Çã„Éö„Ç≥");
  let text = commentInput.value.trim();
  if(!text) return;
  await push(ref(db,"posts/"+threadId),{
    uid:userId,name:userName,icon:userIcon,text:text,time:Date.now(),
    reactions:{carrot:0,star:0,total:0}
  });
  commentInput.value="";
};

/* „Çπ„É¨ÊÉÖÂ†±Ë°®Á§∫ */
const threadTitleHeader = document.getElementById("threadTitleHeader");
let threadData = null;
onValue(ref(db,"threads/"+threadId), snap=>{
  const t = snap.val();
  threadData = t;
  if(!t) {threadTitleHeader.textContent="„Çπ„É¨„ÉÉ„Éâ„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì"; return;}
  let titleText = t.title || "ÔºàÁÑ°È°åÔºâ";
  let label = t.ownerName;
  if(t.ownerId === userId) label+="‚òÖ";
  if(isAdmin) label="üëë"+label;
  threadTitleHeader.textContent = label+": "+titleText;
});

/* ÁÆ°ÁêÜËÄÖUID„É™„Çπ„ÉàÂèñÂæó */
let adminUIDs = [];
onValue(ref(db,"adminUIDs"),snap=>{
  adminUIDs = snap.val() || [];
});

/* „Ç≥„É°„É≥„ÉàË°®Á§∫ */
const commentsDiv = document.getElementById("comments");
onValue(ref(db,"posts/"+threadId), snap=>{
  commentsDiv.innerHTML="";
  const posts = snap.val() || {};
  const postsArray = Object.entries(posts).map(([id,c])=>({id,...c}));
  postsArray.sort((a,b)=>a.time - b.time);

  postsArray.forEach((c,index)=>{
    if(c.deleted) return; // ÂâäÈô§Ê∏à„Åø„Ç≥„É°„É≥„Éà„ÅØÈùûË°®Á§∫

    const div = document.createElement("div");
    div.className="comment";
    div.id = "comment"+(index+1);

    // „É©„Éô„É´Ôºà„Çπ„É¨‰∏ª‚òÖ„ÄÅÁÆ°ÁêÜËÄÖüëëÔºâ
    let label = c.name;
    if(c.uid === threadData.ownerId) label += "‚òÖ";
    if(adminUIDs.includes(c.uid)) label = "üëë"+label;

    // „Ç≥„É°„É≥„ÉàÊñáÂ≠óËâ≤
    const totalReactions = c.reactions?.total || 0;
    let styleColor = "";
    if(totalReactions >= 10){
      styleColor = "background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; color: transparent;";
    } else if(totalReactions >=5){
      styleColor = "color:red;";
    }

    div.innerHTML = `
      <div class="flex">
        <img class="icon" src="${c.icon||'usagi.png.jpeg'}">
        <div style="flex:1">
          <b>${index+1} ${label}</b>
          <p style="${styleColor}">${c.text} „Éö„Ç≥</p>
          <p class="meta">${new Date(c.time).toLocaleString()} ID:${c.uid}</p>
        </div>
      </div>
    `;

    const tools = document.createElement("div");
    tools.className="flex-end";

    // Ëøî‰ø°„Éú„Çø„É≥
    const replyBtn = document.createElement("button");
    replyBtn.textContent = "Ëøî‰ø°";
    replyBtn.onclick = ()=>{commentInput.value=">>#"+(index+1)+" "; commentInput.focus();}
    tools.appendChild(replyBtn);

    // ÈÄöÂ†±„Éú„Çø„É≥
    const reportBtn = document.createElement("button");
    reportBtn.textContent = "ÈÄöÂ†±";
    reportBtn.onclick=async()=>{
      const reportRef = ref(db,"reports");
      const reportSnap = await get(reportRef);
      const reports = reportSnap.val() || {};
      let count=0;
      for(const rid in reports){
        const r = reports[rid];
        if(r.postId===c.id) count++;
      }
      await push(reportRef,{
        threadId:threadId,
        postId:c.id,
        uid:c.uid,
        name:c.name,
        icon:c.icon,
        text:c.text,
        time:Date.now()
      });
      alert(`ÈÄöÂ†±„Åó„Åæ„Åó„Åü„Éö„Ç≥ (${count+1}ÂõûÁõÆ„ÅÆÈÄöÂ†±)`);
    };
    tools.appendChild(reportBtn);

    // ÁÆ°ÁêÜ‰∫∫„ÅÆ„ÅøÂâäÈô§„ÉªBAN
    if(isAdmin){
      const delBtn = document.createElement("button");
      delBtn.textContent="ÂâäÈô§";
      delBtn.onclick=async()=>await set(ref(db,"posts/"+threadId+"/"+c.id+"/deleted"),true);
      const banBtn = document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>await set(ref(db,"bans/"+c.uid),{name:c.name,icon:c.icon,time:Date.now()});
      tools.append(delBtn,banBtn);
    }

    // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥
    const carrotBtn = document.createElement("button");
    carrotBtn.textContent="ü•ï "+(c.reactions?.carrot||0);
    carrotBtn.onclick=async()=>{
      c.reactions = c.reactions||{carrot:0,star:0,total:0};
      const reacted = localStorage.getItem("react_"+c.id+"_carrot")==="true";
      if(reacted){c.reactions.carrot--; c.reactions.total--; localStorage.removeItem("react_"+c.id+"_carrot");}
      else {c.reactions.carrot++; c.reactions.total++; localStorage.setItem("react_"+c.id+"_carrot","true");}
      await set(ref(db,"posts/"+threadId+"/"+c.id+"/reactions"),c.reactions);
    };
    const starBtn = document.createElement("button");
    starBtn.textContent="‚ú® "+(c.reactions?.star||0);
    starBtn.onclick=async()=>{
      c.reactions = c.reactions||{carrot:0,star:0,total:0};
      const reacted = localStorage.getItem("react_"+c.id+"_star")==="true";
      if(reacted){c.reactions.star--; c.reactions.total--; localStorage.removeItem("react_"+c.id+"_star");}
      else {c.reactions.star++; c.reactions.total++; localStorage.setItem("react_"+c.id+"_star","true");}
      await set(ref(db,"posts/"+threadId+"/"+c.id+"/reactions"),c.reactions);
    };

    tools.append(carrotBtn,starBtn);
    div.appendChild(tools);
    commentsDiv.appendChild(div);
  });
});
</script>
</body>
</html>
