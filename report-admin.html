<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ã‚¹ãƒ¬ãƒƒãƒ‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s;
}
body.dark{background:#121212;color:#eee}

a{color:#ff4fa8;text-decoration:none}
a:hover{text-decoration:underline}

.card{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin:12px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
}
body.dark .card{background:#1b1b1b;border-color:#555}

.flex{display:flex;align-items:flex-start;gap:10px}

.icon{
  width:42px;height:42px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
}

.meta{font-size:.8rem;color:#888}
body.dark .meta{color:#aaa}

.tools{
  display:flex;
  justify-content:flex-end;
  gap:6px;
  margin-top:6px;
}

button{
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
}

.reactions{
  display:flex;
  gap:6px;
  margin-top:6px;
}

.reaction-btn{
  font-size:.85rem;
}

.flash{
  animation:flash .6s ease-in-out infinite alternate;
}
@keyframes flash{
  from{box-shadow:0 0 6px #ff9ad5}
  to{box-shadow:0 0 16px #ffd1eb}
}

textarea{width:100%;height:70px;border-radius:8px;padding:6px}

</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>

<h2 id="threadTitle">ã‚¹ãƒ¬ãƒƒãƒ‰</h2>
<a href="index.html">â† æ²ç¤ºæ¿ã«æˆ»ã‚‹</a>

<hr>

<div id="posts"></div>

<hr>

<textarea id="text"></textarea>
<button id="postBtn">æŠ•ç¨¿</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const app=initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const saved=localStorage.getItem("usakira_dark")==="true";
if(saved)document.body.classList.add("dark");
darkToggle.textContent=saved?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const d=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",d);
  darkToggle.textContent=d?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const uid=localStorage.getItem("usakira_userId");
const name=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";
const icon=localStorage.getItem("usakira_icon")||"usagi.png.jpeg";
const isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ã‚¹ãƒ¬ID */
const params=new URLSearchParams(location.search);
const threadId=params.get("id");

/* ã‚¿ã‚¤ãƒˆãƒ« */
onValue(ref(db,"threads/"+threadId),snap=>{
  if(snap.exists()) document.getElementById("threadTitle").textContent=snap.val().title;
});

/* æŠ•ç¨¿ */
document.getElementById("postBtn").onclick=async()=>{
  const text=document.getElementById("text").value.trim();
  if(!text) return;

  const banSnap=await get(ref(db,"ban/"+uid));
  if(banSnap.exists()){
    alert("ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  await push(ref(db,"posts/"+threadId),{
    text:text+" ãƒšã‚³",
    name:name,
    icon:icon,
    uid:uid,
    time:Date.now(),
    deleted:false,
    reactions:{}
  });

  document.getElementById("text").value="";
};

/* è¡¨ç¤º */
const box=document.getElementById("posts");

onValue(ref(db,"posts/"+threadId),snap=>{
  box.innerHTML="";
  let idx=0;

  snap.forEach(s=>{
    idx++;
    const p=s.val();
    const id=s.key;

    const card=document.createElement("div");
    card.className="card";
    card.id="c"+idx;

    if(p.deleted){
      card.innerHTML="<i>ã“ã®ã‚³ãƒ¡ã¯å‰Šé™¤ã•ã‚ŒãŸãƒšã‚³</i>";
      box.appendChild(card);
      return;
    }

    const reacts=p.reactions||{};
    const count=(reacts["ğŸ¥•"]?.length||0)+(reacts["âœ¨"]?.length||0);
    if(count>=5) card.classList.add("flash");

    card.innerHTML=`
      <div class="flex">
        <img class="icon" src="${p.icon}" onerror="this.src='usagi.png.jpeg'">
        <div>
          <b>#${idx} ${p.name}</b>
          ${p.uid===uid?"":" "}
          <div class="meta">
            ID:${p.uid} ï½œ ${new Date(p.time).toLocaleString()}
          </div>
          <div>${p.text}</div>
        </div>
      </div>
    `;

    /* ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    const rdiv=document.createElement("div");
    rdiv.className="reactions";

    ["ğŸ¥•","âœ¨"].forEach(e=>{
      const btn=document.createElement("button");
      const list=reacts[e]||[];
      btn.textContent=`${e} ${list.length}`;
      btn.className="reaction-btn";

      btn.onclick=async()=>{
        const rref=ref(db,`posts/${threadId}/${id}/reactions/${e}`);
        const snap=await get(rref);
        let arr=snap.val()||[];
        if(arr.includes(uid)) arr=arr.filter(x=>x!==uid);
        else arr.push(uid);
        await set(rref,arr);
      };
      rdiv.appendChild(btn);
    });

    card.appendChild(rdiv);

    /* ç®¡ç†ãƒ»å‰Šé™¤ */
    const tools=document.createElement("div");
    tools.className="tools";

    if(isAdmin || p.uid===uid){
      const del=document.createElement("button");
      del.textContent="å‰Šé™¤";
      del.onclick=async()=>{
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
        await set(ref(db,`posts/${threadId}/${id}/deleted`),true);
      };
      tools.appendChild(del);
    }

    if(isAdmin){
      const ban=document.createElement("button");
      ban.textContent="BAN";
      ban.onclick=async()=>{
        if(!confirm("BANã—ã¾ã™ã‹ï¼Ÿ"))return;
        await set(ref(db,"ban/"+p.uid),{
          name:p.name,
          icon:p.icon,
          time:Date.now()
        });
      };
      tools.appendChild(ban);
    }

    card.appendChild(tools);
    box.appendChild(card);
  });
});
</script>
</body>
</html>
