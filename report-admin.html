<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ç®¡ç†ãƒšãƒ¼ã‚¸âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:.25s}
body.dark{background:#121212;color:#eee}
h1,h2{margin-top:0}
.card{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px}
body.dark .card{background:#1b1b1b;border-color:#555}
.flex{display:flex;align-items:center}
.flex-column{display:flex;flex-direction:column}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px}
.icon{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;margin-right:10px}
button{padding:4px 8px;border-radius:6px;cursor:pointer}
#reportList,#banList{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:900px){#reportList,#banList{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){#reportList,#banList{grid-template-columns:1fr}}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1>ğŸ° ç®¡ç†ãƒšãƒ¼ã‚¸</h1>

<h2>ğŸš¨ é€šå ±ãƒªã‚¹ãƒˆ</h2>
<div id="reportList"></div>

<hr>
<h2>ğŸš« BANãƒªã‚¹ãƒˆ</h2>
<div id="banList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
  document.body.classList.add("dark");
  darkToggle.textContent="â˜€ï¸";
}
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const d=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",d);
  darkToggle.textContent=d?"â˜€ï¸":"ğŸŒ™";
};

/* ğŸš¨ é€šå ±ãƒªã‚¹ãƒˆï¼ˆé‡è¤‡ã¾ã¨ã‚ï¼‰ */
const reportList=document.getElementById("reportList");
onValue(ref(db,"reports"),snap=>{
  reportList.innerHTML="";
  const reports=snap.val()||{};

  const grouped={};
  Object.entries(reports).forEach(([rid,r])=>{
    const key=r.threadId+"_"+r.postId;
    if(!grouped[key]){
      grouped[key]={ r, rids:[rid], count:1 };
    }else{
      grouped[key].rids.push(rid);
      grouped[key].count++;
    }
  });

  Object.values(grouped)
    .sort((a,b)=>b.r.time-a.r.time)
    .forEach(item=>{
      const r=item.r;
      const card=document.createElement("div");
      card.className="card flex-column";
      card.innerHTML=`
        <div class="flex">
          <img class="icon" src="${r.icon||'usagi.png.jpeg'}">
          <div>
            <b>${r.name||"åã‚‚ãªãå…"}</b>
            <div style="font-size:.8rem;color:#888">
              <a href="thread.html?id=${r.threadId}" target="_blank">ã‚¹ãƒ¬ã¸</a>
            </div>
          </div>
        </div>
        <p>${r.text}</p>
        <div style="font-size:.8rem;color:#aa7">
          é€šå ±æ—¥æ™‚: ${new Date(r.time).toLocaleString()}
          ${item.count>1 ? " ãƒ»"+item.count+"ä»¶" : ""}
        </div>
        <div class="flex-end"></div>
      `;
      const tools=card.querySelector(".flex-end");

      /* æŠ•ç¨¿å‰Šé™¤ */
      const delBtn=document.createElement("button");
      delBtn.textContent="æŠ•ç¨¿å‰Šé™¤";
      delBtn.onclick=async()=>{
        await set(ref(db,"posts/"+r.threadId+"/"+r.postId+"/deleted"),true);
      };

      /* BAN */
      const banBtn=document.createElement("button");
      banBtn.textContent="BAN";
      banBtn.onclick=async()=>{
        await set(ref(db,"bans/"+r.uid),{
          name:r.name,icon:r.icon,time:Date.now()
        });
      };

      /* é€šå ±å–ã‚Šæ¶ˆã—ï¼ˆå…¨éƒ¨ï¼‰ */
      const clearBtn=document.createElement("button");
      clearBtn.textContent="é€šå ±å–ã‚Šæ¶ˆã—";
      clearBtn.onclick=async()=>{
        for(const rid of item.rids){
          await remove(ref(db,"reports/"+rid));
        }
      };

      tools.append(delBtn,banBtn,clearBtn);
      reportList.appendChild(card);
    });
});

/* ğŸš« BANãƒªã‚¹ãƒˆ */
const banList=document.getElementById("banList");
onValue(ref(db,"bans"),snap=>{
  banList.innerHTML="";
  Object.entries(snap.val()||{}).forEach(([uid,u])=>{
    const card=document.createElement("div");
    card.className="card flex";
    card.innerHTML=`
      <img class="icon" src="${u.icon||'usagi.png.jpeg'}">
      <div style="flex:1">
        <b>${u.name||"åã‚‚ãªãå…"}</b><br>
        <small>${new Date(u.time).toLocaleString()}</small>
      </div>
    `;
    const un=document.createElement("button");
    un.textContent="BANè§£é™¤";
    un.onclick=()=>remove(ref(db,"bans/"+uid));
    card.appendChild(un);
    banList.appendChild(card);
  });
});
</script>
</body>
</html>
