<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ ç®¡ç†ãƒšãƒ¼ã‚¸âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;padding:20px;background:#fff0f8;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1,h2{margin-top:0;}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer;}
.card{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;box-shadow:0 2px 6px rgba(255,150,210,.25);}
body.dark .card{background:#1b1b1b;border-color:#555;}
.flex{display:flex;align-items:center;gap:10px;}
.icon{width:48px;height:48px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover;}
body.dark .icon{border-color:#ff8cd1;}
.tools{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}
#reportList,#banList{margin-top:10px;}
#reportList{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
@media(max-width:900px){#reportList{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){#reportList{grid-template-columns:1fr}}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>

<h1>ğŸ° ç®¡ç†ãƒšãƒ¼ã‚¸</h1>

<h2>ğŸš¨ é€šå ±ãƒªã‚¹ãƒˆ</h2>
<div id="reportList"></div>

<hr>

<h2>ğŸš« BANãƒªã‚¹ãƒˆ</h2>
<div id="banList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, get, push, set, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app=initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db=getDatabase(app);

/* ç®¡ç†äººãƒ•ãƒ©ã‚° */
localStorage.setItem("usakira_admin","true");

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* é€šå ±ãƒªã‚¹ãƒˆ */
const reportList=document.getElementById("reportList");
onValue(ref(db,"reports"),async snap=>{
  reportList.innerHTML="";
  const data=snap.val()||{};
  for(const rid in data){
    const r=data[rid];
    const threadSnap=await get(ref(db,`threads/${r.threadId}`));
    const thread=threadSnap.val();
    if(!thread) continue;
    const postSnap=await get(ref(db,`posts/${r.threadId}/${r.postId}`));
    const post=postSnap.val();
    if(!post) continue;

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="flex">
        <img class="icon" src="${post.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
        <div>
          <b>${post.name||'åã‚‚ãªãå…'}</b><br>
          <a href="thread.html?id=${r.threadId}">${thread.title||"ï¼ˆç„¡é¡Œï¼‰"}</a>
        </div>
      </div>
      <p style="margin:8px 0">${post.text||''}</p>
      <div style="font-size:.8rem;color:#aa7">é€šå ±æ—¥æ™‚: ${new Date(r.time||Date.now()).toLocaleString()}</div>
    `;

    const tools=document.createElement("div");
    tools.className="tools";

    /* æŠ•ç¨¿å‰Šé™¤ */
    const del=document.createElement("button");
    del.textContent="æŠ•ç¨¿å‰Šé™¤";
    del.onclick=async()=>{
      if(!confirm("æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await remove(ref(db,`posts/${r.threadId}/${r.postId}`));
      await remove(ref(db,`reports/${rid}`));
      alert("å‰Šé™¤ã—ã¾ã—ãŸï¼");
    };

    /* BAN */
    const ban=document.createElement("button");
    ban.textContent="BAN";
    ban.onclick=async()=>{
      if(!confirm("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’BANã—ã¾ã™ã‹ï¼Ÿ")) return;
      await set(ref(db,`bans/${post.userId}`),{
        name:post.name,
        icon:post.icon,
        time:Date.now()
      });
      alert("BANã—ã¾ã—ãŸï¼");
    };

    /* é€šå ±è§£é™¤ */
    const clear=document.createElement("button");
    clear.textContent="é€šå ±è§£é™¤";
    clear.onclick=async()=>{
      await remove(ref(db,`reports/${rid}`));
      alert("é€šå ±ã‚’è§£é™¤ã—ã¾ã—ãŸï¼");
    };

    tools.append(del,ban,clear);
    card.appendChild(tools);
    reportList.appendChild(card);
  }
});

/* BANãƒªã‚¹ãƒˆ */
const banList=document.getElementById("banList");
onValue(ref(db,"bans"),snap=>{
  banList.innerHTML="";
  const data=snap.val()||{};
  for(const uid in data){
    const u=data[uid];
    const card=document.createElement("div");
    card.className="card flex";
    card.innerHTML=`
      <img class="icon" src="${u.icon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
      <div style="flex:1">
        <b>${u.name||'åã‚‚ãªãå…'}</b><br>
        <span style="font-size:.8rem;color:#aa7">BANæ—¥æ™‚: ${new Date(u.time).toLocaleString()}</span>
      </div>
    `;
    const unban=document.createElement("button");
    unban.textContent="BANè§£é™¤";
    unban.onclick=async()=>{
      if(!confirm("BANè§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await remove(ref(db,`bans/${uid}`));
      alert("è§£é™¤ã—ã¾ã—ãŸï¼");
    };
    card.appendChild(unban);
    banList.appendChild(card);
  }
});
</script>
</body>
</html>
