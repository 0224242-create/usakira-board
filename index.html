<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:0.25s;
}
body.dark{background:#121212;color:#eee;}

h1{margin-top:0;}

.thread-card{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
  transition:0.2s;
}
.thread-card.locked{background:#ddd;}
body.dark .thread-card{background:#1b1b1b;border-color:#555;}
body.dark .thread-card.locked{background:#555;}

.flex{display:flex;align-items:center;}
.flex-column{display:flex;flex-direction:column;}
.flex-end{display:flex;justify-content:flex-end;gap:6px;margin-top:8px;}

.icon{
  width:48px;height:48px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
  margin-right:10px;
}

button{padding:4px 8px;border-radius:6px;cursor:pointer;margin-left:4px;}
input{width:100%;padding:6px;margin:4px 0;border-radius:6px;}

#sorting{margin:10px 0;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div id="profileBox">
  <input id="nameInput" placeholder="åå‰" />
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL" />
  <button id="saveProfile">ä¿å­˜</button>
  <button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>
</div>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«"/>
<textarea id="threadBody" placeholder="æœ¬æ–‡"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ãƒ‘ã‚¹ï¼ˆä»»æ„ï¼‰"/>
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<div id="sorting">
  ä¸¦ã³æ›¿ãˆ:
  <button id="sortNew">æ–°ã—ã„é †</button>
  <button id="sortReact">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †</button>
</div>

<div id="threads"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const now=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick=()=>{
  const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw==="master") location.href="report-admin.html";
  else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
};

/* ã‚¹ãƒ¬ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title=document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const body=document.getElementById("threadBody").value.trim();
  const pass=document.getElementById("threadPass").value.trim();
  const key=await push(ref(db,"threads"),{
    title, body, pass:pass||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  }).key;
  alert("ä½œæˆã—ãŸã‚ˆï¼");
  location.href=`thread.html?id=${key}`;
};

/* BANæƒ…å ± */
let banList={};
onValue(ref(db,"bans"),snap=>{banList=snap.val()||{};});

/* ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º */
const threadsDiv=document.getElementById("threads");
let threadArr=[];
let currentSort="new"; // new or react

function renderThreads(){
  threadsDiv.innerHTML="";
  let sorted=[...threadArr];
  if(currentSort==="react"){
    sorted.sort((a,b)=>{
      const aReact=Object.values(a[1].reaction||{}).reduce((s,v)=>s+v,0);
      const bReact=Object.values(b[1].reaction||{}).reduce((s,v)=>s+v,0);
      return bReact-aReact;
    });
  }
  sorted.forEach(([id,t])=>{
    const div=document.createElement("div");
    div.className="thread-card";
    if(t.pass) div.classList.add("locked");
    const commentCount=t.comments?t.comments:0;
    const totalReact=Object.values(t.reaction||{}).reduce((s,v)=>s+v,0);
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${t.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <b>${t.ownerName||defaultName}</b>
          <div>${new Date(t.time).toLocaleString()}</div>
        </div>
      </div>
      <h3><a href="thread.html?id=${id}">${t.title||"ï¼ˆç„¡é¡Œï¼‰"}</a></h3>
      <p>ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount} / ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${totalReact}</p>
    `;
    threadsDiv.appendChild(div);
  });
}

onValue(ref(db,"threads"),snap=>{
  const data=snap.val()||{};
  threadArr=Object.entries(data).map(([id,t])=>{
    t.comments=t.comments||0;
    t.reaction=t.reaction||{};
    return [id,t];
  });
  renderThreads();
});

/* ä¸¦ã³æ›¿ãˆ */
document.getElementById("sortNew").onclick=()=>{
  currentSort="new"; renderThreads();
};
document.getElementById("sortReact").onclick=()=>{
  currentSort="react"; renderThreads();
};
</script>
</body>
</html>
