<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", sans-serif, sans-serif; background:#fffafc; color:#222; padding:16px; transition:0.25s; }
    .dark { background:#111; color:#eaeaea; }
    h1 { color:#ff7ac6; }
    .card { background:#fff; border:1px solid #ffdce6; border-radius:8px; padding:10px; margin:8px 0; }
    .icon { width:36px; height:36px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    .small { font-size:13px; color:#666; }
    input, textarea { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
    button { padding:8px 12px; margin:6px 4px 0 0; cursor:pointer; border-radius:6px; }
    .locked { color:#aa8; font-size:13px; margin-left:6px; }
    .page-btn { margin:4px; padding:6px 8px; }
    .danger { color:#c33; font-weight:bold; cursor:pointer; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <button id="darkToggle" style="position:fixed; right:12px; top:12px; font-size:20px;">ğŸŒ™</button>
  <h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
  <div class="card">
    <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
    åå‰ <input id="profileName" placeholder="åã‚‚ãªãå…">
    ã‚¢ã‚¤ã‚³ãƒ³URL <input id="profileIcon" placeholder="ä¾‹: https://.../image.png">
    <div class="small">ä¿å­˜ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰ã€‚</div>
    <button id="saveProfileBtn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜</button>
  </div>

  <!-- ã‚¹ãƒ¬ä½œæˆ -->
  <div class="card">
    <h3>æ–°è¦ã‚¹ãƒ¬ä½œæˆ</h3>
    ã‚¿ã‚¤ãƒˆãƒ« <input id="newTitle" placeholder="ã‚¹ãƒ¬ã®ã‚¿ã‚¤ãƒˆãƒ«">
    æœ¬æ–‡ï¼ˆæœ€åˆã®å†…å®¹ï¼‰ <textarea id="newBody" placeholder="ã‚¹ãƒ¬ä½œæˆæ™‚ã®æœ¬æ–‡"></textarea>
    éµä»˜ãã«ã™ã‚‹ãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰ <input id="newPass" placeholder="ç©ºãªã‚‰å…¬é–‹ã‚¹ãƒ¬">
    <div class="small">ä½œæˆè€…ã«ã¯ã‚¹ãƒ¬ã®ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ãŒä»˜ãã¾ã™ã€‚</div>
    <button id="createThreadBtn">ã‚¹ãƒ¬ã‚’ä½œæˆ</button>
  </div>

  <!-- ã‚¹ãƒ¬ä¸€è¦§ -->
  <h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
  <div id="threads"></div>
  <div id="pages"></div>

<script>
/* Firebase è¨­å®šï¼ˆå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šï¼‰*/
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.firebasestorage.app",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd",
  measurementId: "G-7E1BZ3BGBR"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã‚’å¤‰ãˆã¦ï¼‰ */
const ADMIN_PW = "master";

/* ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ID / ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
let userId = localStorage.getItem("usakira_userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId", userId);
}
const defaultIcon = "usagi.png.jpeg";
const profileNameEl = document.getElementById("profileName");
const profileIconEl = document.getElementById("profileIcon");

function loadLocalProfile() {
  profileNameEl.value = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
  profileIconEl.value = localStorage.getItem("usakira_icon") || defaultIcon;
}
loadLocalProfile();

document.getElementById("saveProfileBtn").addEventListener("click", () => {
  const n = profileNameEl.value.trim() || "åã‚‚ãªãå…";
  const i = profileIconEl.value.trim() || defaultIcon;
  localStorage.setItem("usakira_name", n);
  localStorage.setItem("usakira_icon", i);
  alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ãŸãƒšã‚³");
});

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
if (localStorage.getItem("usakira_dark") === "true") document.body.classList.add("dark"), darkToggle.textContent = "â˜€ï¸";
darkToggle.addEventListener("click", () => {
  const on = document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark", on ? "true" : "false");
  darkToggle.textContent = on ? "â˜€ï¸" : "ğŸŒ™";
});

/* ã‚¹ãƒ¬ä½œæˆ */
document.getElementById("createThreadBtn").addEventListener("click", async () => {
  const title = document.getElementById("newTitle").value.trim();
  const body = document.getElementById("newBody").value.trim();
  const pass = document.getElementById("newPass").value.trim();
  if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«æ›¸ã„ã¦ã­ãƒšã‚³");
  const name = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
  const icon = localStorage.getItem("usakira_icon") || defaultIcon;
  const newRef = db.ref("threads").push();
  await newRef.set({
    title,
    body: body || "",
    pass: pass || "",
    owner: userId,
    ownerName: name,
    ownerIcon: icon,
    createdAt: Date.now()
  });
  document.getElementById("newTitle").value = "";
  document.getElementById("newBody").value = "";
  document.getElementById("newPass").value = "";
});

/* ãƒªã‚¹ãƒˆå–å¾— + ãƒšãƒ¼ã‚¸ãƒ³ã‚° */
const PER = 20;
let allThreads = [];
let currentPage = 1;

function fetchThreadsAndRender() {
  db.ref("threads").on("value", (snap) => {
    const data = snap.val() || {};
    allThreads = Object.entries(data).map(([id, v]) => ({ id, ...v }));
    // æ–°ã—ã„é †
    allThreads.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
    renderThreadList();
  });
}
fetchThreadsAndRender();

function renderThreadList(){
  const container = document.getElementById("threads");
  container.innerHTML = "";
  const start = (currentPage - 1) * PER;
  const pageItems = allThreads.slice(start, start + PER);
  pageItems.forEach(t => {
    const div = document.createElement("div");
    div.className = "card";
    const lockedHtml = t.pass ? `<span class="locked">ğŸ”’ éµã‚¹ãƒ¬</span>` : "";
    div.innerHTML = `
      <div style="display:flex; align-items:center;">
        <img src="${t.ownerIcon || defaultIcon}" class="icon" onerror="this.src='${defaultIcon}'">
        <div style="flex:1;">
          <div style="font-weight:bold">${escapeHtml(t.title)} ${lockedHtml}</div>
          <div class="small">ä½œæˆè€…: ${escapeHtml(t.ownerName || "åç„¡ã—")}</div>
        </div>
        <div style="text-align:right">
          <button onclick="openThread('${t.id}')">é–‹ã</button><br>
          <span class="danger" onclick="delThread('${t.id}','${t.owner}')">å‰Šé™¤</span>
        </div>
      </div>
    `;
    container.appendChild(div);
  });

  // ãƒšãƒ¼ã‚¸è¡¨ç¤º
  const pagesDiv = document.getElementById("pages");
  pagesDiv.innerHTML = "";
  const total = Math.max(1, Math.ceil(allThreads.length / PER));
  for (let i=1;i<=total;i++){
    const b = document.createElement("button");
    b.className = "page-btn";
    b.textContent = i;
    if (i === currentPage) b.disabled = true;
    b.addEventListener("click", ()=>{ currentPage = i; renderThreadList(); });
    pagesDiv.appendChild(b);
  }
}

/* openThread: ä¿å­˜ã—ã¦åˆ¥ã‚¿ãƒ–ã§é–‹ãï¼ˆthread.html?id=...ï¼‰ */
function openThread(id) {
  localStorage.setItem("lastThread", id);
  window.open(`thread.html?id=${id}`, "_blank");
}

/* å‰Šé™¤ï¼ˆã‚¹ãƒ¬å‰Šé™¤ï¼‰: æ¡ä»¶ - ã‚¹ãƒ¬ä¸» or ç®¡ç†è€… */
async function delThread(id, ownerId) {
  try {
    // ç®¡ç†è€…? ã¾ãŸã¯ã‚ªãƒ¼ãƒŠãƒ¼?
    const youAreOwner = ownerId === userId;
    if (!youAreOwner) {
      const pw = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆå‰Šé™¤ï¼‰");
      if (pw !== ADMIN_PW) return alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ãƒšã‚³");
    }
    await db.ref("threads/" + id).remove();
    await db.ref("posts/" + id).remove(); // ã‚¹ãƒ¬å‰Šé™¤æ™‚ã¯æŠ•ç¨¿ã‚‚æ¶ˆã™
    alert("å‰Šé™¤ã—ãŸãƒšã‚³");
  } catch(e) {
    console.error(e);
    alert("å‰Šé™¤ã«å¤±æ•—ã—ãŸãƒšã‚³");
  }
}

/* BAN: ç®¡ç†è€…ã®ã¿ï¼ˆç®¡ç†è€…ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼ï¼‰ */
window.banUser = async function(uid){
  const pw = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆBANï¼‰");
  if (pw !== ADMIN_PW) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
  await db.ref("bans/" + uid).set(true);
  alert("BANã—ã¾ã—ãŸãƒšã‚³");
}

/* HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— */
function escapeHtml(s){
  if (!s) return "";
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>
</body>
</html>
