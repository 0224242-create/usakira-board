<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
.thread{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0}
.thread.locked{background:#eee;border-color:#aaa}
.flex{display:flex;align-items:center;gap:10px}
.icon{width:48px;height:48px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
.thread h3 a{color:#ff4fa8;font-weight:bold;text-decoration:none;cursor:pointer}
.meta{font-size:0.85rem;color:#777}
</style>
</head>
<body>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<button id="saveProfileBtn">ä¿å­˜</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThreadBtn">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threadsBox">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script type="module">

/* ===== ã‚¨ãƒ©ãƒ¼ã§å…¨åœæ­¢ã—ãªã„å®‰å…¨ãƒ©ãƒƒãƒ‘ãƒ¼ ===== */
function safe(fn){
  try{ fn(); }
  catch(e){
    console.error("ã‚¨ãƒ©ãƒ¼:",e);
  }
}

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ===== */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");

nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

document.getElementById("saveProfileBtn").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆ ğŸ°");
};

/* ===== userIdå›ºå®š ===== */
let userId=localStorage.getItem("usakira_userId");
if(!userId){
  userId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId",userId);
}

/* ===== ã‚¹ãƒ¬ä½œæˆ ===== */
document.getElementById("createThreadBtn").onclick=()=>{
  safe(async ()=>{
    const title=document.getElementById("threadTitle").value.trim();
    if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");

    const newRef=await push(ref(db,"threads"),{
      title:title,
      body:document.getElementById("threadBody").value,
      pass:document.getElementById("threadPass").value||null,
      ownerId:userId,
      ownerName:nameInput.value||defaultName,
      ownerIcon:iconInput.value||defaultIcon,
      time:Date.now()
    });

    location.href="thread.html?id="+newRef.key;
  });
};

/* ===== ã‚¹ãƒ¬ä¸€è¦§è¡¨ç¤ºï¼ˆå£Šã‚Œãªã„æ§‹é€ ï¼‰ ===== */
const threadsBox=document.getElementById("threadsBox");

safe(()=>{
  onValue(ref(db,"threads"), snap=>{
    threadsBox.innerHTML="";

    const data=snap.val();
    if(!data){
      threadsBox.innerHTML="<p>ã¾ã ã‚¹ãƒ¬ãŒãªã„ã‚ˆ ğŸ°</p>";
      return;
    }

    const entries=Object.entries(data)
      .sort((a,b)=>b[1].time-a[1].time);

    entries.forEach(([id,t])=>{
      const div=document.createElement("div");
      div.className="thread"+(t.pass?" locked":"");

      div.innerHTML=`
        <div class="flex">
          <img class="icon" src="${t.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
          <div>
            <h3><a data-id="${id}">${t.title}</a> ${t.pass?"ğŸ”’":""}</h3>
            <div class="meta">by ${t.ownerName}</div>
          </div>
        </div>
      `;

      /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ */
      div.querySelector("a").onclick=()=>{
        if(t.pass){
          const pw=prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã ã‚ˆ ğŸ”’");
          if(pw!==t.pass){
            alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã‚ˆ");
            return;
          }
        }
        location.href="thread.html?id="+id;
      };

      threadsBox.appendChild(div);
    });
  }, err=>{
    threadsBox.innerHTML="âš  Firebaseãƒ«ãƒ¼ãƒ«ã‹æ¥ç¶šã‚¨ãƒ©ãƒ¼";
    console.error(err);
  });
});

</script>
</body>
</html>
