<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; padding:20px; background:#fffafc; color:#222; transition:0.25s; }
    .dark { background:#121212; color:#eaeaea; }
    .thread { border:1px solid #ffd4ea; padding:12px; border-radius:8px; margin:8px 0; background:#fff; }
    .thread .meta { font-size:13px; color:#666; margin-top:6px; }
    .icon { width:36px; height:36px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    input, textarea { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
    button { padding:8px 12px; margin:6px 0; cursor:pointer; }
    .small { font-size:12px; color:#666; }
    .locked { color:#aa8; }
  </style>
</head>
<body>
  <button id="darkToggle" style="position:fixed; top:12px; right:12px;">ğŸŒ™</button>
  <h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>

  <section>
    <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
    <label>åå‰</label>
    <input id="profileName" placeholder="åã‚‚ãªãå…">
    <label>ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURLï¼ˆä»»æ„ï¼‰</label>
    <input id="profileIcon" placeholder="usagi.png.jpeg">
    <button id="saveProfileBtn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜</button>
    <p class="small">â€»åå‰æœªè¨­å®šã¯ã€Œåã‚‚ãªãå…ã€ã«ãªã‚Šã¾ã™</p>
  </section>
  <hr>

  <section>
    <h3>ã‚¹ãƒ¬ä½œæˆ</h3>
    <input id="newTitle" placeholder="ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰">
    <textarea id="newBody" placeholder="æœ€åˆã®æœ¬æ–‡ï¼ˆå¿…é ˆï¼‰"></textarea>
    <input id="newPass" placeholder="éµã‚¹ãƒ¬ã«ã™ã‚‹ãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
    <button id="createThreadBtn">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>
  </section>
  <hr>

  <section>
    <h3>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h3>
    <div id="threadList">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="threadPaging" style="margin-top:8px;"></div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    /* ========== Firebase è¨­å®šï¼ˆå›ãŒä»¥å‰æ¸¡ã—ã¦ãã‚ŒãŸè¨­å®šã‚’ä½¿ç”¨ï¼‰ ========== */
    const firebaseConfig = {
      apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
      authDomain: "keijiban-7c651.firebaseapp.com",
      databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
      projectId: "keijiban-7c651",
      storageBucket: "keijiban-7c651.firebasestorage.app",
      messagingSenderId: "342192640264",
      appId: "1:342192640264:web:a004a725b470741aaf1cbd",
      measurementId: "G-7E1BZ3BGBR"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ========== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­ & åˆæœŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ========== */
    let userId = localStorage.getItem("usakira_userId");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).slice(2);
      localStorage.setItem("usakira_userId", userId);
    }

    const defaultName = "åã‚‚ãªãå…";
    const defaultIcon = "usagi.png.jpeg";

    // profile local
    const profileNameEl = document.getElementById("profileName");
    const profileIconEl = document.getElementById("profileIcon");
    profileNameEl.value = localStorage.getItem("usakira_name") || defaultName;
    profileIconEl.value = localStorage.getItem("usakira_icon") || defaultIcon;

    document.getElementById("saveProfileBtn").addEventListener("click", () => {
      const name = profileNameEl.value.trim() || defaultName;
      const icon = profileIconEl.value.trim() || defaultIcon;
      localStorage.setItem("usakira_name", name);
      localStorage.setItem("usakira_icon", icon);
      alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã—ãŸãƒšã‚³");
    });

    /* ========== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ========== */
    const darkToggle = document.getElementById("darkToggle");
    const applyDark = (on) => {
      if (on) document.body.classList.add("dark");
      else document.body.classList.remove("dark");
      darkToggle.textContent = on ? "â˜€ï¸" : "ğŸŒ™";
    };
    const darkSaved = localStorage.getItem("usakira_dark") === "true";
    applyDark(darkSaved);
    darkToggle.addEventListener("click", () => {
      const now = !(localStorage.getItem("usakira_dark") === "true");
      localStorage.setItem("usakira_dark", now);
      applyDark(now);
    });

    /* ========== ã‚¹ãƒ¬ä½œæˆå‡¦ç†ï¼ˆéµã‚ã‚Šå¯¾å¿œï¼‰ ========== */
    document.getElementById("createThreadBtn").addEventListener("click", async () => {
      const title = document.getElementById("newTitle").value.trim();
      const body = document.getElementById("newBody").value.trim();
      const pass = document.getElementById("newPass").value.trim();
      if (!title || !body) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã¯å¿…é ˆãƒšã‚³");
      const ownerName = localStorage.getItem("usakira_name") || defaultName;
      const ownerIcon = localStorage.getItem("usakira_icon") || defaultIcon;
      await push(ref(db, "threads"), {
        title,
        body,
        pass: pass || "",
        ownerId: userId,
        ownerName,
        ownerIcon,
        time: Date.now()
      });
      document.getElementById("newTitle").value = "";
      document.getElementById("newBody").value = "";
      document.getElementById("newPass").value = "";
    });

    /* ========== BAN ç®¡ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ç®¡ç†ï¼‰ ==========
       ç®¡ç†è€…æ¨©é™ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ "master"ï¼ˆå¿…è¦ãªã‚‰å¤‰ãˆã¦ï¼‰
       ban data path: /bans/{userId} = true
    ===================================================*/
    async function isBanned(userIdToCheck) {
      const snap = await get(ref(db, `bans/${userIdToCheck}`));
      return snap.exists() && snap.val() === true;
    }
    async function doBan(targetUserId) {
      const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
      if (pw !== "master") return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ãƒšã‚³");
      await set(ref(db, `bans/${targetUserId}`), true);
      alert("BANã—ã¾ã—ãŸ");
    }

    /* ========== ã‚¹ãƒ¬ä¸€è¦§å–å¾— & ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¯ãƒšãƒ¼ã‚¸ãƒ³ã‚°ä¸è¦ã ãŒä¿é™ºï¼‰ ========== */
    const PER = 20;
    let threadsArr = []; // [ [id, data], ... ] sorted by time desc
    onValue(ref(db, "threads"), (snap) => {
      const raw = snap.val() || {};
      threadsArr = Object.entries(raw).sort((a,b)=> (b[1].time||0) - (a[1].time||0));
      renderThreads(1);
    });

    function renderThreads(page=1) {
      const start = (page-1)*PER;
      const pick = threadsArr.slice(start, start+PER);
      const list = document.getElementById("threadList");
      list.innerHTML = "";
      pick.forEach(([id, t]) => {
        // skip thread if owner banned
        const ownerId = t.ownerId;
        const div = document.createElement("div");
        div.className = "thread";
        div.innerHTML = `
          <img src="${t.ownerIcon || defaultIcon}" class="icon" onerror="this.src='${defaultIcon}'">
          <strong>${t.title}</strong>
          <div class="meta">by ${t.ownerName || defaultName} ãƒ» ${new Date(t.time).toLocaleString()}</div>
          ${t.pass ? '<div class="locked">ğŸ”’ éµã‚¹ãƒ¬</div>' : ''}
          <div style="margin-top:8px;">
            <button data-id="${id}" class="openBtn">é–‹ã</button>
            <button data-id="${id}" data-owner="${ownerId}" class="delThreadBtn">å‰Šé™¤</button>
            <button data-id="${id}" data-owner="${ownerId}" class="banBtn">BAN</button>
          </div>
        `;
        list.appendChild(div);
      });

      // paging UI
      const pages = Math.max(1, Math.ceil(threadsArr.length / PER));
      const pageBox = document.getElementById("threadPaging");
      pageBox.innerHTML = "";
      for (let i=1;i<=pages;i++){
        const b = document.createElement("button");
        b.textContent = i;
        b.onclick = ()=> renderThreads(i);
        pageBox.appendChild(b);
      }

      // attach open handlers
      document.querySelectorAll(".openBtn").forEach(btn=>{
        btn.onclick = (e) => {
          const id = e.currentTarget.dataset.id;
          localStorage.setItem("lastThread", id);
          // open in new tab with ?id
          window.open(`thread.html?id=${id}`, "_blank");
        };
      });

      // attach delete handlers (allowed to thread owner or admin pw)
      document.querySelectorAll(".delThreadBtn").forEach(btn=>{
        btn.onclick = async (e) => {
          const id = e.currentTarget.dataset.id;
          const ownerId = e.currentTarget.dataset.owner;
          const me = localStorage.getItem("usakira_userId");
          if (me === ownerId) {
            if (confirm("æœ¬å½“ã«ã“ã®ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
              await remove(ref(db, `threads/${id}`));
              await remove(ref(db, `posts/${id}`));
              alert("å‰Šé™¤ã—ãŸãƒšã‚³");
            }
            return;
          }
          const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if (pw === "master") {
            await remove(ref(db, `threads/${id}`));
            await remove(ref(db, `posts/${id}`));
            alert("ç®¡ç†è€…å‰Šé™¤ã—ãŸãƒšã‚³");
            return;
          }
          alert("å‰Šé™¤ã§ãã‚‹æ¨©é™ãŒãªã„ãƒšã‚³");
        };
      });

      // attach ban handlers
      document.querySelectorAll(".banBtn").forEach(btn=>{
        btn.onclick = async (e) => {
          const ownerId = e.currentTarget.dataset.owner;
          const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if (pw !== "master") return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
          await set(ref(db, `bans/${ownerId}`), true);
          alert("BANã—ã¾ã—ãŸãƒšã‚³");
        };
      });
    }

  </script>
</body>
</html>
