<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s
}
body.dark{background:#121212;color:#eee}

button{
  padding:4px 8px;
  margin:2px;
  border-radius:6px;
  cursor:pointer
}
button:hover{opacity:.85}

input{
  width:100%;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box
}
body.dark input{
  background:#222;
  color:#eee;
  border:1px solid #555
}

.thread{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:10px;
  margin:10px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25)
}
body.dark .thread{
  background:#1b1b1b;
  border-color:#555;
  box-shadow:0 2px 6px rgba(0,0,0,.3)
}

.flex{display:flex;align-items:center;gap:10px}
.flex-between{display:flex;justify-content:space-between;align-items:center;gap:10px}

.meta{font-size:.8rem;color:#aa7}
body.dark .meta{color:#aaa}

a{color:#d22;text-decoration:none}
body.dark a{color:#ff9ad5}
</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>

<h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>

<div class="thread">
  <input id="titleInput" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«">
  <button id="createBtn">ã‚¹ãƒ¬ã‚’ç«‹ã¦ã‚‹</button>
</div>

<div id="threads"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  push,
  set,
  get,
  remove   // â† â˜… è¿½åŠ ï¼ˆã“ã‚Œã ã‘ï¼‰
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ */
const userId=localStorage.getItem("usakira_userId")
  ||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")){
  localStorage.setItem("usakira_userId",userId);
}
const userName=localStorage.getItem("usakira_name")||"åã‚‚ãªãå…";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const now=!document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* BAN */
async function checkBan(){
  const s=await get(ref(db,"bans/"+userId));
  return s.exists();
}

/* ç®¡ç†è€… */
let adminUIDs=[],isAdmin=false;
onValue(ref(db,"adminUIDs"),s=>{
  adminUIDs=s.val()||[];
  isAdmin=adminUIDs.includes(userId);
});

/* ã‚¹ãƒ¬ä½œæˆ */
const createBtn=document.getElementById("createBtn");
const titleInput=document.getElementById("titleInput");

createBtn.onclick=async()=>{
  if(await checkBan()) return alert("BANã•ã‚Œã¦ã„ã‚‹ãƒšã‚³");
  const title=titleInput.value.trim();
  if(!title) return;

  const newRef=push(ref(db,"threads"));
  await set(newRef,{
    title:title,
    ownerId:userId,
    ownerName:userName,
    time:Date.now(),
    locked:false
  });

  titleInput.value="";
  location.href="thread.html?id="+newRef.key;
};

/* ã‚¹ãƒ¬ä¸€è¦§ï¼ˆã“ã“ãŒæœ¬ä½“ï¼‰ */
const threadsDiv=document.getElementById("threads");

onValue(ref(db,"threads"),s=>{
  threadsDiv.innerHTML="";
  const arr=Object.entries(s.val()||{})
    .map(([id,t])=>({id,...t}))
    .sort((a,b)=>b.time-a.time);

  arr.forEach(t=>{
    const div=document.createElement("div");
    div.className="thread";

    let label=t.ownerName;
    if(t.ownerId===userId) label+="â˜…";
    if(isAdmin) label="ğŸ‘‘"+label;

    div.innerHTML=`
      <div class="flex-between">
        <div>
          <b>${label}</b>
          <div class="meta">${new Date(t.time).toLocaleString()}</div>
        </div>
        <a href="thread.html?id=${t.id}">é–‹ã</a>
      </div>
      <p>${t.title}${t.locked?" ğŸ”’":""}</p>
    `;

    /* â˜… ã“ã“ã ã‘è¿½åŠ ï¼ˆæ—¢å­˜ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»æ§‹é€ ã¯ä¸å¤‰ï¼‰ */
    if(isAdmin || t.ownerId===userId){
      const delBtn=document.createElement("button");
      delBtn.textContent="ğŸ—‘ å‰Šé™¤";
      delBtn.onclick=async()=>{
        if(!confirm("ã“ã®ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        await remove(ref(db,"threads/"+t.id));
        await remove(ref(db,"posts/"+t.id));
      };
      div.appendChild(delBtn);
    }

    threadsDiv.appendChild(div);
  });
});
</script>

</body>
</html>
