<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{
      font-family:"Hiragino Kaku Gothic ProN",sans-serif;
      background:#fff0f8;
      padding:20px;
      color:#222;
      transition:.25s;
    }
    body.dark{background:#121212;color:#eaeaea}

    .thread{
      border:2px solid #ffc6e6;
      background:#fff7fc;
      border-radius:14px;
      padding:14px;
      margin:14px 0;
      box-shadow:0 2px 6px rgba(255,150,210,.25);
    }
    body.dark .thread{
      background:#1b1b1b;
      border-color:#555;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }

    button{
      padding:6px 10px;
      margin:4px;
      border-radius:6px;
      cursor:pointer;
    }
    body.dark button{
      background:#333;
      color:#eee;
      border:1px solid #666;
    }

    input,textarea{
      width:100%;
      padding:6px;
      margin:4px 0;
      border-radius:6px;
      border:1px solid #ccc;
      box-sizing:border-box;
    }
    body.dark input,body.dark textarea{
      background:#222;
      color:#eee;
      border-color:#555;
    }

    a{color:#ff4fa8;text-decoration:none}
    a:hover{text-decoration:underline}

    .admin-badge{
      color:#ff9800;
      font-weight:bold;
      margin-left:4px;
    }
  </style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURL">
<button id="saveProfile">ä¿å­˜</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>

<hr>

<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>
<button id="adminOffBtn" style="display:none;">ç®¡ç†äººè§£é™¤</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain:"keijiban-7c651.firebaseapp.com",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId:"keijiban-7c651",
  storageBucket:"keijiban-7c651.appspot.com",
  messagingSenderId:"342192640264",
  appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true"){
  document.body.classList.add("dark");
  darkToggle.textContent="â˜€ï¸";
}
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const on=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",on);
  darkToggle.textContent=on?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

saveProfile.onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
let userId=localStorage.getItem("usakira_userId");
if(!userId){
  userId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId",userId);
}
let isAdmin=localStorage.getItem("usakira_admin")==="true";

/* ç®¡ç†äººè§£é™¤ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡ */
const adminOffBtn=document.getElementById("adminOffBtn");
if(isAdmin) adminOffBtn.style.display="inline-block";

adminOffBtn.onclick=()=>{
  localStorage.removeItem("usakira_admin");
  alert("ç®¡ç†äººã‚’è§£é™¤ã—ãŸã‚ˆ");
  location.reload();
};

/* ã‚¹ãƒ¬ä½œæˆ */
createThread.onclick=async()=>{
  if(!threadTitle.value.trim()) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const key=push(ref(db,"threads")).key;
  await set(ref(db,"threads/"+key),{
    title:threadTitle.value.trim(),
    body:threadBody.value.trim(),
    pass:threadPass.value.trim()||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  });
  location.href="thread.html?id="+key;
};

/* ã‚¹ãƒ¬ä¸€è¦§ */
onValue(ref(db,"threads"),snap=>{
  const box=document.getElementById("threads");
  box.innerHTML="";
  const data=snap.val()||{};
  Object.entries(data).sort((a,b)=>b[1].time-a[1].time).forEach(([id,t])=>{
    const div=document.createElement("div");
    div.className="thread";
    div.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center;">
        <img src="${t.ownerIcon}" width="48" height="48"
          style="border-radius:50%;object-fit:cover;border:2px solid #ffb8e6"
          onerror="this.src='${defaultIcon}'">
        <div>
          <b><a href="thread.html?id=${id}">${t.title}</a></b>
          ${isAdmin?'<span class="admin-badge">ğŸ‘‘</span>':""}
          <br>
          <small>by ${t.ownerName} ${t.pass?"ğŸ”’":""}</small>
        </div>
      </div>
      ${t.body?`<p style="margin:6px 0 0;">${t.body}</p>`:""}
      <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:.8rem;color:#aa7;">
        <span>${new Date(t.time).toLocaleString()}</span>
        <span class="del"></span>
      </div>
    `;
    if(userId===t.ownerId||isAdmin){
      const d=document.createElement("button");
      d.textContent="ã‚¹ãƒ¬å‰Šé™¤";
      d.onclick=async()=>{
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
          await set(ref(db,"threads/"+id),null);
          await set(ref(db,"posts/"+id),null);
        }
      };
      div.querySelector(".del").appendChild(d);
    }
    box.appendChild(div);
  });
});

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
adminBtn.onclick=()=>{
  if(prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")==="master"){
    localStorage.setItem("usakira_admin","true");
    location.href="report-admin.html";
  }else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
};
</script>

</body>
</html>
