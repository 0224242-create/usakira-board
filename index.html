<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:0.25s}
body.dark{background:#121212;color:#eaeaea}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer;transition:0.15s}
button:hover{opacity:0.85}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
body.dark input,body.dark textarea{background:#222;color:#eaeaea;border:1px solid #555}
a{text-decoration:underline;color:#d22}
.thread{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0;box-shadow:0 2px 6px rgba(255,150,210,0.25);transition:0.15s}
.thread:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(255,150,210,0.32)}
.thread.locked{background:#ccc;border-color:#999}
body.dark .thread{background:#1b1b1b;border-color:#555}
.thread h3 a{color:#ff4fa8;font-weight:bold;font-size:1.15rem;text-decoration:none}
.thread p{color:#444;margin:6px 0}
.thread .meta{font-size:0.85rem;color:#aa7}
.flex{display:flex;align-items:center;gap:10px}
.icon{width:48px;height:48px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<button id="adminToggle" style="position:fixed;left:12px;top:12px">ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* å…±é€š */
const userId = localStorage.getItem("usakira_userId");
const isAdmin = () => localStorage.getItem("usakira_admin")==="true";

/* ã‚¹ãƒ¬è¡¨ç¤º */
const threadsRef = ref(db,"threads");
onValue(threadsRef, snap=>{
  const box=document.getElementById("threads");
  box.innerHTML="";
  const data=snap.val()||{};
  for(const [id,t] of Object.entries(data)){
    const div=document.createElement("div");
    div.className="thread"+(t.pass?" locked":"");

    div.innerHTML=`
      <h3>
        <a href="#" data-id="${id}" data-pass="${t.pass||""}">
          ${t.title} ${t.pass?"ğŸ”’":""}
        </a>
      </h3>
      <div>by ${t.ownerName}</div>

      ${(userId===t.ownerId||isAdmin())?`
        <button class="lockBtn">ğŸ”’ éµå¤‰æ›´</button>
        <button class="delBtn">ğŸ—‘ å‰Šé™¤</button>
      `:""}
    `;

    /* éµã‚¹ãƒ¬å…¥å®¤ */
    div.querySelector("a").onclick=()=>{
      if(t.pass){
        const pw=prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã ã‚ˆğŸ° ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã­");
        if(pw!==t.pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ãƒšã‚³");
      }
      location.href=`thread.html?id=${id}`;
    };

    /* éµå¤‰æ›´ï¼ˆä¸»ã®ã¿ï¼‰ */
    const lockBtn=div.querySelector(".lockBtn");
    if(lockBtn) lockBtn.onclick=async()=>{
      const newPass=prompt("æ–°ã—ã„éµãƒ‘ã‚¹ï¼ˆç©ºã§è§£é™¤ï¼‰");
      await update(ref(db,"threads/"+id),{
        pass:newPass||null
      });
      alert("å¤‰æ›´ã—ãŸã‚ˆï¼");
    };

    /* å‰Šé™¤ï¼ˆä¸» or ç®¡ç†äººï¼‰ */
    const delBtn=div.querySelector(".delBtn");
    if(delBtn) delBtn.onclick=async()=>{
      if(!confirm("æœ¬å½“ã«å‰Šé™¤ã™ã‚‹ï¼ŸğŸ°")) return;
      await remove(ref(db,"threads/"+id));
      await remove(ref(db,"posts/"+id));
      alert("å‰Šé™¤ã—ãŸã‚ˆ");
    };

    box.appendChild(div);
  }
});
</script>
</body>
</html>
