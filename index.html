<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body {
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:0.25s;
}
body.dark { background:#121212;color:#eee; }

h1,h2 { margin-top:0; }

.thread {
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin:14px 0;
  box-shadow:0 2px 6px rgba(255,150,210,0.25);
  transition:0.15s;
}
.thread:hover {
  transform:translateY(-3px);
  box-shadow:0 6px 12px rgba(255,150,210,0.32);
}
.thread.locked { background:#ddd; border-color:#aaa; }

.thread h3 a { color:#ff4fa8; text-decoration:none; font-weight:bold; }
.thread h3 a:hover { text-decoration:underline; }

button { padding:6px 10px; margin:4px; border-radius:6px; cursor:pointer; }
button:hover { opacity:0.85; }

input,textarea { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }

img.icon {
  width:48px; height:48px;
  border-radius:50%; object-fit:cover; border:2px solid #ffb8e6;
  margin-right:10px;
}

.flex { display:flex; align-items:center; }
.flex-end { display:flex; justify-content:flex-end; }
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
<div id="profileBox">
  <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
  <input id="nameInput" placeholder="åå‰">
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
  <button id="saveProfile">ä¿å­˜</button>
</div>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div>
  <button id="sortNew">æ–°ã—ã„é †</button>
  <button id="sortReact">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †</button>
</div>
<div id="threads"></div>
<div id="paging"></div>

<hr>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸ã¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const now=document.body.classList.contains("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸãƒšã‚³");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

/* ç®¡ç†ãƒ•ãƒ©ã‚° */
const isAdmin = localStorage.getItem("usakira_admin")==="true";

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title=document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const body=document.getElementById("threadBody").value.trim();
  const pass=document.getElementById("threadPass").value.trim();
  const key=await push(ref(db,"threads"),{
    title,
    body,
    pass:pass||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  }).key;
  alert("ä½œæˆã—ãŸã‚ˆï¼");
  location.href=`thread.html?id=${key}`;
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ */
const PER=20;
let threadArr=[];
let sortBy='new';

onValue(ref(db,"threads"), snap=>{
  const data=snap.val()||{};
  threadArr=Object.entries(data);
  renderThreads(1);
});

document.getElementById("sortNew").onclick=()=>{
  sortBy='new'; renderThreads(1);
};
document.getElementById("sortReact").onclick=()=>{
  sortBy='react'; renderThreads(1);
};

async function renderThreads(page){
  if(sortBy==='new') threadArr.sort((a,b)=> (b[1].time||0)-(a[1].time||0));
  else{
    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°é †
    for(const [id, t] of threadArr){
      const postsSnap = await get(ref(db,`posts/${id}`));
      let reactCount=0;
      if(postsSnap.exists()){
        const posts=postsSnap.val();
        for(const pid in posts){
          reactCount+=Object.values(posts[pid].reactions||{}).reduce((a,b)=>a+b,0);
        }
      }
      t.reactCount = reactCount;
    }
    threadArr.sort((a,b)=> (b[1].reactCount||0)-(a[1].reactCount||0));
  }

  const start=(page-1)*PER;
  const pick=threadArr.slice(start,start+PER);
  const box=document.getElementById("threads");
  box.innerHTML="";

  for(const [id,t] of pick){
    const div=document.createElement("div");
    div.className="thread";
    if(t.pass) div.classList.add("locked");

    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°
    const postsSnap = await get(ref(db,`posts/${id}`));
    let commentCount=postsSnap.exists()?Object.keys(postsSnap.val()).length:0;

    div.innerHTML=`
      <div class="flex">
        <img src="${t.ownerIcon||defaultIcon}" class="icon" onerror="this.src='${defaultIcon}'">
        <div>
          <h3><a href="thread.html?id=${id}">${t.title||"ï¼ˆç„¡é¡Œï¼‰"}</a></h3>
          <div style="font-size:.85rem;color:#888;">
            by ${t.ownerName||defaultName} ${t.pass?"ğŸ”’":""} | ã‚³ãƒ¡ãƒ³ãƒˆ: ${commentCount}
          </div>
        </div>
      </div>
      ${t.body?`<p>${t.body}</p>`:""}
    `;

    box.appendChild(div);
  }

  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  const pages=Math.max(1,Math.ceil(threadArr.length/PER));
  const pg=document.getElementById("paging");
  pg.innerHTML="";
  for(let i=1;i<=pages;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>renderThreads(i);
    pg.appendChild(b);
  }
}

/* ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ */
document.getElementById("adminBtn").onclick=()=>{
  if(isAdmin) location.href="import.html";
  else{
    const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw==="master"){
      localStorage.setItem("usakira_admin","true");
      location.href="import.html";
    } else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
  }
};
</script>
</body>
</html>
