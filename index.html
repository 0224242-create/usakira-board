<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family:"Hiragino Kaku Gothic ProN", sans-serif;
      background:#fff0f8;
      padding:20px;
      color:#222;
      transition:0.25s;
    }
    body.dark {
      background:#121212;
      color:#eaeaea;
    }

    .thread {
      border:2px solid #ffc6e6;
      background:#fff7fc;
      border-radius:14px;
      padding:14px;
      margin:14px 0;
      box-shadow:0 2px 6px rgba(255,150,210,0.25);
    }
    body.dark .thread {
      background:#1b1b1b;
      border-color:#555;
    }

    button {
      padding:6px 10px;
      margin:4px;
      border-radius:6px;
      cursor:pointer;
    }
    input, textarea {
      width:100%;
      padding:6px;
      margin:4px 0;
      border-radius:6px;
      border:1px solid #ccc;
      box-sizing:border-box;
    }
    body.dark input, body.dark textarea {
      background:#222;
      color:#eee;
      border-color:#555;
    }
  </style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px;">ğŸŒ™</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURL">
<button id="saveProfile">ä¿å­˜</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>
<div id="paging"></div>

<hr>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.appspot.com",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
const savedDark = localStorage.getItem("usakira_dark") === "true";
if (savedDark) document.body.classList.add("dark");
darkToggle.textContent = savedDark ? "â˜€ï¸" : "ğŸŒ™";

darkToggle.onclick = () => {
  const now = !document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark", now);
  darkToggle.textContent = now ? "â˜€ï¸" : "ğŸŒ™";
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName = "åã‚‚ãªãå…";
const defaultIcon = "usagi.png.jpeg";

const nameInput = document.getElementById("nameInput");
const iconInput = document.getElementById("iconInput");

nameInput.value = localStorage.getItem("usakira_name") || defaultName;
iconInput.value = localStorage.getItem("usakira_icon") || defaultIcon;

document.getElementById("saveProfile").onclick = () => {
  localStorage.setItem("usakira_name", nameInput.value);
  localStorage.setItem("usakira_icon", iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
let userId = localStorage.getItem("usakira_userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).slice(2);
  localStorage.setItem("usakira_userId", userId);
}

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
document.getElementById("createThread").onclick = async () => {
  const title = threadTitle.value.trim();
  if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");

  const key = push(ref(db, "threads")).key;
  await set(ref(db, "threads/" + key), {
    title,
    body: threadBody.value,
    pass: threadPass.value || null,
    ownerId: userId,
    ownerName: nameInput.value || defaultName,
    ownerIcon: iconInput.value || defaultIcon,
    time: Date.now()
  });

  location.href = "thread.html?id=" + key;
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ */
const PER = 20;
let threadArr = [];

onValue(ref(db, "threads"), snap => {
  const data = snap.val() || {};
  threadArr = Object.entries(data).sort((a,b)=>b[1].time-a[1].time);
  renderThreads(1);
});

function renderThreads(page) {
  const box = document.getElementById("threads");
  box.innerHTML = "";

  threadArr.slice((page-1)*PER, page*PER).forEach(([id,t])=>{
    const div = document.createElement("div");
    div.className = "thread";
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;">
        <img src="${t.ownerIcon}" width="48" height="48"
          style="border-radius:50%;object-fit:cover"
          onerror="this.src='${defaultIcon}'">
        <div>
          <a href="thread.html?id=${id}"><b>${t.title}</b></a><br>
          <small>by ${t.ownerName} ${t.pass ? "ğŸ”’" : ""}</small>
        </div>
      </div>
      ${t.body ? `<p>${t.body}</p>` : ""}
      <small>${new Date(t.time).toLocaleString()}</small>
    `;

    const del = document.createElement("button");
    del.textContent = "ã‚¹ãƒ¬å‰Šé™¤";
    del.onclick = async () => {
      if (userId === t.ownerId || prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")==="master") {
        await set(ref(db,"threads/"+id), null);
        alert("å‰Šé™¤ã—ãŸã‚ˆï¼");
      } else {
        alert("å‰Šé™¤ã§ããªã„ãƒšã‚³");
      }
    };

    div.appendChild(del);
    box.appendChild(div);
  });
}

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick = ()=>{
  if (prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")==="master") {
    location.href="report-admin.html";
  } else {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
  }
};
</script>

</body>
</html>
