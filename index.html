<script>
  const postsDiv = document.getElementById("posts");
  const form = document.getElementById("commentForm");

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function linkify(text) {
    const urlPattern = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
  }

  function renderPosts(data) {
    postsDiv.innerHTML = "";
    const posts = data ? Object.values(data) : [];
    posts.forEach((p, index) => {
      if(!p.reactions) p.reactions = {carrot:0, spark:0};
      const div = document.createElement("div");
      div.className = "post";
      const commentHtml = linkify(p.comment + " „Éö„Ç≥");
      div.innerHTML = `
        <div class="post-number">${index + 1}</div>
        <img src="${p.icon}" alt="„Ç¢„Ç§„Ç≥„É≥">
        <div class="post-content">
          <span class="name">${p.name}</span>
          <span class="time">${p.time}</span>
          <div class="comment-text">${commentHtml}</div>
          <div class="reactions">
            <span class="reaction-button" data-type="carrot">ü•ï ${p.reactions.carrot}</span>
            <span class="reaction-button" data-type="spark">‚ú® ${p.reactions.spark}</span>
          </div>
        </div>
        <button class="delete-button">ÂâäÈô§</button>
      `;
      postsDiv.appendChild(div);

      // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ
      div.querySelectorAll(".reaction-button").forEach(btn => {
        btn.addEventListener("click", () => {
          const type = btn.getAttribute("data-type");
          p.reactions[type]++;
          db.ref("posts").child(p.id).set(p);
        });
      });

      // ÂâäÈô§„Éú„Çø„É≥
      div.querySelector(".delete-button").addEventListener("click", () => {
        const currentUser = document.getElementById("name").value || "ÂêçÁÑ°„Åó";
        if(currentUser === p.author) {
          db.ref("posts").child(p.id).remove();
        } else {
          alert("Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Åó„ÅãÂâäÈô§„Åß„Åç„Åæ„Åõ„Çì");
        }
      });
    });
  }

  // ÊäïÁ®ø„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÁõ£Ë¶ñ
  db.ref("posts").on("value", snapshot => {
    renderPosts(snapshot.val());
  });

  // ÊäïÁ®ø
  form.addEventListener("submit", function(e){
    e.preventDefault();
    const name = document.getElementById("name").value || "ÂêçÁÑ°„Åó";
    const icon = document.getElementById("icon").value || "usagi.png.jpeg";
    const comment = document.getElementById("comment").value.trim();
    if(!comment) return;

    const time = new Date().toLocaleString();
    const newPostRef = db.ref("posts").push();
    const id = newPostRef.key;

    newPostRef.set({
      id,
      author: name, // ÊäïÁ®øËÄÖ„Çí‰øùÂ≠ò
      name,
      icon,
      comment,
      time,
      reactions: {carrot:0, spark:0}
    });

    document.getElementById("comment").value = "";
  });
</script>
