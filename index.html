<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:0.25s;
}
body.dark{background:#121212;color:#eaeaea}

button{
  padding:6px 10px;
  margin:4px;
  border-radius:6px;
  cursor:pointer;
}
input,textarea{
  width:100%;
  padding:6px;
  margin:4px 0;
  box-sizing:border-box;
  border-radius:6px;
  border:1px solid #ccc;
}
body.dark input,body.dark textarea{
  background:#222;color:#eaeaea;border:1px solid #555;
}

.thread{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin:14px 0;
}
.thread.locked{background:#ddd}
body.dark .thread{background:#1b1b1b;border-color:#555}

.flex{display:flex;gap:10px;align-items:center}
.icon{
  width:48px;height:48px;border-radius:50%;
  object-fit:cover;border:2px solid #ffb8e6;
}
</style>
</head>

<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<button id="adminToggle" style="position:fixed;left:12px;top:12px">ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<button id="saveProfile">ä¿å­˜</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<select id="sortSelect">
  <option value="new">æ–°ã—ã„é †</option>
  <option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †ï¼ˆä»®ï¼‰</option>
</select>

<div id="threads"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("dark",document.body.classList.contains("dark")?"1":"0");
};

/* ç®¡ç†äºº */
const adminToggle=document.getElementById("adminToggle");
function updateAdmin(){
  adminToggle.textContent=
    localStorage.getItem("admin")==="1" ? "ç®¡ç†äººãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ğŸ‘‘" : "ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³";
}
updateAdmin();
adminToggle.onclick=()=>{
  if(localStorage.getItem("admin")==="1"){
    localStorage.removeItem("admin");
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸãƒšã‚³");
  }else{
    if(prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")==="master"){
      localStorage.setItem("admin","1");
      alert("ç®¡ç†äººã«ãªã£ãŸãƒšã‚³ ğŸ‘‘");
    }else alert("é•ã†ãƒšã‚³");
  }
  updateAdmin();
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("name")||defaultName;
iconInput.value=localStorage.getItem("icon")||defaultIcon;
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("name",nameInput.value);
  localStorage.setItem("icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
let userId=localStorage.getItem("uid");
if(!userId){
  userId="u_"+Math.random().toString(36).slice(2);
  localStorage.setItem("uid",userId);
}

/* ã‚¹ãƒ¬ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title=document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const pass=document.getElementById("threadPass").value.trim();

  await push(ref(db,"threads"),{
    title,
    pass:pass||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  });

  document.getElementById("threadTitle").value="";
  document.getElementById("threadPass").value="";
  alert("ã‚¹ãƒ¬ä½œã£ãŸã‚ˆï¼");
};

/* ã‚¹ãƒ¬ä¸€è¦§ï¼ˆè¶…å®‰å®šç‰ˆï¼‰ */
const threadsRef=ref(db,"threads");
let threadArr=[];

onValue(threadsRef,snap=>{
  threadArr=Object.entries(snap.val()||{});
  renderThreads();
});

const sortSelect=document.getElementById("sortSelect");
sortSelect.onchange=renderThreads;

function renderThreads(){
  const box=document.getElementById("threads");
  box.innerHTML="";
  let arr=[];

  for(const [id,t] of threadArr){
    arr.push({...t,id});
  }

  if(sortSelect.value==="new"){
    arr.sort((a,b)=>b.time-a.time);
  }

  for(const t of arr){
    const div=document.createElement("div");
    div.className="thread"+(t.pass?" locked":"");
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${t.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <h3>${t.title}</h3>
          <div style="font-size:0.85rem;color:#888">
            by ${t.ownerName||defaultName} ${t.pass?"ğŸ”’":""}
          </div>
        </div>
      </div>
      <div style="font-size:0.8rem;color:#aaa">
        ${new Date(t.time).toLocaleString()}
      </div>
    `;
    box.appendChild(div);
  }
}
</script>
</body>
</html>
