<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff0f8;padding:20px;color:#222;transition:0.25s}
body.dark{background:#121212;color:#eaeaea}
button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer;transition:0.15s}
button:hover{opacity:0.85}
input,textarea{padding:6px;margin:4px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc}
body.dark input,body.dark textarea{background:#222;color:#eaeaea;border:1px solid #555}
a{text-decoration:underline;color:#d22}
.thread{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0;box-shadow:0 2px 6px rgba(255,150,210,0.25);transition:0.15s}
.thread:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(255,150,210,0.32)}
.thread.locked{background:#ccc;border-color:#999}
body.dark .thread{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
body.dark .thread:hover{box-shadow:0 6px 12px rgba(0,0,0,0.5)}
.thread h3 a{color:#ff4fa8;font-weight:bold;font-size:1.15rem;text-decoration:none}
body.dark .thread h3 a{color:#ff8cd1}
.thread p{color:#444;margin:6px 0}
.thread .meta{font-size:0.85rem;color:#aa7}
.flex{display:flex;align-items:center;gap:10px}
.icon{width:48px;height:48px;border-radius:50%;border:2px solid #ffb8e6;object-fit:cover}
body.dark .icon{border-color:#ff8cd1}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<button id="adminToggle" style="position:fixed;left:12px;top:12px">ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div id="profileBox">
<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<button id="saveProfile">ä¿å­˜</button>
</div>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div>
<label>ä¸¦ã³é †:</label>
<select id="sortSelect">
<option value="new">æ–°ã—ã„é †</option>
<option value="reaction">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †</option>
</select>
</div>
<div id="threads"></div>

<hr>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const now=!(document.body.classList.contains("dark"));
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ */
const adminToggle=document.getElementById("adminToggle");
function updateAdminBtn(){
  const isAdmin=localStorage.getItem("usakira_admin")==="true";
  adminToggle.textContent=isAdmin?"ç®¡ç†äººãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ğŸ‘‘":"ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³";
}
updateAdminBtn();
adminToggle.onclick=()=>{
  const isAdmin=localStorage.getItem("usakira_admin")==="true";
  if(isAdmin){
    localStorage.removeItem("usakira_admin");
    alert("ç®¡ç†äººãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸãƒšã‚³");
  } else {
    const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw==="master"){
      localStorage.setItem("usakira_admin","true");
      alert("ç®¡ç†äººã«ãªã£ãŸãƒšã‚³ ğŸ‘‘");
    } else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
  }
  updateAdminBtn();
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title=document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const pass=document.getElementById("threadPass").value.trim();

  const key=(await push(ref(db,"threads"),{
    title,
    pass:pass||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  })).key;

  alert("ä½œæˆã—ãŸã‚ˆï¼");
  location.href=`thread.html?id=${key}`;
};

/* ã‚¹ãƒ¬ä¸€è¦§è¡¨ç¤º */
const PER=20;
let threadArr=[];
const threadsRef=ref(db,"threads");

onValue(threadsRef, snap=>{
  const data=snap.val()||{};
  threadArr=Object.entries(data);
  renderThreads();
});

const sortSelect=document.getElementById("sortSelect");
sortSelect.onchange=()=>renderThreads();

async function renderThreads(){
  const box=document.getElementById("threads");
  box.innerHTML="";
  let arr=[];
  for(const [id,t] of threadArr){
    const postsSnap = await get(ref(db,"posts/"+id));
    const posts = postsSnap.val()||{};
    const commentCount = Object.keys(posts).length;
    let reactionTotal = 0;
    for(const pid in posts){
      reactionTotal += posts[pid].reactions?.total || 0;
    }
    arr.push({...t,id,commentCount,reactionTotal});
  }

  // ä¸¦ã³æ›¿ãˆ
  if(sortSelect.value==="reaction") arr.sort((a,b)=>b.reactionTotal-a.reactionTotal);
  else arr.sort((a,b)=>b.time-a.time);

  for(const t of arr){
    const div=document.createElement("div");
    div.className="thread"+(t.pass?" locked":"");
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${t.ownerIcon||defaultIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <h3><a href="thread.html?id=${t.id}">${t.title||"ï¼ˆç„¡é¡Œï¼‰"}</a></h3>
          <div style="font-size:0.9rem;color:#888">
            by ${t.ownerName||defaultName} ${t.pass?"ğŸ”’":""}
          </div>
        </div>
      </div>
      <p>ã‚³ãƒ¡ãƒ³ãƒˆæ•°: ${t.commentCount} ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆè¨ˆ: ${t.reactionTotal}</p>
      <p class="meta">${new Date(t.time).toLocaleString()}</p>
    `;
    box.appendChild(div);
  }
}

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick=()=>{
  const isAdmin=localStorage.getItem("usakira_admin")==="true";
  if(!isAdmin){
    const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw==="master") localStorage.setItem("usakira_admin","true");
    else return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
  }
  location.href="report-admin.html";
};
</script>
</body>
</html>ã€€
