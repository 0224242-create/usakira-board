<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;padding:20px;background:#fff0f8;color:#222;transition:.25s;}
body.dark{background:#121212;color:#eee;}
h1,h2{margin-top:0;}
button{padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer;}
input{width:100%;padding:6px;margin:4px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
body.dark input{background:#222;color:#eee;border:1px solid #555;}
.thread{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:10px;margin:10px 0;box-shadow:0 2px 6px rgba(255,150,210,.25);}
body.dark .thread{background:#1b1b1b;border-color:#555;box-shadow:0 2px 6px rgba(0,0,0,.3);}
.thread.locked{background:#ccc;}
.thread h3 a{color:#ff4fa8;text-decoration:none;}
body.dark .thread h3 a{color:#ff8cd1;}
.flex{display:flex;align-items:center;gap:10px;}
.column{display:flex;flex-direction:column;}
.icon{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6;}
body.dark .icon{border-color:#ff8cd1;}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div id="profileBox">
  <input id="nameInput" placeholder="åå‰">
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
  <button id="saveProfile">ä¿å­˜</button>
  <button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>
</div>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ãƒ‘ã‚¹ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ä½œæˆ</button>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<button id="sortNew">æ–°ç€é †</button>
<button id="sortHot">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é †</button>
<div id="threads"></div>

<div id="paging"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

/* ç®¡ç†äººãƒ•ãƒ©ã‚° */
const isAdmin = localStorage.getItem("usakira_admin")==="true";

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle = document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId = localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const nameInput = document.getElementById("nameInput");
const iconInput = document.getElementById("iconInput");
nameInput.value = localStorage.getItem("usakira_name") || "åã‚‚ãªãå…";
iconInput.value = localStorage.getItem("usakira_icon") || "usagi.png.jpeg";
document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸãƒšã‚³");
};

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick=()=>{
  if(isAdmin) location.href="import.html";
  else alert("ç®¡ç†è€…ã˜ã‚ƒãªã„ãƒšã‚³");
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title = document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const body = document.getElementById("threadBody").value.trim();
  const pass = document.getElementById("threadPass").value.trim();
  const key = (await push(ref(db,"threads"),{
    title,
    body,
    pass: pass||null,
    ownerId: userId,
    ownerName: nameInput.value||"åã‚‚ãªãå…",
    ownerIcon: iconInput.value||"usagi.png.jpeg",
    time: Date.now()
  })).key;
  location.href=`thread.html?id=${key}`;
};

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§è¡¨ç¤º */
let threadArr=[];
const PER=20;
let sortBy="new";
onValue(ref(db,"threads"), async snap=>{
  const data = snap.val()||{};
  threadArr = await Promise.all(Object.entries(data).map(async([id,t])=>{
    const postsSnap = await get(ref(db,`posts/${id}`));
    const posts = postsSnap.val()||{};
    let reactionCount=0;
    let commentCount = Object.keys(posts).length;
    Object.values(posts).forEach(c=>{
      if(c.reactions) reactionCount += Object.keys(c.reactions).reduce((sum,k)=>sum+Object.keys(c.reactions[k]).length,0);
    });
    return [id,t,reactionCount,commentCount];
  }));
  renderThreads(1);
});

function renderThreads(page){
  let arr = [...threadArr];
  if(sortBy==="new") arr.sort((a,b)=>b[1].time - a[1].time);
  else arr.sort((a,b)=>b[2]-a[2]);

  const start=(page-1)*PER;
  const pick=arr.slice(start,start+PER);

  const box=document.getElementById("threads");
  box.innerHTML="";
  pick.forEach(([id,t,reactionCount,commentCount])=>{
    const div=document.createElement("div");
    div.className="thread";
    if(t.pass) div.classList.add("locked");
    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${t.ownerIcon||'usagi.png.jpeg'}" onerror="this.src='usagi.png.jpeg'">
        <div>
          <h3><a href="thread.html?id=${id}">${t.title||"(ç„¡é¡Œ)"}</a></h3>
          <div style="font-size:.85rem;color:#888">
            by ${t.ownerName||"åã‚‚ãªãå…"} ${t.pass?"ğŸ”’":""} | ã‚³ãƒ¡ãƒ³ãƒˆ ${commentCount} | ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ${reactionCount}
          </div>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  const pages = Math.max(1,Math.ceil(threadArr.length/PER));
  const pgDiv = document.getElementById("paging");
  pgDiv.innerHTML="";
  for(let i=1;i<=pages;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>renderThreads(i);
    pgDiv.appendChild(b);
  }
}

/* ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
document.getElementById("sortNew").onclick=()=>{sortBy="new"; renderThreads(1);}
document.getElementById("sortHot").onclick=()=>{sortBy="hot"; renderThreads(1);}
</script>
</body>
</html>
