<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
<style>
  body { font-family: sans-serif; background:#fafafa; padding:20px; transition:0.3s; }
  .dark { background:#1a1a1a; color:#fff; }
  textarea { width:100%; height:70px; }
  .post { border-bottom:1px solid #ccc; padding:8px; margin:6px 0; }
  .delete { cursor:pointer; color:red; font-size:12px; }
  .page-btn { margin:3px; cursor:pointer; }
  .locked { color:#888; }
</style>
</head>
<body>
<h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>
<button id="toggleDark">ğŸŒ‘ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
<hr>

<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
åå‰ <input id="nameInput"><br>
ã‚¢ã‚¤ã‚³ãƒ³URL <input id="iconInput" style="width:70%">
<button onclick="saveProfile()">ä¿å­˜</button>
<hr>

<h3>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h3>
ã‚¿ã‚¤ãƒˆãƒ« <input id="titleInput"><br>
æœ¬æ–‡<textarea id="bodyInput"></textarea><br>
éµã‚¹ãƒ¬ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(ä»»æ„) <input id="passInput"><br>
<button onclick="createThread()">ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</button>
<hr>

<h2>ğŸ“Œ ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>
<div id="paging"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX",
  databaseURL: "XXXX",
  projectId: "XXXX",
  storageBucket: "XXXX",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åˆæœŸè¨­å®š
let profile = {
  name: localStorage.name || "åã‚‚ãªãå…",
  icon: localStorage.icon || "usagi.png.jpeg"
};
document.getElementById("nameInput").value = profile.name;
document.getElementById("iconInput").value = profile.icon;
function saveProfile() {
  profile.name = document.getElementById("nameInput").value || "åã‚‚ãªãå…";
  profile.icon = document.getElementById("iconInput").value || "usagi.png.jpeg";
  localStorage.name = profile.name;
  localStorage.icon = profile.icon;
  alert("ä¿å­˜ã—ãŸãƒšã‚³");
}

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
let dark = localStorage.dark === "true";
if(dark) document.body.classList.add("dark");
document.getElementById("toggleDark").onclick = () => {
  dark = !dark;
  localStorage.dark = dark;
  document.body.classList.toggle("dark");
};

// ã‚¹ãƒ¬ä½œæˆ
function createThread() {
  const title = titleInput.value.trim();
  const body = bodyInput.value.trim();
  const pass = passInput.value.trim();
  if(!title || !body) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡æ›¸ã‘ãƒšã‚³");
  const t = ref(db,"threads");
  push(t,{
    title,
    body,
    pass: pass || "",
    name: profile.name,
    icon: profile.icon,
    time: Date.now(),
    banned: ""
  });
  titleInput.value = "";
  bodyInput.value = "";
  passInput.value = "";
}

// BAN
function banUser(name) {
  if(prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰") !== "master") return;
  update(ref(db,"ban"), { [name]: true });
  alert(name+" ã‚’BANã—ã¾ã—ãŸ");
}

// ã‚¹ãƒ¬è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
const PER = 20;
let page = 1;
onValue(ref(db,"threads"), snap => {
  const data = snap.val() || {};
  let arr = Object.entries(data).sort((a,b)=>b[1].time-a[1].time);
  render(arr);
});
function render(arr) {
  const banned = {};
  onValue(ref(db,"ban"), s => Object.assign(banned,s.val()||{}),{onlyOnce:true});

  const start = (page-1)*PER;
  const pick = arr.slice(start,start+PER);
  threads.innerHTML = "";

  pick.forEach(([key,v])=>{
    if(v.banned || banned[v.name]) return;
    let html = `<div class="post">
      <img src="${v.icon}" width="32" height="32">
      <b>${v.title}</b><br>
      by ${v.name} <button onclick="banUser('${v.name}')">BAN</button><br>`;
    if(v.pass) html += `<span class="locked">ğŸ”’éµã‚¹ãƒ¬</span><br>`;
    html += `<a href="thread.html?id=${key}" target="_blank">é–‹ã</a><br>`;
    html += `<span class="delete" onclick="delThread('${key}','${v.name}')">å‰Šé™¤</span>
    </div>`;
    threads.insertAdjacentHTML("beforeend",html);
  });

  paging.innerHTML = "";
  const pages = Math.ceil(arr.length / PER);
  for(let i=1;i<=pages;i++){
    paging.insertAdjacentHTML("beforeend",
      `<button class="page-btn" onclick="page=${i};render(arr)"> ${i} </button>`);
  }
}
window.delThread = (key,name)=>{
  if(name !== profile.name && prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")!=="master") return;
  remove(ref(db,"threads/"+key));
};
window.banUser = banUser;
</script>
</body>
</html>
