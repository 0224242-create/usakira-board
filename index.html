<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿ï¼ˆå®Œå…¨ç‰ˆ / ç‰¢ç„BANç®¡ç†ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family:"Hiragino Kaku Gothic ProN", sans-serif; padding:20px; background:#fffafc; color:#222; }
    .dark { background:#121212; color:#eaeaea; }
    .thread { border:1px solid #ffd4ea; padding:12px; border-radius:8px; margin:8px 0; background:#fff; }
    .thread .meta { font-size:13px; color:#666; margin-top:6px; }
    .icon { width:36px; height:36px; border-radius:50%; vertical-align:middle; margin-right:8px; }
    input, textarea { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
    button { padding:8px 12px; margin:6px 4px 6px 0; cursor:pointer; }
    .small { font-size:12px; color:#666; }
    .locked { color:#aa8; }

    /* ç‰¢ç„POPUP */
    #jail {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9);
      color:#eaeaea;
      padding:30px;
      overflow-y:auto;
    }
    #jailBox {
      border:3px solid #666;
      border-radius:10px;
      padding:18px;
      background:linear-gradient(#2a2a2a,#111);
      box-shadow:inset 0 0 25px black;
    }
    .bars {
      width:100%; height:16px;
      background:repeating-linear-gradient(90deg, #222 0 14px, #666 14px 18px);
      margin:8px 0;
    }
    .banEntry {
      border-bottom:1px solid #444; padding:6px;
      display:flex; align-items:center; justify-content:space-between;
    }
  </style>
</head>
<body>
  <button id="darkToggle" style="position:fixed; top:12px; right:12px;">ğŸŒ™</button>
  <h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>

  <button id="openJail" style="background:#222; color:#fff;">ğŸš¨ BANç®¡ç†ï¼ˆç‰¢ç„ï¼‰</button>
  <hr>

  <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
  <section>
    <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
    <label>åå‰</label>
    <input id="profileName" placeholder="åã‚‚ãªãå…">
    <label>ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURLï¼ˆä»»æ„ï¼‰</label>
    <input id="profileIcon" placeholder="usagi.png.jpeg">
    <button id="saveProfileBtn">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜</button>
    <p class="small">â€»åå‰æœªè¨­å®šã¯ã€Œåã‚‚ãªãå…ã€ã«ãªã‚Šã¾ã™</p>
  </section>
  <hr>

  <!-- ã‚¹ãƒ¬ä½œæˆ -->
  <section>
    <h3>ã‚¹ãƒ¬ä½œæˆ</h3>
    <input id="newTitle" placeholder="ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰">
    <textarea id="newBody" placeholder="æœ€åˆã®æœ¬æ–‡ï¼ˆå¿…é ˆï¼‰"></textarea>
    <input id="newPass" placeholder="éµã‚¹ãƒ¬ã«ã™ã‚‹ãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
    <button id="createThreadBtn">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>
  </section>
  <hr>

  <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ -->
  <section>
    <h3>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h3>
    <div id="threadList">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div id="threadPaging" style="margin-top:8px;"></div>
  </section>

  <!-- ç‰¢ç„(BANç®¡ç†) -->
  <div id="jail">
    <div id="jailBox">
      <div class="bars"></div>
      <h2>ğŸ‘ BANã•ã‚ŒãŸè€…ãŸã¡ã®ç‰¢ç„</h2>
      <div class="bars"></div>
      <div id="banList">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="bars"></div>
      <button id="closeJail" style="margin-top:12px;">ğŸ”“ é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
      authDomain: "keijiban-7c651.firebaseapp.com",
      databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
      projectId: "keijiban-7c651",
      storageBucket: "keijiban-7c651.firebasestorage.app",
      messagingSenderId: "342192640264",
      appId: "1:342192640264:web:a004a725b470741aaf1cbd",
      measurementId: "G-7E1BZ3BGBR"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ */
    let userId = localStorage.getItem("usakira_userId");
    if (!userId) {
      userId = "user_" + Math.random().toString(36).slice(2);
      localStorage.setItem("usakira_userId", userId);
    }
    const defaultName = "åã‚‚ãªãå…";
    const defaultIcon = "usagi.png.jpeg";

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
    const profileNameEl = document.getElementById("profileName");
    const profileIconEl = document.getElementById("profileIcon");
    profileNameEl.value = localStorage.getItem("usakira_name") || defaultName;
    profileIconEl.value = localStorage.getItem("usakira_icon") || defaultIcon;

    document.getElementById("saveProfileBtn").addEventListener("click", () => {
      localStorage.setItem("usakira_name", profileNameEl.value.trim() || defaultName);
      localStorage.setItem("usakira_icon", profileIconEl.value.trim() || defaultIcon);
      alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã—ãŸãƒšã‚³");
    });

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
    const darkToggle = document.getElementById("darkToggle");
    const applyDark = (x)=>{ if(x)document.body.classList.add("dark"); else document.body.classList.remove("dark"); darkToggle.textContent = x?"â˜€ï¸":"ğŸŒ™"; }
    applyDark(localStorage.getItem("usakira_dark")==="true");
    darkToggle.onclick = () => {
      const now = !(localStorage.getItem("usakira_dark")==="true");
      localStorage.setItem("usakira_dark",now);
      applyDark(now);
    };

    /* BANãƒã‚§ãƒƒã‚¯ */
    async function banned(id){ const s = await get(ref(db,`bans/${id}`)); return s.exists(); }

    /* ã‚¹ãƒ¬ä½œæˆ */
    document.getElementById("createThreadBtn").onclick = async () => {
      if (await banned(userId)) return alert("BANã•ã‚Œã¦ã„ã‚‹ãŸã‚æŠ•ç¨¿ã§ãã¾ã›ã‚“ğŸ‡ğŸš«");
      const title=document.getElementById("newTitle").value.trim();
      const body=document.getElementById("newBody").value.trim();
      const pass=document.getElementById("newPass").value.trim();
      if(!title||!body) return alert("å¿…é ˆé …ç›®ãŒè¶³ã‚Šãªã„ãƒšã‚³");
      await push(ref(db,"threads"),{
        title, body, pass:pass||"", ownerId:userId,
        ownerName:localStorage.getItem("usakira_name")||defaultName,
        ownerIcon:localStorage.getItem("usakira_icon")||defaultIcon,
        time:Date.now()
      });
      document.getElementById("newTitle").value="";
      document.getElementById("newBody").value="";
      document.getElementById("newPass").value="";
    };

    /* ã‚¹ãƒ¬è¡¨ç¤ºãƒ»ãƒšãƒ¼ã‚¸ãƒ³ã‚° */
    const PER=20;
    let threadArr=[];
    onValue(ref(db,"threads"),(snap)=>{
      const raw=snap.val()||{};
      threadArr=Object.entries(raw).sort((a,b)=>b[1].time-a[1].time);
      renderThreads(1);
    });

    function renderThreads(p=1){
      const start=(p-1)*PER;
      const pick=threadArr.slice(start,start+PER);
      const list=document.getElementById("threadList");
      list.innerHTML="";

      pick.forEach(([id,t])=>{
        const box=document.createElement("div");
        box.className="thread";
        box.innerHTML=`
          <img src="${t.ownerIcon||defaultIcon}" class="icon" onerror="this.src='${defaultIcon}'">
          <strong>${t.title}</strong>
          <div class="meta">by ${t.ownerName||defaultName}ãƒ»${new Date(t.time).toLocaleString()}</div>
          ${t.pass?'<div class="locked">ğŸ”’ éµã‚¹ãƒ¬</div>':''}
          <div style="margin-top:8px;">
            <button class="openBtn" data-id="${id}">é–‹ã</button>
            <button class="delBtn" data-id="${id}" data-owner="${t.ownerId}">å‰Šé™¤</button>
            <button class="banBtn" data-owner="${t.ownerId}">BAN</button>
          </div>
        `;
        list.appendChild(box);
      });

      const pages=Math.max(1,Math.ceil(threadArr.length/PER));
      const pageBox=document.getElementById("threadPaging");
      pageBox.innerHTML="";
      for(let i=1;i<=pages;i++){
        const b=document.createElement("button");
        b.textContent=i;
        b.onclick=()=>renderThreads(i);
        pageBox.appendChild(b);
      }

      document.querySelectorAll(".openBtn").forEach(b=>{
        b.onclick=()=>window.open("thread.html?id="+b.dataset.id,"_blank");
      });

      document.querySelectorAll(".delBtn").forEach(b=>{
        b.onclick=async()=>{
          const id=b.dataset.id, owner=b.dataset.owner;
          if(userId===owner){
            if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ await remove(ref(db,"threads/"+id)); await remove(ref(db,"posts/"+id)); }
            return;
          }
          const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if(pw==="master"){ await remove(ref(db,"threads/"+id)); await remove(ref(db,"posts/"+id)); alert("ç®¡ç†è€…å‰Šé™¤å®Œäº†"); }
        };
      });

      document.querySelectorAll(".banBtn").forEach(b=>{
        b.onclick=async()=>{
          const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if(pw!=="master") return alert("é•ã†ãƒšã‚³");
          await set(ref(db,"bans/"+b.dataset.owner),true);
          alert("BANã—ãŸãƒšã‚³");
        };
      });
    }

    /* ç‰¢ç„ç”»é¢ */
    const jail=document.getElementById("jail");
    document.getElementById("openJail").onclick=()=>{ jail.style.display="block"; };
    document.getElementById("closeJail").onclick=()=>{ jail.style.display="none"; };

    onValue(ref(db,"bans"),(snap)=>{
      const raw=snap.val()||{};
      const banList=document.getElementById("banList");
      if(Object.keys(raw).length===0){
        banList.innerHTML="<p>èª°ã‚‚æ•ã‚‰ã‚ã‚Œã¦ã„ãªã„â€¦å¹³å’Œã ğŸ‡</p>";
        return;
      }
      banList.innerHTML="";
      Object.keys(raw).forEach(uid=>{
        const row=document.createElement("div");
        row.className="banEntry";
        row.innerHTML=`
          <span>å›šäººIDï¼š${uid}</span>
          <button data-id="${uid}" class="unbanBtn">è§£é™¤</button>
        `;
        banList.appendChild(row);
      });

      document.querySelectorAll(".unbanBtn").forEach(btn=>{
        btn.onclick=async()=>{
          const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
          if(pw!=="master") return alert("é•ã†ãƒšã‚³");
          await remove(ref(db,"bans/"+btn.dataset.id));
          alert("é‡ˆæ”¾ã—ãŸãƒšã‚³");
        };
      });
    });
  </script>
</body>
</html>
