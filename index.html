<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</title>
  <style>
    body { font-family: "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN", sans-serif; padding: 20px; background: #fffafc; }
    h1 { color: #ff7ac6; }
    textarea { width: 100%; height: 80px; }
    .thread, .post {
      border: 1px solid #ffd4ea; background: #fff; padding: 12px;
      border-radius: 8px; margin: 10px 0;
    }
    .profile-block input { width: 100%; margin: 4px 0; }
    .reaction { cursor: pointer; margin: 0 6px; font-size: 22px; }
    .icon { width: 45px; height: 45px; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
    a { color: #0072ff; }
  </style>
</head>
<body>

<h1>ğŸ° ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿</h1>

<!-- ã‚¹ãƒ¬ä½œæˆ -->
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input type="text" id="threadTitle" placeholder="ã‚¹ãƒ¬ã‚¿ã‚¤ãƒˆãƒ«"><br>
<button onclick="createThread()">ã‚¹ãƒ¬ã‚’ç«‹ã¦ã‚‹</button>

<hr>

<!-- â–¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
<h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
<div class="profile-block">
  åå‰ï¼š<input type="text" id="profileName">
  ã²ã¨ã“ã¨ï¼š<input type="text" id="profileComment">
  ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURLï¼š<input type="text" id="profileIcon">
  <button onclick="saveProfile()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜</button>
</div>

<hr>

<!-- â–¼ã‚¹ãƒ¬ä¸€è¦§ -->
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threadList"></div>

<!-- â–¼æŠ•ç¨¿ç”»é¢ -->
<div id="threadView" style="display:none;">
  <h2 id="threadTitleView"></h2>
  <textarea id="postText" placeholder="æ›¸ãè¾¼ã¿å†…å®¹"></textarea><br>
  <button onclick="sendPost()">æŠ•ç¨¿</button>
  <button onclick="backToList()">æˆ»ã‚‹</button>
  <hr>
  <div id="postList"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.firebasestorage.app",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd",
  measurementId: "G-7E1BZ3BGBR"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* â– ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜) */
let userId = localStorage.getItem("userId");
if (!userId) {
  userId = "user_" + Math.random().toString(36).substring(2);
  localStorage.setItem("userId", userId);
}

/* â– ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const profileRef = db.ref("profiles");
const defaultIcon = "usagi.png.jpeg";

profileRef.child(userId).get().then(snap => {
  const p = snap.val();
  if (p) {
    profileName.value = p.name;
    profileComment.value = p.comment;
    profileIcon.value = p.icon;
  } else {
    profileIcon.value = defaultIcon;
  }
});

function saveProfile() {
  profileRef.child(userId).set({
    name: profileName.value,
    comment: profileComment.value,
    icon: profileIcon.value || defaultIcon
  });
  alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã—ãŸã‚ˆğŸ°");
}

/* â– ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
function createThread() {
  const title = threadTitle.value.trim();
  if (!title) return;
  const newThread = db.ref("threads").push({ title, owner: userId });
  threadTitle.value = "";
}

/* ã‚¹ãƒ¬è¡¨ç¤º */
function loadThreads() {
  threadList.innerHTML = "";
  db.ref("threads").on("value", snap => {
    threadList.innerHTML = "";
    const data = snap.val();
    for (let id in data) {
      const div = document.createElement("div");
      div.className = "thread";
      div.innerHTML = `<b>${data[id].title}</b><br>
      <button onclick="openThread('${id}', '${data[id].title}', '${data[id].owner}')">é–‹ã</button>`;
      threadList.appendChild(div);
    }
  });
}
loadThreads();

/* â– ã‚¹ãƒ¬ã‚’é–‹ã */
let currentThread = "";
let currentOwner = "";

function openThread(id, title, owner) {
  currentThread = id;
  currentOwner = owner;
  threadTitleView.textContent = title;
  threadView.style.display = "block";
  threadList.style.display = "none";
  loadPosts();
}

function backToList() {
  threadView.style.display = "none";
  threadList.style.display = "block";
}

/* â– æŠ•ç¨¿ */
function sendPost() {
  const text = postText.value.trim();
  if (!text) return;

  profileRef.child(userId).get().then(snap => {
    const p = snap.val() || { name: "åç„¡ã—", comment: "", icon: defaultIcon };

    db.ref("posts/" + currentThread).push({
      text,
      timestamp: Date.now(),
      name: p.name,
      comment: p.comment,
      icon: p.icon,
      uid: userId,
      carrot: 0,
      star: 0
    });
  });

  postText.value = "";
}

/* URLãƒªãƒ³ã‚¯åŒ– */
function linkify(t) {
  return t.replace(/https?:\/\/\S+/g, url => `<a href="${url}" target="_blank">${url}</a>`);
}

/* â– æŠ•ç¨¿èª­ã¿è¾¼ã¿ */
function loadPosts() {
  db.ref("posts/" + currentThread).on("value", snap => {
    postList.innerHTML = "";
    const data = snap.val();
    for (let id in data) {
      const p = data[id];
      const div = document.createElement("div");
      div.className = "post";

      const delBtn = (userId === currentOwner)
        ? `<button onclick="delPost('${id}')">å‰Šé™¤</button>`
        : "";

      div.innerHTML = `
        <img src="${p.icon}" class="icon">
        <b>${p.name}</b> (${p.comment})<br><br>
        ${linkify(p.text)}<br><br>
        <span class="reaction" onclick="react('${id}','carrot')">ğŸ¥• ${p.carrot}</span>
        <span class="reaction" onclick="react('${id}','star')">âœ¨ ${p.star}</span>
        ${delBtn}
      `;
      postList.appendChild(div);
    }
  });
}

/* â– ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
function react(id, type) {
  const ref = db.ref(`posts/${currentThread}/${id}/${type}`);
  ref.transaction(v => (v || 0) + 1);
}

/* â– å‰Šé™¤(ä¸»ã ã‘) */
function delPost(id) {
  db.ref(`posts/${currentThread}/${id}`).remove();
}
</script>
</body>
</html>
