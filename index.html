<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
}
body.dark{background:#121212;color:#eaeaea}

button{padding:6px 10px;margin:4px;border-radius:6px;cursor:pointer}
input,textarea{padding:6px;margin:4px 0;width:100%;border-radius:6px;border:1px solid #ccc}

.thread{border:2px solid #ffc6e6;background:#fff7fc;border-radius:14px;padding:14px;margin:14px 0}
.thread.locked{background:#ddd}
body.dark .thread{background:#1b1b1b}

.flex{display:flex;gap:10px;align-items:center}
.icon{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid #ffb8e6}

.openThread{color:#ff4fa8;font-weight:bold;cursor:pointer}
body.dark .openThread{color:#ff8cd1}

.meta{font-size:0.85rem;color:#666}
body.dark .meta{color:#ccc}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<button id="adminToggle" style="position:fixed;left:12px;top:12px">ç®¡ç†äººãƒ­ã‚°ã‚¤ãƒ³</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div>
<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³URL">
<button id="saveProfile">ä¿å­˜</button>
</div>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>

<hr>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script>
/* Firebase åˆæœŸåŒ– */
const firebaseConfig = {
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
};

/* ç®¡ç†äºº */
const isAdmin=()=>localStorage.getItem("usakira_admin")==="true";
adminToggle.onclick=()=>{
  if(isAdmin()){
    localStorage.removeItem("usakira_admin");
    alert("ç®¡ç†äººãƒ­ã‚°ã‚¢ã‚¦ãƒˆ");
  }else{
    const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw==="master"){
      localStorage.setItem("usakira_admin","true");
      alert("ç®¡ç†äººã«ãªã£ãŸãƒšã‚³ ğŸ‘‘");
    }
  }
};

/* ãƒ—ãƒ­ãƒ• */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";
nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;
saveProfile.onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬ä½œæˆ */
createThread.onclick=()=>{
  const title=threadTitle.value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");
  const key=db.ref("threads").push({
    title,
    body:threadBody.value,
    pass:threadPass.value||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  }).key;
  location.href="thread.html?id="+key;
};

/* â˜… ã‚¹ãƒ¬ä¸€è¦§ï¼ˆå¿…ãšå‡ºã‚‹ï¼‰ */
db.ref("threads").on("value", snap=>{
  const box=document.getElementById("threads");
  box.innerHTML="";
  const data=snap.val();

  if(!data){
    box.innerHTML="<p>ã¾ã ã‚¹ãƒ¬ãŒãªã„ãƒšã‚³ ğŸ°</p>";
    return;
  }

  Object.keys(data).forEach(id=>{
    const t=data[id];
    const div=document.createElement("div");
    div.className="thread"+(t.pass?" locked":"");

    div.innerHTML=`
      <div class="flex">
        <img class="icon" src="${t.ownerIcon}" onerror="this.src='${defaultIcon}'">
        <div>
          <div class="openThread">${t.title} ${t.pass?"ğŸ”’":""}</div>
          <div class="meta">by ${t.ownerName}</div>
        </div>
      </div>

      ${(userId===t.ownerId||isAdmin())?`
        <button class="lockBtn">ğŸ”’ éµå¤‰æ›´</button>
        <button class="delBtn">ğŸ—‘ å‰Šé™¤</button>
      `:""}
    `;

    div.querySelector(".openThread").onclick=()=>{
      if(t.pass){
        const pw=prompt("ã“ã®ã‚¹ãƒ¬ã¯éµä»˜ãã ã‚ˆğŸ°");
        if(pw!==t.pass) return alert("é•ã†ãƒšã‚³");
      }
      location.href="thread.html?id="+id;
    };

    div.querySelector(".lockBtn")?.onclick=()=>{
      const p=prompt(t.pass?"ç©ºã§è§£é™¤":"éµãƒ‘ã‚¹");
      db.ref("threads/"+id).update({pass:p||null});
    };

    div.querySelector(".delBtn")?.onclick=()=>{
      if(confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿ")){
        db.ref("threads/"+id).remove();
        db.ref("posts/"+id).remove();
      }
    };

    box.appendChild(div);
  });
});

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
adminBtn.onclick=()=>{
  if(!isAdmin()){
    const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
    if(pw!=="master") return;
    localStorage.setItem("usakira_admin","true");
  }
  location.href="report-admin.html";
};
</script>
</body>
</html>
