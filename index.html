<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family:"Hiragino Kaku Gothic ProN", sans-serif;
      background:#fff0f8;
      padding:20px;
      color:#222;
      transition:0.25s;
    }
    .dark { background:#121212; color:#eaeaea; }

    /* â–¼ ã‹ã‚ã„ã„ã‚¹ãƒ¬ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ â–¼ */
    .thread {
      border: 2px solid #ffc6e6;
      background: #fff7fc;
      border-radius: 14px;
      padding: 14px;
      margin: 14px 0;
      box-shadow: 0 2px 6px rgba(255, 150, 210, 0.25);
      transition: transform 0.15s, box-shadow 0.2s;
    }
    .thread:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(255, 150, 210, 0.32);
    }
    .thread h3 a {
      color: #ff4fa8;
      font-weight: bold;
      text-decoration: none;
      font-size: 1.15rem;
    }
    .thread h3 a:hover { text-decoration: underline; }
    .thread p { color: #444; margin: 6px 0; }
    body.dark .thread {
      background:#1b1b1b;
      border-color:#555;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
    body.dark .thread:hover {
      box-shadow:0 6px 12px rgba(0,0,0,0.5);
    }
    body.dark .thread h3 a { color:#ff8cd1; }

    button {
      padding:6px 10px; margin:4px; border-radius:6px;
      cursor:pointer;
      transition:0.15s;
    }
    button:hover { opacity:0.85; }
    body.dark button { background:#333; color:#eaeaea; border:1px solid #666; }

    input, textarea {
      padding:6px; margin:4px 0; width:100%;
      box-sizing:border-box;
      border-radius:6px;
      border:1px solid #ccc;
    }
    body.dark input, body.dark textarea {
      background:#222; color:#eaeaea; border:1px solid #555;
    }

    a { color:#d22; text-decoration:underline; }
  </style>
</head>
<body>

<button id="darkToggle" style="position:fixed; right:12px; top:12px;">ğŸŒ™</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div id="profileBox">
  <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
  <input id="nameInput" placeholder="åå‰" />
  <input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURL" />
  <button id="saveProfile">ä¿å­˜</button>
</div>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰" />
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>
<div id="paging"></div>

<hr>

<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain: "keijiban-7c651.firebaseapp.com",
  databaseURL: "https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId: "keijiban-7c651",
  storageBucket: "keijiban-7c651.firebasestorage.app",
  messagingSenderId: "342192640264",
  appId: "1:342192640264:web:a004a725b470741aaf1cbd",
  measurementId: "G-7E1BZ3BGBR"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
const savedDark=localStorage.getItem("usakira_dark")==="true";
if(savedDark) document.body.classList.add("dark");
darkToggle.textContent=savedDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const now=!(localStorage.getItem("usakira_dark")==="true");
  localStorage.setItem("usakira_dark",now);
  document.body.classList.toggle("dark");
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");

nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value);
  localStorage.setItem("usakira_icon",iconInput.value);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ */
document.getElementById("createThread").onclick=async()=>{
  const title=document.getElementById("threadTitle").value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");

  const body=document.getElementById("threadBody").value.trim();
  const pass=document.getElementById("threadPass").value.trim();

  const key=await push(ref(db,"threads"),{
    title,
    body,
    pass:pass||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  }).key;

  alert("ä½œæˆã—ãŸã‚ˆï¼");
  location.href=`thread.html?id=${key}`;
};

/* ã‚¹ãƒ¬ä¸€è¦§ */
const PER=20;
let threadArr=[];

onValue(ref(db,"threads"), snap=>{
  const data=snap.val()||{};
  threadArr=Object.entries(data).sort((a,b)=>(b[1].time||0)-(a[1].time||0));
  renderThreads(1);
});

/* ãƒšãƒ¼ã‚¸æç”» */
function renderThreads(page){
  const start=(page-1)*PER;
  const pick=threadArr.slice(start,start+PER);

  const box=document.getElementById("threads");
  box.innerHTML="";

  pick.forEach(([id,t])=>{
    const div=document.createElement("div");
    div.className="thread";

    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        <img src="${t.ownerIcon || defaultIcon}" 
             style="width:48px; height:48px; border-radius:50%; border:2px solid #ffb8e6; object-fit:cover;"
             onerror="this.src='${defaultIcon}'">
        <div>
          <h3 style="margin:0;">
            <a href="thread.html?id=${id}">${t.title || "ï¼ˆç„¡é¡Œï¼‰"}</a>
          </h3>
          <div style="font-size:0.9rem; color:#888;">
            by ${t.ownerName || defaultName} ${t.pass ? "ğŸ”’" : ""}
          </div>
        </div>
      </div>

      ${t.body ? `<p style="margin-top:8px;">${t.body}</p>` : ""}

      <p class="meta" style="font-size:0.85rem; color:#aa7;">
        ${new Date(t.time).toLocaleString()}
      </p>
    `;

    /* â–¼ ã‚¹ãƒ¬å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å³ç«¯ã«è¡¨ç¤º â–¼ */
    const btnWrapper = document.createElement("div");
    btnWrapper.style.display = "flex";
    btnWrapper.style.justifyContent = "flex-end"; // å³ç«¯ã«å¯„ã›ã‚‹
    btnWrapper.style.marginTop = "8px";

    const delBtn = document.createElement("button");
    delBtn.textContent = "ã‚¹ãƒ¬å‰Šé™¤";
    delBtn.onclick = async () => {
      const me = userId;

      if (me === t.ownerId) {
        if (!confirm("ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        await set(ref(db, `threads/${id}`), null);
        await set(ref(db, `posts/${id}`), null);
        alert("ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ãŸã‚ˆï¼");
        return;
      }

      const pw = prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
      if (pw === "master") {
        await set(ref(db, `threads/${id}`), null);
        await set(ref(db, `posts/${id}`), null);
        alert("ã‚¹ãƒ¬ã‚’å‰Šé™¤ã—ãŸã‚ˆï¼");
        return;
      }

      alert("å‰Šé™¤æ¨©é™ãŒãªã„ãƒšã‚³");
    };

    btnWrapper.appendChild(delBtn);
    div.appendChild(btnWrapper);
    /* â–² ã‚¹ãƒ¬å‰Šé™¤ã“ã“ã¾ã§ â–² */

    box.appendChild(div);
  });

  const pages=Math.max(1,Math.ceil(threadArr.length/PER));
  const pg=document.getElementById("paging");
  pg.innerHTML="";
  for(let i=1;i<=pages;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>renderThreads(i);
    pg.appendChild(b);
  }
}

/* ç®¡ç†ãƒšãƒ¼ã‚¸ */
document.getElementById("adminBtn").onclick=()=>{
  const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw==="master") location.href="report-admin.html";
  else alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†ãƒšã‚³");
};
</script>

</body>
</html>
