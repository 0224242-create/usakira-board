<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;color:#222;transition:.25s;
}
body.dark{background:#121212;color:#eee}

.thread{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
  transition:.2s;
}
.thread.locked{
  background:#ccc;
  border-color:#999;
}
.thread.highlight{
  transform:translateY(-3px);
  box-shadow:0 8px 16px rgba(255,150,210,.5);
}
body.dark .thread{background:#1b1b1b;border-color:#555}
body.dark .thread.locked{background:#555;border-color:#777}

.flex{display:flex;align-items:center;justify-content:space-between}
.thread h3 a{text-decoration:none;color:#ff4fa8;font-weight:bold}
body.dark .thread h3 a{color:#ff8cd1}
button{padding:6px 10px;border-radius:6px;cursor:pointer;margin:2px}
.sortBtn{margin-bottom:12px}
</style>
</head>
<body>

<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>
<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<div>
  <button class="sortBtn" id="sortNew">æ–°ã—ã„é †</button>
  <button class="sortBtn" id="sortReact">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¤šã„é †</button>
</div>

<div id="threads"></div>
<div id="paging"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("usakira_dark")==="true") document.body.classList.add("dark");
darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",document.body.classList.contains("dark"));
  darkToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸":"ğŸŒ™";
};

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ID */
const userId=localStorage.getItem("usakira_userId")||("user_"+Math.random().toString(36).slice(2));
if(!localStorage.getItem("usakira_userId")) localStorage.setItem("usakira_userId",userId);

/* ã‚¹ãƒ¬å–å¾—ã¨æç”» */
let threadArr=[]; 
let sortBy="new"; 
const PER=20;
const threadsEl=document.getElementById("threads");
const pagingEl=document.getElementById("paging");

async function loadThreads(){
  const snap=await get(ref(db,"threads"));
  const data=snap.val()||{};
  threadArr=[];

  for(const tid in data){
    const t=data[tid];

    const postsSnap=await get(ref(db,"posts/"+tid));
    const posts=postsSnap.val()||{};
    const commentCount=Object.keys(posts).length;

    let reactTotal=0;
    for(const pid in posts){
      const p=posts[pid];
      if(!p.reactions) continue;
      for(const em in p.reactions){
        reactTotal += Object.keys(p.reactions[em]).length;
      }
    }

    threadArr.push({...t,id:tid,commentCount,reactTotal});
  }

  renderThreads();
}

function renderThreads(page=1){
  if(sortBy==="new") threadArr.sort((a,b)=>(b.time||0)-(a.time||0));
  else threadArr.sort((a,b)=>(b.reactTotal||0)-(a.reactTotal||0));

  const start=(page-1)*PER;
  const pick=threadArr.slice(start,start+PER);
  threadsEl.innerHTML="";

  pick.forEach(t=>{
    const div=document.createElement("div");
    div.className="thread";
    if(t.pass) div.classList.add("locked");
    if(t.reactTotal>=5) div.classList.add("highlight"); // 5ä»¥ä¸Šãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯å¼·èª¿

    div.innerHTML=`
      <div class="flex">
        <h3><a href="thread.html?id=${t.id}">${t.title||"(ç„¡é¡Œ)"}</a></h3>
        <span>ã‚³ãƒ¡ãƒ³ãƒˆ:${t.commentCount} / ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:${t.reactTotal}</span>
      </div>
      <div style="font-size:0.8rem;color:#888">by ${t.ownerName||"åã‚‚ãªãå…"} ${t.pass?"ğŸ”’":""}</div>
    `;
    threadsEl.appendChild(div);
  });

  const pages=Math.max(1,Math.ceil(threadArr.length/PER));
  pagingEl.innerHTML="";
  for(let i=1;i<=pages;i++){
    const b=document.createElement("button");
    b.textContent=i;
    b.onclick=()=>renderThreads(i);
    pagingEl.appendChild(b);
  }
}

document.getElementById("sortNew").onclick=()=>{sortBy="new"; renderThreads();};
document.getElementById("sortReact").onclick=()=>{sortBy="react"; renderThreads();};

loadThreads();
</script>
</body>
</html>
