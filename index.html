<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  font-family:"Hiragino Kaku Gothic ProN",sans-serif;
  background:#fff0f8;
  padding:20px;
  color:#222;
  transition:.25s;
}
body.dark{background:#121212;color:#eaeaea}

/* ===== ãƒœã‚¿ãƒ³ ===== */
button{
  padding:6px 10px;
  margin:4px;
  border-radius:6px;
  cursor:pointer;
}
body.dark button{
  background:#333;color:#eee;border:1px solid #666;
}

/* ===== å…¥åŠ› ===== */
input,textarea{
  width:100%;
  padding:6px;
  margin:4px 0;
  border-radius:6px;
  border:1px solid #ccc;
}
body.dark input,body.dark textarea{
  background:#222;color:#eee;border:1px solid #555;
}

/* ===== ã‚¹ãƒ¬ã‚«ãƒ¼ãƒ‰ ===== */
.thread{
  border:2px solid #ffc6e6;
  background:#fff7fc;
  border-radius:14px;
  padding:14px;
  margin:14px 0;
  box-shadow:0 2px 6px rgba(255,150,210,.25);
  transition:.2s;
}
.thread:hover{
  transform:translateY(-3px);
  box-shadow:0 6px 12px rgba(255,150,210,.35);
}
body.dark .thread{
  background:#1b1b1b;
  border-color:#555;
}

/* ===== éµã‚¹ãƒ¬ ===== */
.thread.locked::after{
  content:"ğŸ”’";
  position:absolute;
  right:12px;top:10px;
  opacity:.7;
}

/* ===== ã‚¢ã‚¤ã‚³ãƒ³ ===== */
.icon{
  width:48px;height:48px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #ffb8e6;
}
body.dark .icon{
  border-color:#ff8cd1;
  box-shadow:
    0 0 6px rgba(255,140,209,.6),
    0 0 16px rgba(255,140,209,.35);
}

a{color:#ff4fa8;text-decoration:none}
a:hover{text-decoration:underline}
</style>
</head>

<body>

<!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ -->
<button id="darkToggle" style="position:fixed;right:12px;top:12px">ğŸŒ™</button>

<h1>ğŸ°ã†ã•â˜…ã‚­ãƒ©æ²ç¤ºæ¿âœ¨ï¸</h1>

<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
<h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
<input id="nameInput" placeholder="åå‰">
<input id="iconInput" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒURL">
<button id="saveProfile">ä¿å­˜</button>

<hr>

<!-- ã‚¹ãƒ¬ä½œæˆ -->
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</h2>
<input id="threadTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
<textarea id="threadBody" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
<input id="threadPass" placeholder="éµã‚¹ãƒ¬ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰">
<button id="createThread">ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œã‚‹</button>

<hr>

<!-- ã‚¹ãƒ¬ä¸€è¦§ -->
<h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
<div id="threads"></div>
<div id="paging"></div>

<hr>
<button id="adminBtn">ç®¡ç†ãƒšãƒ¼ã‚¸</button>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from
  "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

/* Firebase */
const firebaseConfig={
  apiKey:"AIzaSyDwp6403Wctjo-2vjR373CjfJXDDGUp7do",
  authDomain:"keijiban-7c651.firebaseapp.com",
  databaseURL:"https://keijiban-7c651-default-rtdb.firebaseio.com",
  projectId:"keijiban-7c651",
  storageBucket:"keijiban-7c651.firebasestorage.app",
  messagingSenderId:"342192640264",
  appId:"1:342192640264:web:a004a725b470741aaf1cbd"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* ===== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åŒæœŸ ===== */
const darkToggle=document.getElementById("darkToggle");
const isDark=localStorage.getItem("usakira_dark")==="true";
if(isDark) document.body.classList.add("dark");
darkToggle.textContent=isDark?"â˜€ï¸":"ğŸŒ™";
darkToggle.onclick=()=>{
  const now=!document.body.classList.contains("dark");
  document.body.classList.toggle("dark");
  localStorage.setItem("usakira_dark",now);
  darkToggle.textContent=now?"â˜€ï¸":"ğŸŒ™";
};

/* ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ===== */
const defaultName="åã‚‚ãªãå…";
const defaultIcon="usagi.png.jpeg";

const nameInput=document.getElementById("nameInput");
const iconInput=document.getElementById("iconInput");

nameInput.value=localStorage.getItem("usakira_name")||defaultName;
iconInput.value=localStorage.getItem("usakira_icon")||defaultIcon;

document.getElementById("saveProfile").onclick=()=>{
  localStorage.setItem("usakira_name",nameInput.value||defaultName);
  localStorage.setItem("usakira_icon",iconInput.value||defaultIcon);
  alert("ä¿å­˜ã—ãŸã‚ˆï¼");
};

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ===== */
const userId=localStorage.getItem("usakira_userId")
 ||("user_"+Math.random().toString(36).slice(2));
localStorage.setItem("usakira_userId",userId);

/* ===== ã‚¹ãƒ¬ä½œæˆ ===== */
document.getElementById("createThread").onclick=async()=>{
  const title=threadTitle.value.trim();
  if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›¸ã„ã¦ã­");

  const key=(await push(ref(db,"threads"),{
    title,
    body:threadBody.value.trim(),
    pass:threadPass.value.trim()||null,
    ownerId:userId,
    ownerName:nameInput.value||defaultName,
    ownerIcon:iconInput.value||defaultIcon,
    time:Date.now()
  })).key;

  location.href="thread.html?id="+key;
};

/* ===== ã‚¹ãƒ¬ä¸€è¦§ ===== */
const PER=20;
let threadArr=[];

onValue(ref(db,"threads"),snap=>{
  const d=snap.val()||{};
  threadArr=Object.entries(d).sort((a,b)=>(b[1].time||0)-(a[1].time||0));
  render(1);
});

function render(page){
  const box=document.getElementById("threads");
  box.innerHTML="";
  const start=(page-1)*PER;

  threadArr.slice(start,start+PER).forEach(([id,t])=>{
    const div=document.createElement("div");
    div.className="thread";
    if(t.pass) div.classList.add("locked");
    div.style.position="relative";

    div.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <img class="icon"
          src="${t.ownerIcon||defaultIcon}"
          onerror="this.src='${defaultIcon}'">
        <div>
          <h3><a href="thread.html?id=${id}">${t.title}</a></h3>
          <div style="font-size:.9rem;color:#888">
            by ${t.ownerName||defaultName}
          </div>
        </div>
      </div>
    `;
    box.appendChild(div);
  });
}

/* ===== ç®¡ç†ãƒšãƒ¼ã‚¸ ===== */
adminBtn.onclick=()=>{
  const pw=prompt("ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰");
  if(pw==="master") location.href="report-admin.html";
  else alert("é•ã„ã¾ã™");
};
</script>

</body>
</html>
